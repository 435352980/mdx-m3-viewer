// Copyright (c) 2013 Chananya Freiman (aka GhostWolf)
(function(){"use strict";(function(){function ta(c){this.buffer=c;this.index=0;this.dataview=new DataView(this.buffer);this.size=c.byteLength}function x(c,f){var g=[];c.size-c.index<f&&(f=c.size-c.index);for(var i=0;i<f;i++)g[i]=String.fromCharCode(""+c.dataview.getUint8(c.index+i));c.index+=f;return g.join("").replace(/\0/g,"")}function ua(c,f){var g=[];c.size-c.index<f&&(f=c.size-c.index);for(var i=0;i<f;i++)g[i]=String.fromCharCode(""+c.dataview.getUint8(c.index+i));return g.join("").replace(/\0/g,"")}function T(c,f){var g=
c.dataview["get"+f](c.index,!0);c.index+=la[f];return g}function ca(c,f,g){for(var i=[],q=0;q<f;q++)i[q]=T(c,g);return i}function ma(c,f,g,i){for(var q=[],p=0;p<f;p++)q[p]=ca(c,g,i);return q}function da(c){return T(c,"Int16")}function y(c){return T(c,"Int32")}function aa(c){return T(c,"Uint8")}function t(c){return T(c,"Uint16")}function c(c){return T(c,"Uint32")}function g(c){return T(c,"Float32")}function ea(c,f){return ca(c,f,"Uint8")}function X(c,f){return ca(c,f,"Uint32")}function Z(c,f){return ca(c,
f,"Float32")}function ja(c){return Z(c,2)}function s(c){return Z(c,3)}function ka(c){return Z(c,4)}function na(c){return Z(c,16)}function va(){var c=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var f=0;f<c.length;f++){var g=c[f]+"Hidden";if(g in document)return g}return null}function Ca(c){var f=va();f&&document.addEventListener(f.substr(0,f.length-6)+"visibilitychange",c,!1)}function fa(c,f,g,i,q){var p=new XMLHttpRequest;g&&p.addEventListener("load",g,!1);i&&p.addEventListener("error",
i,!1);q&&p.addEventListener("progress",q,!1);p.open("GET",c,!0);f&&(p.responseType="arraybuffer");p.send()}function Da(c,f,g){"mousewheel"===f&&c.addEventListener("DOMMouseScroll",g,!1);c.addEventListener(f,g,!1)}function Ea(c){function g(a,b){var d=String.hashCode(a);Y[d]||(Y[d]=new B(a,b));return Y[d]}function B(b,d){this.source=b;this.type=d;var h=a.createShader(d);this.id=h;a.shaderSource(h,b);a.compileShader(h);a.getShaderParameter(h,a.COMPILE_STATUS)?this.ready=!0:(console.warn(a.getShaderInfoLog(h)),
console.log(b))}function i(b,d){this.vertexUnit=b;this.fragmentUnit=d;var h=a.createProgram();this.id=h;a.attachShader(h,b.id);a.attachShader(h,d.id);a.linkProgram(h);a.getProgramParameter(h,a.LINK_STATUS)?(this.uniforms=this.getParameters("Uniform","UNIFORMS"),this.attribs=this.getParameters("Attrib","ATTRIBUTES"),this.ready=!0):console.warn(a.getProgramInfoLog(h))}function q(a){if(w&&(a=w.getParameter(a)))return a[0]}function p(b,d,h){var e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e);a.texImage2D(a.TEXTURE_2D,
0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,d?a.CLAMP_TO_EDGE:a.REPEAT);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,h?a.CLAMP_TO_EDGE:a.REPEAT);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR);a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null);return e}function s(a,b,d,h,e,c){this.name=a;if("string"===typeof b){this.image=new Image;var k=this;this.image.onload=function(){k.id=
p(this,d,h);k.ready=!0;t[a]=1;"function"===typeof e&&e(a)};this.image.onerror=function(){console.log("Failed to load "+a);"function"===typeof c&&c(a)};this.image.src=b}else this.image=b,this.id=p(b,d,h),this.ready=!0,t[a]=1,"function"===typeof e&&e(a)}function b(b,d,h,e,c){console.log("Processing "+b);var c=c.target.response,k=new Int32Array(c,0,31);if(542327876===k[0]){console.log("It is a valid DDS file");var j=k[2],f=k[3],g=k[4],H=k[7],i=k[21],k=k[1]+4,r,m;827611204===i?(r=8,m=D.COMPRESSED_RGBA_S3TC_DXT1_EXT,
console.log("DXT1")):861165636===i?(r=16,m=D.COMPRESSED_RGBA_S3TC_DXT3_EXT,console.log("DXT3")):894720068===i&&(r=16,m=D.COMPRESSED_RGBA_S3TC_DXT5_EXT,console.log("DXT5"));if(m){j=Math.max(1,j&131072?H:0);this.id=a.createTexture();a.bindTexture(a.TEXTURE_2D,this.id);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,d?a.CLAMP_TO_EDGE:a.REPEAT);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,h?a.CLAMP_TO_EDGE:a.REPEAT);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,
a.TEXTURE_MIN_FILTER,a.LINEAR);for(d=0;d<j;d++)2<=g&&2<=f&&(h=Math.max(4,g)/4*Math.max(4,f)/4*r,H=new Uint8Array(c,k,h),a.compressedTexImage2D(a.TEXTURE_2D,d,m,g,f,0,H),k+=h,g*=0.5,f*=0.5);a.bindTexture(a.TEXTURE_2D,null);console.log("Loaded");this.ready=!0;t[b]=1;"function"===typeof e&&e(b)}else console.warn(b+" is using a compression type that is not supported (supported types: DXT1, DXT3, DXT5)"),"function"===typeof onerror&&onerror(b)}else console.warn(b+" is not a valid DDS file"),"function"===
typeof onerror&&onerror(b)}function d(a,b,d){console.warn("Failed to load "+a);"function"===typeof b&&b(a,d)}function h(a,h,e,c,k,j){this.name=a;console.log("Loading "+a);D?fa(h,!0,b.bind(this,a,e,c,k),d.bind(this,a,j)):(console.warn("Didn't load "+a+" because your WebGL context does not support compressed texture formats"),"function"===typeof j&&j(a))}function k(a,b,d,e,c,k){if(o[a])"function"===typeof c&&c(a);else{var j=V.exec(a)[1]||V.exec(b)[1];o[a]=j&&"dds"===j.toLowerCase()?new h(a,b,d,e,c,
k):new s(a,b,d,e,c,k)}return o[a]}function j(b,d,h,e,c,k){k=k||1;this.buffer=a.createBuffer();this.data=new Float32Array([b-e,d-c,h,0,1*k,b+e,d-c,h,1*k,1*k,b-e,d+c,h,0,0,b+e,d+c,h,1*k,0]);a.bindBuffer(a.ARRAY_BUFFER,this.buffer);a.bufferData(a.ARRAY_BUFFER,this.data,a.STATIC_DRAW)}function H(b,d,h,e,c,k){var j=[],f=[],g,H;for(g=0;g<=e;g++){H=g*Math.PI/e;var i=Math.sin(H),r=Math.cos(H);for(H=0;H<=c;H++){var m=2*H*Math.PI/c,p=Math.sin(m),m=Math.cos(m)*i,q=r,p=p*i,$=1-H/c,M=g/e;j.push(b+m*k);j.push(d+
q*k);j.push(h+p*k);j.push($);j.push(M)}}for(g=0;g<e;g++)for(H=0;H<c;H++)b=g*(c+1)+H,d=b+c+1,f.push(b),f.push(d),f.push(b+1),f.push(d),f.push(d+1),f.push(b+1);this.vertexArray=new Float32Array(j);this.indexArray=new Uint16Array(f);this.vertexBuffer=a.createBuffer();this.indexBuffer=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer);a.bufferData(a.ARRAY_BUFFER,this.vertexArray,a.STATIC_DRAW);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.indexArray,
a.STATIC_DRAW)}function e(b,d,h,e,c,k){this.buffer=a.createBuffer();this.data=new Float32Array([b,c,h,b,c,k,b,c,k,e,c,k,e,c,k,e,c,h,e,c,h,b,c,h,b,d,h,b,d,k,b,d,k,e,d,k,e,d,k,e,d,h,e,d,h,b,d,h,b,d,k,b,c,k,b,c,h,b,d,h,e,d,k,e,c,k,e,c,h,e,d,h]);a.bindBuffer(a.ARRAY_BUFFER,this.buffer);a.bufferData(a.ARRAY_BUFFER,this.data,a.STATIC_DRAW)}for(var a,$=["webgl","experimental-webgl","webkit-3d","moz-webgl"],ha=0,M=$.length;ha<M;++ha){try{a=c.getContext($[ha],{antialias:!0,alpha:!1})}catch(x){}if(a)break}if(a){var r=
[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],I=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],ba=[],y=[],o={},t={},Y={},O={},P={},w,E="",F=[],u={};u[a.FLOAT]="1f";u[a.FLOAT_VEC2]="2fv";u[a.FLOAT_VEC3]="3fv";u[a.FLOAT_VEC4]="4fv";u[a.INT]="1i";u[a.INT_VEC2]="2iv";u[a.INT_VEC3]="3iv";u[a.INT_VEC4]="4iv";u[a.BOOL]="1f";u[a.BOOL_VEC2]="2fv";u[a.BOOL_VEC3]="3fv";u[a.BOOL_VEC4]="4fv";u[a.FLOAT_MAT2]="Matrix2fv";u[a.FLOAT_MAT3]="Matrix3fv";u[a.FLOAT_MAT4]="Matrix4fv";u[a.SAMPLER_2D]="1i";u[a.SAMPLER_CUBE]="1i";var $=a.getExtension("OES_texture_float"),
D=a.getExtension("WEBGL_compressed_texture_s3tc");a.getExtension("WEBGL_depth_texture");a.getExtension("WEBGL_draw_buffers");a.viewport(0,0,c.width,c.height);a.depthFunc(a.LEQUAL);a.enable(a.DEPTH_TEST);a.enable(a.CULL_FACE);i.prototype={getParameters:function(b,d){for(var h=this.id,e={},c=0,k=a.getProgramParameter(h,a["ACTIVE_"+d]);c<k;c++){var j=a["getActive"+b](h,c),f=a["get"+b+"Location"](h,j.name);e[j.name]=[f,j.type]}return e},setParameter:function(b,d){var h=this.uniforms[b],e;if(h)if(e=h[0],
h=u[h[1]],"M"===h[0])a["uniform"+h](e,!1,d);else a["uniform"+h](e,d);else if(e=a.getUniformLocation(this.id,b))if(h=this.uniforms[b.match(/([\w]+)/)[1]+"[0]"])this.uniforms[b]=[e,h[1]],this.setParameter(b,d)},getParameter:function(a){return this.uniforms[a]||this.attribs[a]},bind:function(){if(this.ready){a.useProgram(this.id);for(var b=this.attribs,d=Object.keys(b),h=0,e=d.length;h<e;h++)a.enableVertexAttribArray(b[d[h]][0])}},unbind:function(){for(var b=this.attribs,d=Object.keys(b),h=0,e=d.length;h<
e;h++)a.disableVertexAttribArray(b[d[h]][0]);a.useProgram(null)}};s.prototype={bind:function(b){this.ready&&(a.activeTexture(a["TEXTURE"+(b||0)]),a.bindTexture(a.TEXTURE_2D,this.id))},unbind:function(){a.bindTexture(a.TEXTURE_2D,0)}};h.prototype=s.prototype;var V=/(?:\.([^.]+))?$/;j.prototype={render:function(){w&&(a.bindBuffer(a.ARRAY_BUFFER,this.buffer),a.vertexAttribPointer(q("a_position"),3,a.FLOAT,!1,20,0),a.vertexAttribPointer(q("a_uv"),2,a.FLOAT,!1,20,12),a.drawArrays(a.TRIANGLE_STRIP,0,4))}};
H.prototype={render:function(){w&&(a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.vertexAttribPointer(q("a_position"),3,a.FLOAT,!1,20,0),a.vertexAttribPointer(q("a_uv"),2,a.FLOAT,!1,20,12),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer),a.drawElements(a.TRIANGLES,this.indexArray.length,a.UNSIGNED_SHORT,0))},renderLines:function(){a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer);a.vertexAttribPointer(q("a_position"),3,a.FLOAT,!1,20,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer);a.drawElements(a.LINES,
this.indexArray.length,a.UNSIGNED_SHORT,0)}};e.prototype={renderLines:function(){w&&(a.bindBuffer(a.ARRAY_BUFFER,this.buffer),a.vertexAttribPointer(q("a_position"),3,a.FLOAT,!1,12,0),a.drawArrays(a.LINES,0,24))}};k("Empty.png","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAIAAAD91JpzAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAAMSURBVBhXY0ACDAwAAA4AAXqxuTAAAAAASUVORK5CYII=");return{viewSize:function(b,d){a.viewport(0,0,b,d)},setPerspective:function(a,b,d,h){f.mat4.makePerspective(r,
a,b,d,h)},loadIdentity:function(){I=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},translate:function(a,b,d){f.mat4.translate(I,a,b,d)},rotate:function(a,b,d,h){f.mat4.rotate(I,a,b,d,h)},scale:function(a,b,d){f.mat4.scale(I,a,b,d)},lookAt:function(a,b,d){f.mat4.makeLookAt(I,a,b,d)},multMat:function(a){f.mat4.multMat(I,a,I)},pushMatrix:function(){y.push(Object.copy(I))},popMatrix:function(){I=y.pop()},newShader:function(b,d,h,e){if(!O[b]){for(var e=e||[],c=0;c<e.length;c++)e[c]="#define "+e[c];e=e.join("\n")+
"\n";d=g(e+d,a.VERTEX_SHADER);h=g(e+h,a.FRAGMENT_SHADER);d.ready&&h.ready&&(O[b]=new i(d,h),P[b]={})}return!O[b]||!O[b].ready?!1:O[b]},bindShader:function(b){var a=O[b];if(a&&(!w||w.id!==a.id))w&&w.unbind(),E=b,w=a,w.bind()},setParameter:function(b,a){if(w){var d=P[E][b],h=!1;a instanceof Array?Array.equals(d,a)||(h=!0):d!==a&&(h=!0);h&&(P[E][b]=a,w.setParameter(b,a))}},getParameter:q,bindWorldMatrix:function(b){w&&(f.mat4.multMat(r,I,ba),w.setParameter(b,ba))},getWorldMatrix:function(){f.mat4.multMat(r,
I,ba);return ba},bindProjectionMatrix:function(b){w&&w.setParameter(b,r)},getProjectionMatrix:function(){return r},bindViewMatrix:function(b){w&&w.setParameter(b,I)},getViewMatrix:function(){return I},newTexture:k,bindTexture:function(b,a){var d=o[b];if(!d||!d.ready)d=o["Empty.png"];a=a||0;if(!F[a]||F[a].name!==b)F[a]=d,d.bind(a)},textureReady:function(b){return 1===t[b]},newRectangle:function(b,a,d,h,e,c){return new j(b,a,d,h,e,c)},newSphere:function(b,a,d,h,e,c){return new H(b,a,d,h,e,c)},newCube:function(b,
a,d,h,c,k){return new e(b,a,d,h,c,k)},gl:a,hasFloatTexture:$}}console.error("Could not create a WebGL context")}var f=function(){function c(b){return 0===b?0:0>b?-1:1}var g=Math.PI/180,s=180/Math.PI,i={setFromValues:function(b,d,h,c){b[0]=d;b[1]=h;b[2]=c},setFromArray:function(b,d){b[0]=d[0];b[1]=d[1];b[2]=d[2]},add:function(b,d,h){h[0]=b[0]+d[0];h[1]=b[1]+d[1];h[2]=b[2]+d[2];return h},subtract:function(b,d,h){h[0]=b[0]-d[0];h[1]=b[1]-d[1];h[2]=b[2]-d[2];return h},negate:function(b,d){d[0]=-b[0];
d[1]=-b[1];d[2]=-b[2];return d},scale:function(b,d,h){h[0]=b[0]*d;h[1]=b[1]*d;h[2]=b[2]*d;return h},magnitudeSquared:function(b){var d=b[0],h=b[1],b=b[2];return d*d+h*h+b*b},magnitude:function(b){var d=b[0],h=b[1],b=b[2];return Math.sqrt(d*d+h*h+b*b)},normalize:function(b,d){var h=1/this.magnitude(b);d[0]=b[0]*h;d[1]=b[1]*h;d[2]=b[2]*h;return d},dot:function(b,d){return b[0]*d[0]+b[1]*d[1]+b[2]*d[2]},cross:function(b,d,h){var c=b[0],j=b[1],b=b[2],f=d[0],e=d[1],d=d[2];h[0]=j*d-b*e;h[1]=b*f-c*d;h[2]=
c*e-j*f;return h},lerp:function(b,d,h,c){var j=b[0],f=b[1],b=b[2];c[0]=(d[0]-j)*h+j;c[1]=(d[1]-f)*h+f;c[2]=(d[2]-b)*h+b;return c},hermite:function(b,d,h,c,j,f){var e=j*j,a=e*(j-2)+j,g=e*(j-1),i=e*(3-2*j),b=this.scale(b,e*(2*j-3)+1,[]),d=this.scale(d,a,[]),h=this.scale(h,g,[]),c=this.scale(c,i,[]);f[0]=b[0]+d[0]+h[0]+c[0];f[1]=b[1]+d[1]+h[1]+c[1];f[2]=b[2]+d[2]+h[2]+c[2];return f},bezier:function(b,d,h,c,j,f){var e=1-j,a=j*j,g=e*e,i=3*j*g,m=3*a*e,j=a*j,b=this.scale(b,g*e,[]),d=this.scale(d,i,[]),h=
this.scale(h,m,[]),c=this.scale(c,j,[]);f[0]=b[0]+d[0]+h[0]+c[0];f[1]=b[1]+d[1]+h[1]+c[1];f[2]=b[2]+d[2]+h[2]+c[2];return f},equals:function(b,d){return b.length===d.length&&b[0]===d[0]&&b[1]===d[1]&&b[2]===d[2]}},q={setFromValues:function(b,d,h,c,j){b[0]=d;b[1]=h;b[2]=c;b[3]=j},setFromArray:function(b,d){b[0]=d[0];b[1]=d[1];b[2]=d[2];b[3]=d[3]},add:function(b,d,h){h[0]=b[0]+d[0];h[1]=b[1]+d[1];h[2]=b[2]+d[2];h[3]=b[3]+d[3];return h},subtract:function(b,d,h){h[0]=b[0]-d[0];h[1]=b[1]-d[1];h[2]=b[2]-
d[2];h[3]=b[3]-d[3];return h},negate:function(b,d){d[0]=-b[0];d[1]=-b[1];d[2]=-b[2];d[3]=-b[3];return d},scale:function(b,d,h){h[0]=b[0]*d;h[1]=b[1]*d;h[2]=b[2]*d;h[3]=b[3]*d;return h},magnitudeSquared:function(b){var d=b[0],h=b[1],c=b[2],b=b[3];return d*d+h*h+c*c+b*b},magnitude:function(b){var d=b[0],h=b[1],c=b[2],b=b[3];return Math.sqrt(d*d+h*h+c*c+b*b)},normalize:function(b,d){var h=1/this.magnitude(b);d[0]=b[0]*h;d[1]=b[1]*h;d[2]=b[2]*h;d[3]=b[3]*h;return d},dot:function(b,d){return b[0]*d[0]+
b[1]*d[1]+b[2]*d[2]+b[3]*d[3]},lerp:function(b,d,h,c){var j=b[0],f=b[1],e=b[2],b=b[3];c[0]=(d[0]-j)*h+j;c[1]=(d[1]-f)*h+f;c[2]=(d[2]-e)*h+e;c[3]=(d[3]-b)*h+b;return c},equals:function(b,d){return b.length===d.length&&b[0]===d[0]&&b[1]===d[1]&&b[2]===d[2]&&b[3]===d[3]}},p={create:q.create,createFromArray:q.createFromArray,createFromValues:q.createFromValues,clone:q.clone,setFromValues:q.setFromValues,setFromArray:q.setFromArray,add:q.add,negate:q.negate,scale:q.scale,magnitudeSquared:q.magnitudeSquared,
magnitude:q.magnitude,normalize:q.normalize,dot:q.dot,nlerp:q.lerp,fromAxisAngle:function(b,d,h){var c=[],j=d*g/2,d=Math.cos(j),j=Math.sin(j);i.normalize(b,c);this.setFromValues(h,c[0]*j,c[1]*j,c[2]*j,d);return h},toAxisAngle:function(b,d){var h=Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]);d[0]=b[0]/h;d[1]=b[1]/h;d[2]=b[2]/h;d[3]=2*Math.acos(b[3]);return d},fromEulerAngles:function(b,d,h,c){var j=b*g/2,f=d*g/2,e=h*g/2,h=Math.sin(j),d=Math.sin(f),b=Math.sin(e),j=Math.cos(j),f=Math.cos(f),e=Math.cos(e);
this.setFromValues(c,b*j*f-e*h*d,e*h*f+b*j*d,e*j*d-b*h*f,e*j*f+b*h*d);this.normalize(c,c);return c},fromAngles:function(b,d,h,c){return this.fromEulerAngles(d,h,b,c)},conjugate:function(b,d){d[0]=-b[0];d[1]=-b[1];d[2]=-b[2];d[3]=b[3];return d},concat:function(b,d,h){var c=b[0],f=b[1],g=b[2],b=b[3],e=d[0],a=d[1],i=d[2],d=d[3];h[0]=b*e+c*d+f*i-g*a;h[1]=b*a-c*i+f*d+g*e;h[2]=b*i+c*a-f*e+g*d;h[3]=b*d-c*e-f*a-g*i},fromRotationMatrix4:function(b,d){var h=b[0],c=b[5],j=b[10],g=Math.sqrt(Math.max(0,1-h+c-
j))/2,e=Math.sqrt(Math.max(0,1-h-c+j))/2,a=Math.sqrt(Math.max(0,1+h+c+j))/2;d[0]=Math.sqrt(Math.max(0,1+h-c-j))/2;d[0]=f.copysign(g,b[0]-b[6]);d[1]=f.copysign(e,b[2]-b[8]);d[2]=f.copysign(a,b[4]-b[1]);return d},toRotationMatrix4:function(b,d){var h=b[0],c=b[1],f=b[2],g=b[3],e=2*h,a=2*c,i=2*f,m=e*g,p=a*g,g=i*g,e=e*h,q=a*h,h=i*h,a=a*c,c=i*c,f=i*f;d[0]=1-(a+f);d[1]=q+g;d[2]=h-p;d[3]=0;d[4]=q-g;d[5]=1-(e+f);d[6]=c+m;d[7]=0;d[8]=h+p;d[9]=c-m;d[10]=1-(e+a);d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return d},
multVec3:function(b,d,h){var c=[];i.normalize(d,c);c[3]=0;var f=[];p.conjugate(b,f);p.concat(c,f,c);p.concat(b,c,c);b=i.magnitude(d);i.setFromValues(h,c[0],c[1],c[2]);i.scale(h,b,h);return h},slerp:function(b,d,c,f){if(0>c)return this.setFromArray(f,b),f;if(1<c)return this.setFromArray(f,d),f;var j=this.dot(b,d);if(1<j||-1>j)return this.setFromArray(f,d),f;var g=1;0>j&&(g=-1,j=-j);var e=Math.acos(j);if(1.0E-6>=e)return this.setFromArray(f,d),f;var a=1/Math.sin(e),j=Math.sin((1-c)*e)*a,c=g*Math.sin(c*
e)*a;f[0]=b[0]*j+d[0]*c;f[1]=b[1]*j+d[1]*c;f[2]=b[2]*j+d[2]*c;f[3]=b[3]*j+d[3]*c;return f},sqlerp:function(b,d,c,f,j,g){var e=[],a=[];this.slerp(b,f,j,e);this.slerp(d,c,j,a);this.slerp(e,a,2*j*(1-j),g);return g}},t=function(){return{scalar:function(b,d,c,g,j,i){switch(i){case 0:return b;case 1:return f.lerp(b,g,j);case 2:return f.hermite(b,d,c,g,j);case 3:return f.bezier(b,d,c,g,j)}},vector:function(b,d,c,g,j,i){switch(i){case 0:return b;case 1:return f.vec3.lerp(b,g,j,[]);case 2:return f.vec3.hermite(b,
d,c,g,j,[]);case 3:return f.vec3.bezier(b,d,c,g,j,[])}},quaternion:function(b,d,c,g,j,i){switch(i){case 0:return b;case 1:return f.quaternion.slerp(b,g,j,[]);case 2:case 3:return f.quaternion.sqlerp(b,d,c,g,j,[])}}}}();return{EPSILON:1.0E-6,random:function(b,d){return b+Math.random()*(d-b)},clamp:function(b,d,c){return Math.min(Math.max(b,d),c)},lerp:function(b,d,c){return b+c*(d-b)},hermite:function(b,d,c,f,g){var i=g*g;return b*(i*(2*g-3)+1)+d*(i*(g-2)+g)+c*i*(g-1)+f*i*(3-2*g)},bezier:function(b,
d,c,f,g){var i=1-g,e=g*g,a=i*i;return b*a*i+d*3*g*a+c*3*e*i+f*e*g},toRad:function(b){return b*g},toDeg:function(b){return b*s},sign:c,copysign:function(b,d){var h=c(b),f=c(d);return 0===f?0:h!==f?-b:b},powerOfTwo:function(b){b--;b|=b>>1;b|=b>>2;b|=b>>4;b|=b>>8;b|=b>>16;b++;return b},vec3:i,vec4:q,quaternion:p,mat4:{create:function(){return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},createIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},createFromArray:function(b){var d=this.create();this.setFromArray(d,
b);return d},createFromValues:function(b,d,c,f,g,i,e,a,m,p,q,s,r,I,B,t){var o=this.create();this.setFromValues(o,b,d,c,f,g,i,e,a,m,p,q,s,r,I,B,t);return o},setFromValues:function(b,d,c,f,g,i,e,a,m,p,q,s,r,I,B,t,o){b[0]=d;b[1]=c;b[2]=f;b[3]=g;b[4]=i;b[5]=e;b[6]=a;b[7]=m;b[8]=p;b[9]=q;b[10]=s;b[11]=r;b[12]=I;b[13]=B;b[14]=t;b[15]=o},setFromArray:function(b,d){b[0]=d[0];b[1]=d[1];b[2]=d[2];b[3]=d[3];b[4]=d[4];b[5]=d[5];b[6]=d[6];b[7]=d[7];b[8]=d[8];b[9]=d[9];b[10]=d[10];b[11]=d[11];b[12]=d[12];b[13]=
d[13];b[14]=d[14];b[15]=d[15]},setColumnValues:function(b,d,c,f,g,i){d*=4;b[d]=c;b[d+1]=f;b[d+2]=g;b[d+3]=i},setColumn:function(b,d,c){d*=4;b[d]=c[0];b[d+1]=c[1];b[d+2]=c[2];b[d+3]=c[3]},setRowValues:function(b,d,c,f,g,i){b[d]=c;b[d+4]=f;b[d+8]=g;b[d+12]=i},setRow:function(b,d,c){b[d]=c[0];b[d+4]=c[1];b[d+8]=c[2];b[d+12]=c[3]},setDiagonalValues:function(b,d,c,f,g){b[0]=d;b[5]=c;b[10]=f;b[15]=g},getColumn:function(b,d,c){d*=4;c[0]=b[d];c[1]=b[d+1];c[2]=b[d+2];c[3]=b[d+3]},getRow:function(b,d,c){c[0]=
b[d];c[1]=b[d+4];c[2]=b[d+8];c[3]=b[d+12]},getElement:function(b,d,c){return b[d+4*c]},setElement:function(b,d,c,f){b[d+4*c]=f},multMat:function(b,d,c){var f=b[0],g=b[1],i=b[2],e=b[3],a=b[4],m=b[5],p=b[6],q=b[7],s=b[8],r=b[9],B=b[10],t=b[11],x=b[12],o=b[13],y=b[14],b=b[15],Q=d[0],O=d[1],P=d[2],w=d[3],E=d[4],F=d[5],u=d[6],D=d[7],V=d[8],U=d[9],R=d[10],S=d[11],J=d[12],G=d[13],L=d[14],d=d[15];c[0]=f*Q+a*O+s*P+x*w;c[1]=g*Q+m*O+r*P+o*w;c[2]=i*Q+p*O+B*P+y*w;c[3]=e*Q+q*O+t*P+b*w;c[4]=f*E+a*F+s*u+x*D;c[5]=
g*E+m*F+r*u+o*D;c[6]=i*E+p*F+B*u+y*D;c[7]=e*E+q*F+t*u+b*D;c[8]=f*V+a*U+s*R+x*S;c[9]=g*V+m*U+r*R+o*S;c[10]=i*V+p*U+B*R+y*S;c[11]=e*V+q*U+t*R+b*S;c[12]=f*J+a*G+s*L+x*d;c[13]=g*J+m*G+r*L+o*d;c[14]=i*J+p*G+B*L+y*d;c[15]=e*J+q*G+t*L+b*d;return c},makeTranslate:function(b,d,c,f){this.makeIdentity(b);this.setColumnValues(b,3,d,c,f,1);return b},makeScale:function(b,d,c,f){this.makeIdentity(b);this.setDiagonalValues(b,d,c,f,1);return b},makeRotate:function(b,d,c,f,g){var i=Math.cos(d),e=1-i,d=Math.sin(d);
this.setFromValues(b,c*c*e+i,c*f*e+g*d,c*g*e-f*d,0,c*f*e-g*d,f*f*e+i,f*g*e+c*d,0,c*g*e+f*d,f*g*e-c*d,g*g*e+i,0,0,0,0,1);return b},makeRotateX:function(b,d){var c=Math.cos(d),f=Math.sin(d);this.setFromValues(b,1,0,0,0,0,c,f,0,0,-f,c,0,0,0,0,1);return b},makeRotateY:function(b,d){var c=Math.cos(d),f=Math.sin(d);this.setFromValues(b,c,0,-f,0,0,1,0,0,f,0,c,0,0,0,0,1);return b},makeRotateZ:function(b,d){var c=Math.cos(d),f=Math.sin(d);this.setFromValues(b,c,f,0,0,-f,c,0,0,0,0,1,0,0,0,0,1);return b},makePerspective:function(b,
d,c,f,g){var i=d/2,d=g-f,e=Math.sin(i);if(0===d||0===e||0===c)return b;i=Math.cos(i)/e;this.setFromValues(b,i/c,0,0,0,0,i,0,0,0,0,-(g+f)/d,-1,0,0,-(2*f*g)/d,0);return b},makeLookAt:function(b,d,c,f){var g=[],m=[],e=[];i.subtract(c,d,g);i.normalize(g,g);g[3]=0;i.cross(g,f,m);i.normalize(m,m);m[3]=0;i.cross(m,g,e);i.normalize(e,e);e[3]=0;i.negate(g,g);this.setRow(b,0,m);this.setRow(b,1,e);this.setRow(b,2,g);this.setRowValues(b,3,0,0,0,1);this.translate(b,-d[0],-d[1],-d[2]);return b},translate:function(b,
d,c,f){this.setColumnValues(b,3,b[0]*d+b[4]*c+b[8]*f+b[12],b[1]*d+b[5]*c+b[9]*f+b[13],b[2]*d+b[6]*c+b[10]*f+b[14],b[3]*d+b[7]*c+b[11]*f+b[15]);return b},scale:function(b,d,c,f){this.setFromValues(b,b[0]*d,b[1]*d,b[2]*d,b[3]*d,b[4]*c,b[5]*c,b[6]*c,b[7]*c,b[8]*f,b[9]*f,b[10]*f,b[11]*f,b[12],b[13],b[14],b[15]);return b},rotate:function(b,c,f,g,j){var i=b[0],e=b[1],a=b[2],m=b[3],p=b[4],q=b[5],s=b[6],r=b[7],B=b[8],t=b[9],x=b[10],o=b[11],y=b[12],Q=b[13],O=b[14],P=b[15],w=Math.cos(c),E=Math.sin(c),F=1-w,
c=f*f*F+w,u=f*g*F+j*E,D=f*j*F-g*E,L=f*g*F-j*E,U=g*g*F+w,R=g*j*F+f*E,S=f*j*F+g*E,f=g*j*F-f*E,j=j*j*F+w;this.setFromValues(b,i*c+p*u+B*D,e*c+q*u+t*D,a*c+s*u+x*D,m*c+r*u+o*D,i*L+p*U+B*R,e*L+q*U+t*R,a*L+s*U+x*R,m*L+r*U+o*R,i*S+p*f+B*j,e*S+q*f+t*j,a*S+s*f+x*j,m*S+r*f+o*j,y,Q,O,P);return b},rotateQ:function(b,c){var g=[];f.quaternion.toRotationMatrix4(c,g);f.mat4.multMat(b,g,b);return b},multVec3:function(b,c,f){var g=c[0],i=c[1],c=c[2];f[0]=g*b[0]+i*b[4]+c*b[8]+b[12];f[1]=g*b[1]+i*b[5]+c*b[9]+b[13];f[2]=
g*b[2]+i*b[6]+c*b[10]+b[14];return f},decompose:function(b,c,f,g){var j=b[0],m=b[1],e=b[2],a=b[4],q=b[5],s=b[6],B=b[8],t=b[9],r=b[10],x=b[12],y=b[13],Q=b[14],b=[],o=[];o[0]=j;o[1]=m;o[2]=e;g[0]=i.magnitude(o);o[0]=a;o[1]=q;o[2]=s;g[1]=i.magnitude(o);o[0]=B;o[1]=t;o[2]=r;g[2]=i.magnitude(o);c[0]=x;c[1]=y;c[2]=Q;if(0===g[0]||0===g[1]||0===g[2])return!1;c=[1/g[0],1/g[1],1/g[2]];this.setFromValues(b,j*c[0],m*c[0],e*c[0],0,a*c[1],q*c[1],s*c[1],0,B*c[2],t*c[2],r*c[2],0,0,0,0,1);p.fromRotationMatrix4(b,
f);return!0}},interpolator:t}}(),la={Int8:1,Int16:2,Int32:4,Uint8:1,Uint16:2,Uint32:4,Float32:4,Float64:8};window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c){window.setTimeout(c,1E3/60)}}());String.hashCode=function(c){for(var f=0,g=0,i=c.length;g<i;g++)f=31*f+c.charCodeAt(g),f&=f;return f};Object.copy=function(c){for(var f=Object.keys(c),
g=c instanceof Array?[]:{},i=0,q=f.length;i<q;i++){var p=f[i];g[p]="object"===typeof p?Object.copy(c[p]):c[p]}return g};Array.equals=function(c,f){if(!c||!f||c.length!==f.length)return!1;for(var g=0,i=c.length;g<i;g++)if(c[g]instanceof Array&&f[g]instanceof Array){if(!Array.equals(c[g],f[g]))return!1}else if(c[g]!==f[g])return!1;return!0};var L={header:function(c){return"http://www.hiveworkshop.com/forums/apps.php?p=textures&id="+c},mpqFile:function(c){return"http://www.hiveworkshop.com/forums/apps.php?p=mpq_file&file="+
c},customFile:function(c){return"http://www.hiveworkshop.com/forums/"+c}};window.Viewer=function(m){var Q,B,i;function q(b,a,c,d){if("MDLX"==b){b=new ya.Parser(a,p);b.ready&&(document.title=b.modelChunk.name.replace(/^.*[\\\/]/,"").replace(/\..*/,""),p({status:"Setting the model for rendering"}),ga&&console.log(b),a=u+N.wpsmain,b.geosetChunk&&(la&&Fa&&(D=e.newShader("main",N.vsbonetexture+N.wvshardskinningtexture,a),M=2),!D&&b.boneChunk.bones.length<Ga/4-1&&(D=e.newShader("main",N.wvshardskinningarray,
a),M=1),D||(D=e.newShader("main",N.wvssoftskinning,a),M=0),D&&(0===M?console.log("Running in SOFTware mode."):1===M?console.log("Running in HARDware mode (array)."):2===M&&console.log("Running in HARDware mode (texture)."))),b.particleEmitter2Chunk&&(V=e.newShader("particles",N.wvsparticles,u+N.wpsparticles)),b.ribbonEmitterChunk&&(U=e.newShader("ribbons",N.wvssoftskinning,a)),r=new ya.Model(b,d,!1,p),ga&&console.log(r));for(d=0;13>d;d++)a=10>d?"0"+d:d,b="ReplaceableTextures/TeamColor/TeamColor"+
a+".blp",a="ReplaceableTextures/TeamGlow/TeamGlow"+a+".blp",e.newTexture(b,L.mpqFile(b)),e.newTexture(a,L.mpqFile(a))}else{if(b=new za.Parser(a,p))document.title=b.name.replace(/^.*[\\\/]/,"").replace(/\..*/,""),p({status:"Setting the model for rendering"}),ga&&console.log(b),r=new za.Model(b,p),d="EXPLICITUV"+(r.uvSetCount-1),b=N.vsbonetexture+N.svscommon+"\n"+N.svsstandard,a=N.spscommon+"\n",c=u+a+N.spsspecialized,e.newShader("standard",b,u+a+N.spsstandard,[d]),e.newShader("diffuse",b,c,[d,"DIFFUSE_PASS"]),
e.newShader("normals",b,c,[d,"NORMALS_PASS"]),e.newShader("normalmap",b,c,[d,"NORMALS_PASS","HIGHRES_NORMALS"]),e.newShader("specular",b,c,[d,"SPECULAR_PASS"]),e.newShader("specular_normalmap",b,c,[d,"SPECULAR_PASS","HIGHRES_NORMALS"]),e.newShader("emissive",b,c,[d,"EMISSIVE_PASS"]),e.newShader("unshaded",b,c,[d,"UNSHADED_PASS"]),e.newShader("unshaded_normalmap",b,c,[d,"UNSHADED_PASS","HIGHRES_NORMALS"]),e.newShader("decal",b,c,[d,"DECAL_PASS"]),ga&&console.log(r);Da(document.getElementById("shaders-select"),
"change",function(b){E=b.target.value})}}function p(b){if(m.onprogress)m.onprogress(b)}function T(b){if(m.onerror)m.onerror(b)}function b(b){var b=new ta(b.target.response),a=ua(b,4);"MDLX"==a?(F=1,Q=[30,2E3],q(a,b,m,ra)):"43DM"==a?(F=2,Q=[0.2,20],q(a,b,m,ra)):(console.log("Invalid file"),console.log("Magic is: "+a));k();if(m.onload)m.onload(F)}function d(a){a=JSON.parse(a.target.response);ra=a.textures;p({status:"Downloading the model file"});fa(L.customFile(a.url),!0,b,T,p)}function h(b){1<P&&R&&
(e.bindShader("world"),a.disable(a.CULL_FACE),e.pushMatrix(),2==F&&e.scale(0.0125,0.0125,0.0125),e.bindWorldMatrix("u_mvp"),e.popMatrix(),b?(Y[0]+=O[0],Y[1]+=O[1],e.setParameter("u_uv_offset",Y),e.setParameter("u_a",0.6)):(e.setParameter("u_uv_offset",[0,0]),e.setParameter("u_a",1)),2<P?b?(a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),e.bindTexture("water",0),sa.render(),a.disable(a.BLEND)):(e.bindTexture("bedrock",0),o.render()):(e.bindTexture("grass",0),sa.render()))}function k(){i[0]=
0;i[1]=0;1===F?(i[2]=3*r.extent,B=[315,225]):(i[2]=6*r.extent,B=[315,315])}function j(){requestAnimationFrame(j);if(Aa){r&&r.update();var b=[];if(-1===I){var a=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],c=f.toRad(B[1]),d=f.toRad(B[0]);f.mat4.translate(a,i[0],i[1],-i[2]);f.mat4.rotate(a,d,1,0,0);f.mat4.rotate(a,c,0,0,1);f.mat4.multVec3(a,[0,0,1],b);e.loadIdentity();e.multMat(a)}else b=ba.position,cameraDest=ba.targetPosition,e.lookAt(b,cameraDest,up);$=b;0<P&&R&&(e.bindShader("world"),e.setParameter("u_uv_offset",
[0,0]),e.setParameter("u_a",1),e.pushMatrix(),e.loadIdentity(),e.bindWorldMatrix("u_mvp"),e.bindTexture("sky"),wa.render(),e.popMatrix());h();r&&r.render();2<P&&h(!0)}}var H=m.canvas,e=Ea(H),a=e.gl;i=[0,0,0];Q=[0,0];B=[0,0];var $=[0,0,0],ha=[0,0,2.5],M=0,ra={},r,I=-1,ba,sa,o,wa,Y=[0,0],O=[f.random(-0.004,0.004),f.random(-0.004,0.004)],P=2,w=!1,E="standard",F=0,u="precision mediump float;\n",D,V,U,R,S,J=1/60,G=1,oa=m.MODEL_ID,pa=m.MODEL_PATH,qa=m.MPQ_PATH,ga=m.DEBUG_MODE,la=a.getExtension("OES_texture_float"),
Fa=0<a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS),Ga=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS),xa=[[255,3,3],[0,66,255],[28,230,185],[84,0,129],[255,252,1],[254,138,14],[32,192,0],[229,91,176],[149,150,151],[126,191,241],[16,98,70],[78,42,4],[40,40,40]],N={vsbonetexture:"uniform sampler2D u_bones;uniform float u_bone_size;uniform float u_pixel_size;mat4 boneAtIndex(float A){return mat4(texture2D(u_bones,vec2(A*u_bone_size,0)),texture2D(u_bones,vec2(A*u_bone_size+u_pixel_size,0)),texture2D(u_bones,vec2(A*u_bone_size+u_pixel_size*2.0,0)),texture2D(u_bones,vec2(A*u_bone_size+u_pixel_size*3.0,0)));}",
vsworld:"uniform mat4 u_mvp;uniform vec2 u_uv_offset;attribute vec3 a_position;attribute vec2 a_uv;varying vec2 v_uv;void main(){v_uv=a_uv+u_uv_offset;gl_Position=u_mvp*vec4(a_position,1);}",vswhite:"uniform mat4 u_mvp;attribute vec3 a_position;void main(){gl_Position=u_mvp*vec4(a_position,1);}",psworld:"uniform sampler2D u_texture;uniform float u_a;varying vec2 v_uv;void main(){gl_FragColor=vec4(texture2D(u_texture,v_uv).rgb,u_a);}",pswhite:"void main(){gl_FragColor=vec4(1);}",wvssoftskinning:"uniform mat4 u_mvp;uniform vec2 u_uv_offset;attribute vec3 a_position;attribute vec2 a_uv;varying vec2 v_uv;void main(){v_uv=a_uv+u_uv_offset;gl_Position=u_mvp*vec4(a_position,1);}",
wvshardskinningarray:"uniform mat4 u_mvp;uniform mat4 u_bones[62];uniform vec2 u_uv_offset;attribute vec3 a_position;attribute vec2 a_uv;attribute vec4 a_bones;attribute float a_bone_number;varying vec2 v_uv;void main(){vec4 A=vec4(0);vec4 B=vec4(a_position,1);A+=u_bones[int(a_bones[0])]*B;A+=u_bones[int(a_bones[1])]*B;A+=u_bones[int(a_bones[2])]*B;A+=u_bones[int(a_bones[3])]*B;A/=a_bone_number;v_uv=a_uv+u_uv_offset;gl_Position=u_mvp*A;}",wvshardskinningtexture:"uniform mat4 u_mvp;uniform vec2 u_uv_offset;attribute vec3 a_position;attribute vec2 a_uv;attribute vec4 a_bones;attribute float a_bone_number;varying vec2 v_uv;void main(){vec4 A=vec4(0);vec4 B=vec4(a_position,1);A+=boneAtIndex(a_bones[0])*B;A+=boneAtIndex(a_bones[1])*B;A+=boneAtIndex(a_bones[2])*B;A+=boneAtIndex(a_bones[3])*B;A/=a_bone_number;v_uv=a_uv+u_uv_offset;gl_Position=u_mvp*A;}",
wvsparticles:"uniform mat4 u_mvp;attribute vec3 a_position;attribute vec2 a_uv;attribute vec4 a_color;varying vec2 v_uv;varying vec4 v_color;void main(){v_uv=a_uv;v_color=a_color;gl_Position=u_mvp*vec4(a_position,1);}",wpsmain:"uniform sampler2D u_texture;uniform bvec3 u_type;uniform vec4 u_modifier;varying vec3 v_normal;varying vec2 v_uv;void main(){vec4 A=texture2D(u_texture,v_uv);if(u_type[0]&&A.a<.7){discard;}if(u_type[1]&&A.r<.2&&A.g<.2&&A.b<.2){discard;}if(u_type[2]&&A.r>.9&&A.g>.9&&A.b>.9){discard;}gl_FragColor=A*u_modifier;}",
wpsparticles:"uniform sampler2D u_texture;varying vec2 v_uv;varying vec4 v_color;void main(){gl_FragColor=texture2D(u_texture,v_uv)*v_color;}",svscommon:"vec3 TBN(vec3 A,vec3 B,vec3 C,vec3 D){vec3 E;E.x=dot(A,B);E.y=dot(A,C);E.z=dot(A,D);return E;}",svsstandard:"uniform mat4 u_mvp;uniform mat4 u_mv;uniform vec3 u_eyePos;uniform vec3 u_lightPos;attribute vec3 a_position;attribute vec4 a_normal;attribute vec2 a_uv0;\n#ifdef EXPLICITUV1\nattribute vec2 a_uv1;\n#endif\n#ifdef EXPLICITUV2\nattribute vec2 a_uv1;attribute vec2 a_uv2\n#endif\n#ifdef EXPLICITUV3\nattribute vec2 a_uv1;attribute vec2 a_uv2attribute vec2 a_uv3\n#endif\nattribute vec4 a_tangent;attribute vec4 a_bones;attribute vec4 a_weights;varying vec3 v_normal;varying vec2 v_uv[4];varying vec3 v_lightDir;varying vec3 v_eyeVec;varying vec3 v_halfVec;void transform(vec3 A,vec3 B,vec3 C,vec4 D,vec4 E,out vec3 F,out vec3 G,out vec3 H){vec4 I=vec4(A,1);vec4 J=vec4(B,0);vec4 K=vec4(C,0);vec4 L;mat4 M=boneAtIndex(D[0])*E[0];mat4 N=boneAtIndex(D[1])*E[1];mat4 O=boneAtIndex(D[2])*E[2];mat4 P=boneAtIndex(D[3])*E[3];L=vec4(0);L+=M*I;L+=N*I;L+=O*I;L+=P*I;F=vec3(L);L=vec4(0);L+=M*J;L+=N*J;L+=O*J;L+=P*J;G=normalize(vec3(L));L=vec4(0);L+=M*K;L+=N*K;L+=O*K;L+=P*K;H=normalize(vec3(L));}void main(){vec3 A,B,C;transform(a_position,vec3(a_normal),vec3(a_tangent),a_bones,a_weights,A,B,C);mat3 D=mat3(u_mv);vec3 E=(u_mv*vec4(A,1)).xyz;vec3 F=normalize(D*B);vec3 G=normalize(D*C);vec3 H=normalize(cross(F,G)*a_normal.w);vec3 I=normalize(u_lightPos-E);v_lightDir=normalize(TBN(I,G,H,F));vec3 J=normalize(u_eyePos-E);vec3 K=normalize(J-u_lightPos);v_eyeVec=TBN(J,G,H,F);v_halfVec=TBN(K,G,H,F);v_normal=F;v_uv[0]=a_uv0;\n#ifdef EXPLICITUV1\nv_uv[1]=a_uv1;\n#endif\n#ifdef EXPLICITUV2\nv_uv[1]=a_uv1;v_uv[2]=a_uv2;\n#endif\n#ifdef EXPLICITUV3\nv_uv[1]=a_uv1;v_uv[2]=a_uv2;v_uv[3]=a_uv3;\n#endif\ngl_Position=u_mvp*vec4(A,1);}",
spscommon:"uniform vec3 u_teamColor;varying vec3 v_normal;varying vec2 v_uv[4];varying vec3 v_lightDir;varying vec3 v_eyeVec;varying vec3 v_halfVec;struct LayerSettings{bool enabled;float op;float channels;float teamColorMode;vec3 multAddAlpha;bool useAlphaFactor;bool invert;bool multColor;bool addColor;bool clampResult;bool useConstantColor;vec4 constantColor;float uvSource;float uvCoordinate;float fresnelMode;float fresnelTransformMode;mat4 fresnelTransform;bool fresnelClamp;vec3 fresnelExponentBiasScale;};\n#define SPECULAR_RGB 0.0\n#define SPECULAR_A_ONLY 1.0\n#define FRESNELMODE_NONE 0.0\n#define FRESNELMODE_STANDARD 1.0\n#define FRESNELMODE_INVERTED 2.0\n#define FRESNELTRANSFORM_NONE 0.0\n#define FRESNELTRANSFORM_SIMPLE 1.0\n#define FRESNELTRANSFORM_NORMALIZED 2.0\n#define UVMAP_EXPLICITUV0 0.0\n#define UVMAP_EXPLICITUV1 1.0\n#define UVMAP_REFLECT_CUBICENVIO 2.0\n#define UVMAP_REFLECT_SPHERICALENVIO 3.0\n#define UVMAP_PLANARLOCALZ 4.0\n#define UVMAP_PLANARWORLDZ 5.0\n#define UVMAP_PARTICLE_FLIPBOOK 6.0\n#define UVMAP_CUBICENVIO 7.0\n#define UVMAP_SPHERICALENVIO 8.0\n#define UVMAP_EXPLICITUV2 9.0\n#define UVMAP_EXPLICITUV3 10.0\n#define UVMAP_PLANARLOCALX 11.0\n#define UVMAP_PLANARLOCALY 12.0\n#define UVMAP_PLANARWORLDX 13.0\n#define UVMAP_PLANARWORLDY 14.0\n#define UVMAP_SCREENSPACE 15.0\n#define UVMAP_TRIPLANAR_LOCAL 16.0\n#define UVMAP_TRIPLANAR_WORLD 17.0\n#define UVMAP_TRIPLANAR_WORLD_LOCAL_Z 18.0\n#define CHANNELSELECT_RGB 0.0\n#define CHANNELSELECT_RGBA 1.0\n#define CHANNELSELECT_A 2.0\n#define CHANNELSELECT_R 3.0\n#define CHANNELSELECT_G 4.0\n#define CHANNELSELECT_B 5.0\n#define TEAMCOLOR_NONE 0.0\n#define TEAMCOLOR_DIFFUSE 1.0\n#define TEAMCOLOR_EMISSIVE 2.0\n#define LAYEROP_MOD 0.0\n#define LAYEROP_MOD2X 1.0\n#define LAYEROP_ADD 2.0\n#define LAYEROP_LERP 3.0\n#define LAYEROP_TEAMCOLOR_EMISSIVE_ADD 4.0\n#define LAYEROP_TEAMCOLOR_DIFFUSE_ADD 5.0\n#define LAYEROP_ADD_NO_ALPHA 6.0\nfloat calculateFresnelTerm(vec3 A,vec3 B,float C,mat4 D,float E,bool F){vec3 G=B;float H;if(E!=FRESNELTRANSFORM_NONE){G=(D*vec4(G,1.0)).xyz;if(E==FRESNELTRANSFORM_NORMALIZED){G=normalize(G);}}if(F){H=1.0-clamp(-dot(A,G),.0,1.0);}else{H=1.0-abs(dot(A,G));}H=max(H,.0000001);return pow(H,C);}vec3 combineLayerColor(vec4 A,vec3 B,LayerSettings C){if(C.op==LAYEROP_MOD){B*=A.rgb;}else if(C.op==LAYEROP_MOD2X){B*=A.rgb*2.0;}else if(C.op==LAYEROP_ADD){B+=A.rgb*A.a;}else if(C.op==LAYEROP_ADD_NO_ALPHA){B+=A.rgb;}else if(C.op==LAYEROP_LERP){B=mix(B,A.rgb,A.a);}else if(C.op==LAYEROP_TEAMCOLOR_EMISSIVE_ADD){B+=A.a*u_teamColor;}else if(C.op==LAYEROP_TEAMCOLOR_DIFFUSE_ADD){B+=A.a*u_teamColor;}return B;}vec4 chooseChannel(float A,vec4 B){if(A==CHANNELSELECT_R){B=B.rrrr;}else if(A==CHANNELSELECT_G){B=B.gggg;}else if(A==CHANNELSELECT_B){B=B.bbbb;}else if(A==CHANNELSELECT_A){B=B.aaaa;}else if(A==CHANNELSELECT_RGB){B.a=1.0;}return B;}vec2 getUV(LayerSettings A){if(A.uvCoordinate==1.0){return v_uv[1];}else if(A.uvCoordinate==2.0){return v_uv[2];}else if(A.uvCoordinate==3.0){return v_uv[3];}return v_uv[0];}vec4 sampleLayer(sampler2D A,LayerSettings B){if(B.useConstantColor&&false){return B.constantColor;}return texture2D(A,getUV(B));}vec4 computeLayerColor(sampler2D A,LayerSettings B){vec4 C=sampleLayer(A,B);vec4 D=chooseChannel(B.channels,C);if(B.useAlphaFactor&&false){D.a*=B.multAddAlpha.z;}if(B.teamColorMode==TEAMCOLOR_DIFFUSE){D=vec4(mix(u_teamColor,D.rgb,C.a),1);}else if(B.teamColorMode==TEAMCOLOR_EMISSIVE){D=vec4(mix(u_teamColor,D.rgb,C.a),1);}if(B.invert){D=vec4(1)-D;}if(B.multColor&&false){D*=B.multAddAlpha.x;}if(B.addColor&&false){D+=B.multAddAlpha.y;}if(B.clampResult){D=clamp(D,.0,1.0);}if(B.fresnelMode!=FRESNELMODE_NONE){float E=calculateFresnelTerm(v_normal,v_eyeVec,B.fresnelExponentBiasScale.x,B.fresnelTransform,B.fresnelTransformMode,B.fresnelClamp);if(B.fresnelMode==FRESNELMODE_INVERTED){E=1.0-E;}E=clamp(E*B.fresnelExponentBiasScale.z+B.fresnelExponentBiasScale.y,.0,1.0);D*=E;}return D;}vec3 decodeNormal(sampler2D A){vec4 B=texture2D(A,v_uv[0]);vec3 C;C.xy=2.0*B.wy-1.0;C.z=sqrt(max(.0,1.0-dot(C.xy,C.xy)));return C;}vec4 computeSpecular(sampler2D A,LayerSettings B,float C,float D,vec3 E){vec4 F;if(B.enabled){F=computeLayerColor(A,B);}else{F=vec4(0);}float G=pow(max(-dot(v_halfVec,E),.0),C)*D;return F*G;}",
spsstandard:"uniform float u_specularity;uniform float u_specMult;uniform float u_emisMult;uniform vec4 u_lightAmbient;uniform LayerSettings u_diffuseLayerSettings;uniform sampler2D u_diffuseMap;uniform LayerSettings u_decalLayerSettings;uniform sampler2D u_decalMap;uniform LayerSettings u_specularLayerSettings;uniform sampler2D u_specularMap;uniform LayerSettings u_glossLayerSettings;uniform sampler2D u_glossMap;uniform LayerSettings u_emissiveLayerSettings;uniform sampler2D u_emissiveMap;uniform LayerSettings u_emissive2LayerSettings;uniform sampler2D u_emissive2Map;uniform LayerSettings u_evioLayerSettings;uniform sampler2D u_evioMap;uniform LayerSettings u_evioMaskLayerSettings;uniform sampler2D u_evioMaskMap;uniform LayerSettings u_alphaLayerSettings;uniform sampler2D u_alphaMap;uniform LayerSettings u_alphaMaskLayerSettings;uniform sampler2D u_alphaMaskMap;uniform LayerSettings u_normalLayerSettings;uniform sampler2D u_normalMap;uniform LayerSettings u_heightLayerSettings;uniform sampler2D u_heightMap;uniform LayerSettings u_lightMapLayerSettings;uniform sampler2D u_lightMapMap;uniform LayerSettings u_aoLayerSettings;uniform sampler2D u_aoMap;void main(){vec3 A;vec4 B=u_lightAmbient;vec3 C;vec3 D;if(u_normalLayerSettings.enabled){C=decodeNormal(u_normalMap);}else{C=v_normal;}float E=max(dot(C,v_lightDir),.0);if(E>.0){if(u_diffuseLayerSettings.enabled){vec4 F=computeLayerColor(u_diffuseMap,u_diffuseLayerSettings);A=combineLayerColor(F,A,u_diffuseLayerSettings);}if(u_decalLayerSettings.enabled){vec4 G=computeLayerColor(u_decalMap,u_decalLayerSettings);A=combineLayerColor(G,A,u_decalLayerSettings);}vec4 H=computeSpecular(u_specularMap,u_specularLayerSettings,u_specularity,u_specMult,C);if(u_lightMapLayerSettings.enabled){vec4 I=computeLayerColor(u_lightMapMap,u_lightMapLayerSettings)*2.0;D=I.rgb;}/*B.rgb=A*D+H.rgb;*/B.rgb=(A+H.rgb)*E;bool J=false;vec3 K;vec4 L;if(u_emissiveLayerSettings.enabled){L=computeLayerColor(u_emissiveMap,u_emissiveLayerSettings);if(u_emissiveLayerSettings.op==LAYEROP_MOD||u_emissiveLayerSettings.op==LAYEROP_MOD2X||u_emissiveLayerSettings.op==LAYEROP_LERP){B.rgb=combineLayerColor(L,B.rgb,u_emissiveLayerSettings);}else{K=combineLayerColor(L,K,u_emissiveLayerSettings);J=true;}}if(u_emissive2LayerSettings.enabled){L=computeLayerColor(u_emissive2Map,u_emissive2LayerSettings);if(!J&&(u_emissive2LayerSettings.op==LAYEROP_MOD||u_emissive2LayerSettings.op==LAYEROP_MOD2X||u_emissive2LayerSettings.op==LAYEROP_LERP)){B.rgb=combineLayerColor(L,B.rgb,u_emissive2LayerSettings);}else{K=combineLayerColor(L,K,u_emissive2LayerSettings);J=true;}}if(J){B.rgb+=K*u_emisMult;}}gl_FragColor=B;}",
spsspecialized:"#ifdef DIFFUSE_PASS\nuniform LayerSettings u_diffuseLayerSettings;uniform sampler2D u_diffuseMap;\n#endif\n#ifdef SPECULAR_PASS\nuniform LayerSettings u_specularLayerSettings;uniform sampler2D u_specularMap;uniform float u_specularity;uniform float u_specMult;\n#endif\n#ifdef HIGHRES_NORMALS\nuniform LayerSettings u_normalLayerSettings;uniform sampler2D u_normalMap;\n#endif\n#ifdef EMISSIVE_PASS\nuniform LayerSettings u_emissiveLayerSettings;uniform sampler2D u_emissiveMap;uniform LayerSettings u_emissive2LayerSettings;uniform sampler2D u_emissive2Map;uniform float u_emisMult;\n#endif\n#ifdef DECAL_PASS\nuniform LayerSettings u_decalLayerSettings;uniform sampler2D u_decalMap;\n#endif\nvoid main(){vec4 A=vec4(0);vec3 B;\n#ifdef HIGHRES_NORMALS\nB=decodeNormal(u_normalMap);\n#else\nB=v_normal;\n#endif\n#ifdef DIFFUSE_PASS\nA=computeLayerColor(u_diffuseMap,u_diffuseLayerSettings);\n#endif\n#ifdef NORMALS_PASS\nA=vec4(B,1);\n#endif\n#ifdef SPECULAR_PASS\nA=computeSpecular(u_specularMap,u_specularLayerSettings,u_specularity,u_specMult,B);\n#endif\n#ifdef EMISSIVE_PASS\nbool C=false;vec3 D=vec3(0);vec4 E;if(u_emissiveLayerSettings.enabled){E=computeLayerColor(u_emissiveMap,u_emissiveLayerSettings);if(u_emissiveLayerSettings.op==LAYEROP_MOD||u_emissiveLayerSettings.op==LAYEROP_MOD2X||u_emissiveLayerSettings.op==LAYEROP_LERP){A.rgb=combineLayerColor(E,A.rgb,u_emissiveLayerSettings);}else{D=combineLayerColor(E,D,u_emissiveLayerSettings);C=true;}}if(u_emissive2LayerSettings.enabled){E=computeLayerColor(u_emissive2Map,u_emissive2LayerSettings);if(!C&&(u_emissive2LayerSettings.op==LAYEROP_MOD||u_emissive2LayerSettings.op==LAYEROP_MOD2X||u_emissive2LayerSettings.op==LAYEROP_LERP)){A.rgb=combineLayerColor(E,A.rgb,u_emissive2LayerSettings);}else{D=combineLayerColor(E,D,u_emissive2LayerSettings);C=true;}}if(C){A.rgb+=D.rgb*u_emisMult;}\n#endif\n#ifdef UNSHADED_PASS\nfloat F=max(dot(B,v_lightDir),.0);A=vec4(F,F,F,1);\n#endif\n#ifdef DECAL_PASS\nif(u_decalLayerSettings.enabled){vec4 G=computeLayerColor(u_decalMap,u_decalLayerSettings);A.rgb=combineLayerColor(G,A.rgb,u_decalLayerSettings);A.a=1.0;}\n#endif\ngl_FragColor=A;}"},
ya=function(){function b(a,c,d,e,g,h){var l;l=a.length;for(var v=0;v!==a.length&&d>a[v].time;)l=v,v++;l!==a.length&&a[l].time<e&&(l=a.length);v!==a.length&&a[v].time>g&&(v=a.length);l=[l,v];g=a.length;e=l[0];l=l[1];if(e===g)return l===g?h:a[l].vector;if(l===g)return a[e].vector;e=a[e];l=a[l];if(e.time>=l.time)return e.vector;a=f.clamp((d-e.time)/(l.time-e.time),0,1);return("number"===typeof e.vector?f.interpolator.scalar:3===e.vector.length?f.interpolator.vector:f.interpolator.quaternion)(e.vector,
e.outTan,l.inTan,l.vector,a,c)}function d(a,c,e){if(a){if(4294967295!==a.globalSequenceId){var f=e.globalSequences[a.globalSequenceId];return b(a.tracks,a.interpolationType,e.time%f,0,f,c)}if(e.sequence)return f=e.sequence.interval,b(a.tracks,a.interpolationType,e.frame,f[0],f[1],c)}return c}function h(b,c){var d,e,g=b.pivotPointChunk.points;this.model=c;this.nodes=b.nodes;for(d=0,e=b.nodes.length;d<e;d++){var l=b.nodes[d];l.pivot=g[l.objectId]||[0,0,0];l.worldMatrix=[]}this.bones=[];if(b.boneChunk){g=
b.boneChunk.bones;for(d=0,e=g.length;d<e;d++)this.bones.push(g[d].node)}0<M&&(this.hwbones=new Float32Array(16+16*this.bones.length));2===M&&(this.boneTexture=a.createTexture(),this.boneTextureSize=4*Math.max(2,f.powerOfTwo(this.bones.length+1)),this.texelFraction=1/this.boneTextureSize,this.boneFraction=4*this.texelFraction,a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this.boneTexture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.boneTextureSize,1,0,a.RGBA,a.FLOAT,null),a.texParameteri(a.TEXTURE_2D,
a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST));this.root={objectId:4294967295};this.root.children=this.setup(b.nodes,this.root)}function i(b){this.node=b.node;var a=b.vertices,c=a[0],a=a[1],d=b.boundsRadius,f;0===b.type?f=e.newCube(c[0],c[1],c[2],a[0],a[1],a[2]):2===b.type&&(f=e.newSphere(c[0],c[1],c[2],9,9,d));this.shape=f}function j(b,a,c,d){this.sequences=[];this.loopingMode=0;this.spawned=c;this.time=this.frame=0;this.setup(b);d&&d({lengthComputable:!0,
total:100,loaded:100});b.textureChunk&&(d&&d({status:"Loading textures"}),this.loadTextures(b,a,d));this.ready=!0}function q(b,a,c,d,f){0!==a&&(b="ReplaceableTextures/"+K[a]+".blp");this.fileName=b.replace(/\\/g,"/");this.replaceableId=a;(b=c[b])&&b.included?(this.custom=!0,this.glTexture=e.newTexture(this.fileName,L.customFile(b.url),!1,!1,d,f)):this.glTexture=e.newTexture(this.fileName,L.mpqFile(this.fileName),!1,!1,d,f)}function p(b){var c,d,e,f,g=new Float32Array(b.vertexPositions),l=b.textureCoordinateSets;
e=2*l[0].length;var h=new Float32Array(l.length*e);for(c=0,d=b.textureCoordinateSets.length;c<d;c++)h.set(l[c],c*e);var l=new Float32Array(4*b.vertexPositions.length),v=new Float32Array(b.vertexPositions.length),i=new Uint16Array(b.faces),j=[];this.uvSetSize=4*e;for(c=0,d=b.matrixGroups.length,f=0;c<d;c++)j.push(b.matrixIndexes.slice(f,f+b.matrixGroups[c])),f+=b.matrixGroups[c];for(c=0,d=g.length/3,f=0;c<d;c++){var n=j[b.vertexGroups[c]],z=0;for(e=0;4>e;e++)n&&e<n.length?(l[f]=n[e]+1,z+=1):l[f]=0,
f+=1;v[c]=z}this.offsets=[0,g.byteLength];this.offsets[2]=this.offsets[1]+h.byteLength;this.offsets[3]=this.offsets[2]+l.byteLength;this.offsets[4]=this.offsets[3]+v.byteLength;this.buffers={vertices:a.createBuffer(),faces:a.createBuffer()};c=this.offsets[4];0===M&&(c=this.offsets[2],this.positions=g,this.animatedPositions=new Float32Array(b.vertexPositions.length),this.boneNumbers=v,this.boneIndices=l);a.bindBuffer(a.ARRAY_BUFFER,this.buffers.vertices);a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);
a.bufferSubData(a.ARRAY_BUFFER,this.offsets[0],g);a.bufferSubData(a.ARRAY_BUFFER,this.offsets[1],h);0<M&&(a.bufferSubData(a.ARRAY_BUFFER,this.offsets[2],l),a.bufferSubData(a.ARRAY_BUFFER,this.offsets[3],v));a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.buffers.faces);a.bufferData(a.ELEMENT_ARRAY_BUFFER,i,a.STATIC_DRAW);this.faces=i.length}function k(b,a,c){for(var d=Object.keys(b),e=d.length;e--;){var f=d[e];this[f]=b[f]}this.model=c;this.geosetId=a;this.renderOrder=z[b.filterMode]||0}function m(b){this.model=
b;this.position=[]}function t(b,a){var c,d;d=Object.keys(b);for(c=d.length;c--;)this[d[c]]=b[d[c]];this.model=a;this.lastCreation=0;this.spawnModelFileName=this.spawnModelFileName.replace(/\\/g,"/").replace("MDL","MDX");fa(L.mpqFile(this.spawnModelFileName),!0,function(b){b=new C(new ta(b.target.response));b.ready&&(this.spawnModel=new j(b,{},!0),this.spawnModel.setAnimation(0),ga&&console.log(this.spawnModel))}.bind(this));if(this.tracks.emissionRate){var e=this.tracks.emissionRate,f=0;for(c=0,d=
e.length;c<d;c++){var g=e[c];g.vector>f&&(f=g.vector)}c=Math.round(2*f*Math.ceil(this.lifespan))}else c=Math.round(this.emissionRate*Math.ceil(this.lifespan));this.particles=[];for(this.reusables=[];c--;)this.particles[c]=new m(a),this.reusables.push(c)}function o(){this.color=[];this.position=[]}function l(b,c){var d,e;e=Object.keys(b);for(d=e.length;d--;)this[e[d]]=b[e[d]];this.model=c;this.lastCreation=0;if(this.tracks.emissionRate){var f=this.tracks.emissionRate,g=0;for(d=0,e=f.length;d<e;d++){var l=
f[d];l.vector>g&&(g=l.vector)}d=2*Math.ceil(g)*Math.ceil(this.lifespan)}else d=Math.ceil(this.emissionRate)*Math.ceil(this.lifespan)+3;this.head=0===this.headOrTail||2===this.headOrTail;this.tail=1===this.headOrTail||2===this.headOrTail;this.head&&this.tail&&(d*=2);this.particles=[];this.reusables=[];this.buffer=a.createBuffer();this.data=new Float32Array(54*d);a.bindBuffer(a.ARRAY_BUFFER,this.buffer);for(a.bufferData(a.ARRAY_BUFFER,this.data,a.DYNAMIC_DRAW);d--;)this.particles[d]=new o(c),this.reusables.push(d);
this.head?(this.headFrames=(this.headInterval[1]-this.headInterval[0]+1)*this.headInterval[2],this.headDecayFrames=(this.headDecayInterval[1]-this.headDecayInterval[0]+1)*this.headDecayInterval[2]):this.headDecayFrames=this.headFrames=0;this.tail?(this.tailFrames=(this.tailInterval[1]-this.tailInterval[0]+1)*this.tailInterval[2],this.tailDecayFrames=(this.tailDecayInterval[1]-this.tailDecayInterval[0]+1)*this.tailDecayInterval[2]):this.tailDecayFrames=this.tailFrames=0;this.numberOfFrames=this.headFrames+
this.headDecayFrames+this.tailFrames+this.tailDecayFrames;this.cellWidth=1/this.columns;this.cellHeight=1/this.rows;this.colors=[];for(d=0;3>d;d++)this.colors[d]=[this.segmentColor[d][0],this.segmentColor[d][1],this.segmentColor[d][2],this.segmentAlpha[d]/255]}function n(b){this.alive=!0;this.health=b.lifespan;var a=b.node.pivot,c=d(b.tracks.heightBelow,b.heightBelow,this.model),e=d(b.tracks.heightAbove,b.heightAbove,this.model);this.p1=[a[0],a[1]-c,a[2]];this.p2=[a[0],a[1]+e,a[2]];f.mat4.multVec3(b.node.worldMatrix,
this.p1,this.p1);f.mat4.multVec3(b.node.worldMatrix,this.p2,this.p2)}function v(b,c,d){var e,f=Object.keys(b);for(e=f.length;e--;)this[f[e]]=b[f[e]];this.maxRibbons=e=Math.ceil(this.emissionRate*this.lifespan);this.model=d;this.lastCreation=0;this.ribbons=[];this.data=new Float32Array(10*e);this.buffer=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,this.buffer);a.bufferData(a.ARRAY_BUFFER,this.data,a.DYNAMIC_DRAW);this.cellWidth=1/this.columns;this.cellHeight=1/this.rows;d=[[],[],[],[]];b=c[this.materialId].layers;
for(e=0,c=b.length;e<c;e++)f=new k(b[e],0),d[f.renderOrder].push(f);this.layers=d[0].concat(d[1]).concat(d[2]).concat(d[3])}var C=function(){function b(a){return{boundsRadius:g(a),minimum:s(a),maximum:s(a)}}function a(b,c,d,e){for(var f=0,ia=[];f!==c;){var g=new d(b,e),f=f+g.inclusiveSize;ia.push(g)}return ia}function d(b,a,c){for(var e=[];a--;)e.push(new c(b));return e}function e(b,a,c){for(var d=[];a--;)d.push(c(b));return d}function f(b,a){for(var c={};w[a][ua(b,4)];){var d=w[a][x(b,4)];c[d[1]]=
new v(b,d[0])}return c}function l(b,a){var c=new i(b);a.push(c);return c}function h(b,a,c){this.time=y(b);this.vector=c(b);1<a&&(this.inTan=c(b),this.outTan=c(b))}function v(b,a){var d=c(b);this.interpolationType=c(b);this.globalSequenceId=c(b);for(this.tracks=[];d--;)this.tracks.push(new h(b,this.interpolationType,a))}function i(b){this.inclusiveSize=c(b);this.name=x(b,80);this.objectId=c(b);this.parentId=c(b);var a=c(b);0===a?this.helper=!0:(a&1&&(this.dontInheritTranslation=!0),a&2&&(this.dontInheritRotation=
!0),a&4&&(this.dontInheritScaling=!0),a&8&&(this.billboarded=!0),a&16&&(this.billboardedLockX=!0),a&32&&(this.billboardedLockY=!0),a&64&&(this.billboardedLockZ=!0),a&128&&(this.cameraAnchored=!0),a&256&&(this.bone=!0),a&512&&(this.light=!0),a&1024&&(this.eventObject=!0),a&2048&&(this.attachment=!0),a&4096&&(this.particleEmitter=!0),a&8192&&(this.collisionShape=!0),a&16384&&(this.ribbonEmitter=!0),a&32768&&(this.emitterUsesMdlOrUnshaded=!0),a&65536&&(this.emitterUsesTgaOrSortPrimitivesFarZ=!0),a&131072&&
(this.lineEmitter=!0),a&262144&&(this.unfogged=!0),a&524288&&(this.modelSpace=!0),a&1048576&&(this.xYQuad=!0));this.flags=a;this.tracks=f(b,"NODE")}function j(a){this.name=x(a,80);this.interval=X(a,2);this.moveSpeed=g(a);this.flags=c(a);this.rarity=g(a);this.syncPoint=c(a);this.extent=b(a)}function n(b){this.replaceableId=c(b);this.fileName=x(b,260);this.flags=c(b)}function z(b){this.inclusiveSize=c(b);this.filterMode=c(b);var a=c(b);a&1&&(this.unshaded=!0);a&2&&(this.sphereEnvironmentMap=!0);a&16&&
(this.twoSided=!0);a&32&&(this.unfogged=!0);a&48&&(this.noDepthTest=!0);a&64&&(this.noDepthSet=!0);this.shadingFlags=a;this.textureId=c(b);this.textureAnimationId=c(b);this.coordId=c(b);this.alpha=g(b);this.tracks=f(b,"LAYS")}function K(b){this.inclusiveSize=c(b);this.priorityPlane=c(b);this.flags=c(b);12<this.inclusiveSize&&(x(b,4),this.layers=d(b,c(b),z))}function C(b){this.inclusiveSize=c(b);this.tracks=f(b,"TXAN")}function p(a){this.inclusiveSize=c(a);x(a,4);this.vertexPositions=Z(a,3*c(a));x(a,
4);this.vertexNormals=Z(a,3*c(a));x(a,4);this.faceTypeGroups=X(a,c(a));x(a,4);this.faceGroups=X(a,c(a));x(a,4);var d=c(a);this.faces=ca(a,d,"Uint16");x(a,4);this.vertexGroups=ea(a,c(a));x(a,4);this.matrixGroups=X(a,c(a));x(a,4);this.matrixIndexes=X(a,c(a));this.materialId=c(a);this.selectionGroup=c(a);this.selectionFlags=c(a);this.extent=b(a);this.extents=e(a,c(a),b);x(a,4);this.textureCoordinateSets=[];for(var d=0,f=c(a);d<f;d++)x(a,4),this.textureCoordinateSets[d]=Z(a,2*c(a))}function q(a){this.inclusiveSize=
c(a);this.alpha=g(a);this.flags=c(a);this.color=s(a);this.geosetId=c(a);this.tracks=f(a,"GEOA")}function r(a,b){this.node=l(a,b);this.geosetId=c(a);this.geosetAnimationId=c(a);this.inclusiveSize=this.node.inclusiveSize+8}function k(a,b){this.inclusiveSize=c(a);this.node=l(a,b);this.type=c(a);this.attenuationStart=c(a);this.attenuationEnd=c(a);this.color=s(a);this.intensity=g(a);this.ambientColor=s(a);this.ambientIntensity=g(a);this.tracks=f(a,"LITE")}function m(a,b){this.inclusiveSize=c(a);this.node=
l(a,b);this.emissionRate=g(a);this.gravity=g(a);this.longitude=g(a);this.latitude=g(a);this.spawnModelFileName=x(a,260);this.lifespan=g(a);this.initialVelocity=g(a);this.tracks=f(a,"PREM")}function t(a,b){this.inclusiveSize=c(a);this.node=l(a,b);this.speed=g(a);this.variation=g(a);this.latitude=g(a);this.gravity=g(a);this.lifespan=g(a);this.emissionRate=g(a);this.length=g(a);this.width=g(a);this.filterMode=c(a);this.rows=c(a);this.columns=c(a);this.headOrTail=c(a);this.tailLength=g(a);this.time=g(a);
this.segmentColor=ma(a,3,3,"Float32");this.segmentAlpha=ea(a,3);this.segmentScaling=Z(a,3);this.headInterval=X(a,3);this.headDecayInterval=X(a,3);this.tailInterval=X(a,3);this.tailDecayInterval=X(a,3);this.textureId=c(a);this.squirt=c(a);this.priorityPlane=c(a);this.replaceableId=c(a);this.tracks=f(a,"PRE2")}function W(a,b){this.inclusiveSize=c(a);this.node=l(a,b);this.heightAbove=g(a);this.heightBelow=g(a);this.alpha=g(a);this.color=s(a);this.lifespan=g(a);this.textureSlot=c(a);this.emissionRate=
c(a);this.rows=c(a);this.columns=c(a);this.materialId=c(a);this.gravity=g(a);this.tracks=f(a,"RIBB")}function o(a){this.inclusiveSize=c(a);this.name=x(a,80);this.position=s(a);this.fieldOfView=g(a);this.farClippingPlane=g(a);this.nearClippingPlane=g(a);this.targetPosition=s(a);this.tracks=f(a,"CAMS")}function u(a,b){this.node=l(a,b);var d=c(a);this.type=d;this.inclusiveSize=this.node.inclusiveSize+4;0===d||1===d||3===d?(this.vertices=ma(a,2,3,"Float32"),this.inclusiveSize+=24):2===d&&(this.vertices=
[s(a)],this.inclusiveSize+=12);if(2===d||3===d)this.boundsRadius=g(a),this.inclusiveSize+=4}var w={LAYS:{KMTF:[c,"textureId"],KMTA:[g,"alpha"]},TXAN:{KTAT:[s,"translation"],KTAR:[ka,"rotation"],KTAS:[s,"scaling"]},GEOA:{KGAO:[g,"alpha"],KGAC:[s,"color"]},LITE:{KLAS:[g,"attenuationStart"],KLAE:[g,"attenuationEnd"],KLAC:[s,"color"],KLAI:[g,"intensity"],KLBI:[g,"ambientIntensity"],KLBC:[s,"ambientColor"],KLAV:[g,"visibility"]},ATCH:{KATV:[g,"visibility"]},PREM:{KPEE:[g,"emissionRate"],KPEG:[g,"gravity"],
KPLN:[g,"longitude"],KPLT:[g,"latitude"],KPEL:[g,"lifespan"],KPES:[g,"speed"],KPEV:[g,"visibility"]},PRE2:{KP2S:[g,"speed"],KP2R:[g,"variation"],KP2L:[g,"latitude"],KP2G:[g,"gravity"],KP2E:[g,"emissionRate"],KP2N:[g,"length"],KP2W:[g,"width"],KP2V:[g,"visibility"]},RIBB:{KRHA:[g,"heightAbove"],KRHB:[g,"heightBelow"],KRAL:[g,"alpha"],KRCO:[s,"color"],KRTX:[c,"textureSlot"],KRVS:[g,"visibility"]},CAMS:{KCTR:[s,"positionTranslation"],KTTR:[s,"targetTranslation"],KCRL:[c,"rotation"]},NODE:{KGTR:[s,"translation"],
KGRT:[ka,"rotation"],KGSC:[s,"scaling"]}},B={MODL:[function(a){this.name=x(a,80);this.animationFileName=x(a,260);this.extent=b(a);this.blendTime=c(a)},"modelChunk"],SEQS:[function(a,b){this.sequences=d(a,b/132,j)},"sequenceChunk"],GLBS:[function(a,b){this.sequences=e(a,b/4,c)},"globalSequenceChunk"],TEXS:[function(a,b){this.textures=d(a,b/268,n)},"textureChunk"],MTLS:[function(b,c){this.materials=a(b,c,K)},"materialChunk"],TXAN:[function(b,c){this.animations=a(b,c,C)},"textureAnimationChunk"],GEOS:[function(b,
c){this.geosets=a(b,c,p)},"geosetChunk"],GEOA:[function(b,c){this.animations=a(b,c,q)},"geosetAnimationChunk"],BONE:[function(b,c,d){this.bones=a(b,c,r,d)},"boneChunk"],LITE:[function(b,c,d){this.lights=a(b,c,k,d)},"lightChunk"],HELP:[function(a,b,c){for(var d=l,e=0,f=[];e!==b;){var ia=d(a,c),e=e+ia.inclusiveSize;f.push(ia)}this.helpers=f},"helperChunk"],PIVT:[function(a,b){this.points=ma(a,b/12,3,"Float32")},"pivotPointChunk"],PREM:[function(b,c,d){this.emitters=a(b,c,m,d)},"particleEmitterChunk"],
PRE2:[function(b,c,d){this.emitters=a(b,c,t,d)},"particleEmitter2Chunk"],RIBB:[function(b,c,d){this.emitters=a(b,c,W,d)},"ribbonEmitterChunk"],CAMS:[function(b,c){this.cameras=a(b,c,o)},"cameraChunk"],CLID:[function(b,c,d){this.shapes=a(b,c,u,d)},"collisionShapeChunk"]};return function(a,b){if("MDLX"===x(a,4)){for(this.nodes=[];0<a.size-a.index;){var d=x(a,4),e=c(a);(d=B[d])?this[d[1]]=new d[0](a,e,this.nodes):(d=a,d.index+=e,0>d.index?d.index=0:d.index>d.size&&(d.index=d.size));"function"===typeof b&&
b({lengthComputable:!0,total:a.size,loaded:a.index})}this.ready=!0}}}();h.prototype={setup:function(a,b){for(var c=[],d=a.length;d--;){var e=a[d];e.parentId===b.objectId&&4294967295!==e.objectId&&(e.children=this.setup(a,e),e.parent=b,c.push(e))}return c},update:function(){this.updateNodes(this.root);0<M&&this.updateHW()},updateNodes:function(a){for(var b=0,c=a.children.length;b<c;b++){var d=a.children[b];this.updateNode(d);this.updateNodes(d)}},updateHW:function(){for(var b=0,c=this.bones.length;b<
c;b++){var d=16*b+16;this.hwbones[d+0]=this.bones[b].worldMatrix[0];this.hwbones[d+1]=this.bones[b].worldMatrix[1];this.hwbones[d+2]=this.bones[b].worldMatrix[2];this.hwbones[d+3]=this.bones[b].worldMatrix[3];this.hwbones[d+4]=this.bones[b].worldMatrix[4];this.hwbones[d+5]=this.bones[b].worldMatrix[5];this.hwbones[d+6]=this.bones[b].worldMatrix[6];this.hwbones[d+7]=this.bones[b].worldMatrix[7];this.hwbones[d+8]=this.bones[b].worldMatrix[8];this.hwbones[d+9]=this.bones[b].worldMatrix[9];this.hwbones[d+
10]=this.bones[b].worldMatrix[10];this.hwbones[d+11]=this.bones[b].worldMatrix[11];this.hwbones[d+12]=this.bones[b].worldMatrix[12];this.hwbones[d+13]=this.bones[b].worldMatrix[13];this.hwbones[d+14]=this.bones[b].worldMatrix[14];this.hwbones[d+15]=this.bones[b].worldMatrix[15]}2===M&&(a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this.boneTexture),a.texSubImage2D(a.TEXTURE_2D,0,0,0,4+4*this.bones.length,1,a.RGBA,a.FLOAT,this.hwbones))},updateNode:function(a){var b=a.pivot,c=d(a.tracks.translation,
[0,0,0],this.model),e=d(a.tracks.rotation,[0,0,0,1],this.model),g=d(a.tracks.scaling,[1,1,1],this.model),l=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];(0!==c[0]||0!==c[1]||0!==c[2])&&f.mat4.translate(l,c[0],c[1],c[2]);if(0!==e[0]||0!==e[1]||0!==e[2]||1!==e[3])c=[],f.quaternion.toRotationMatrix4(e,c),f.mat4.translate(l,b[0],b[1],b[2]),f.mat4.multMat(l,c,l),f.mat4.translate(l,-b[0],-b[1],-b[2]);if(1!==g[0]||1!==g[1]||1!==g[2])f.mat4.translate(l,b[0],b[1],b[2]),f.mat4.scale(l,g[0],g[1],g[2]),f.mat4.translate(l,
-b[0],-b[1],-b[2]);4294967295!==a.parent.objectId?f.mat4.multMat(a.parent.worldMatrix,l,a.worldMatrix):a.worldMatrix=l;a.billboarded&&(e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f.mat4.translate(e,b[0],b[1],b[2]),f.mat4.rotate(e,-f.toRad(B[1]+270),0,0,1),f.mat4.rotate(e,f.toRad(B[0]-90),0,1,0),f.mat4.translate(e,-b[0],-b[1],-b[2]),f.mat4.multMat(a.worldMatrix,e,a.worldMatrix))},bind:function(){2===M?(a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this.boneTexture),e.setParameter("u_bones",1),e.setParameter("u_bone_size",
this.boneFraction),e.setParameter("u_pixel_size",this.texelFraction)):1===M&&e.setParameter("u_bones",this.hwbones)}};i.prototype={render:function(){this.shape&&(e.pushMatrix(),e.multMat(this.node.worldMatrix),e.bindWorldMatrix("u_mvp"),this.shape.renderLines(),e.popMatrix())}};j.prototype={setup:function(a){var b,c,d,e,f;a.materialChunk&&(this.materials=a.materialChunk.materials);if(a.geosetChunk){b=a.geosetChunk.geosets;var g=[[],[],[],[]];this.geosets=[];for(c=0,d=b.length;c<d;c++){e=b[c];var j=
this.materials[e.materialId].layers;this.geosets.push(new p(e));for(e=0,f=j.length;e<f;e++){var n=new k(j[e],c,this);g[n.renderOrder].push(n)}}this.layers=g[0].concat(g[1]).concat(g[2]).concat(g[3])}a.sequenceChunk&&(this.sequences=a.sequenceChunk.sequences);a.cameraChunk&&(this.cameras=a.cameraChunk.cameras);a.geosetAnimationChunk&&(this.geosetAnimations=a.geosetAnimationChunk.animations);a.globalSequenceChunk&&(this.globalSequences=a.globalSequenceChunk.sequences);a.textureAnimationChunk&&(this.textureAnimations=
a.textureAnimationChunk.animations);if(a.particleEmitterChunk){b=a.particleEmitterChunk.emitters;this.particleEmitters=[];for(c=0,d=b.length;c<d;c++)this.particleEmitters[c]=new t(b[c],this)}if(a.particleEmitter2Chunk){b=a.particleEmitter2Chunk.emitters;this.particleEmitters2=[];for(c=0,d=b.length;c<d;c++)this.particleEmitters2[c]=new l(b[c],this)}if(a.ribbonEmitterChunk){b=a.ribbonEmitterChunk.emitters;this.ribbonEmitters=[];for(c=0,d=b.length;c<d;c++)this.ribbonEmitters[c]=new v(b[c],this.materials,
this)}if(a.collisionShapeChunk){b=a.collisionShapeChunk.shapes;this.collisionShapes=[];for(c=0,d=b.length;c<d;c++)this.collisionShapes[c]=new i(b[c])}this.skeleton=new h(a,this);this.extent=a.modelChunk.extent.maximum[0]||100},loadTextures:function(a,b,c){function d(){f++;c&&c({lengthComputable:!0,total:l.length,loaded:f+g})}function e(){g++;c&&c({lengthComputable:!0,total:l.length,loaded:f+g})}var f=0,g=0,l=a.textureChunk.textures;this.textures=[];for(var a=0,h=l.length;a<h;a++)this.textures.push(new q(l[a].fileName,
l[a].replaceableId,b,d,e))},updateEmitters:function(a,b){if(a)for(var c=0,d=a.length;c<d;c++)a[c].update(b)},update:function(){var a=!1;this.sequence&&(this.time+=16*G,this.frame+=16*G,a=!0,this.frame>=this.sequence.interval[1]&&(2===this.loopingMode||0===this.loopingMode&&0===this.sequence.flags?this.frame=this.sequence.interval[0]:(this.time-=16*G,this.frame=this.sequence.interval[1]),a=!1));this.skeleton.update();this.updateEmitters(this.particleEmitters,a);this.updateEmitters(this.particleEmitters2,
a);this.updateEmitters(this.ribbonEmitters,a)},render:function(){var b,c,f;if(this.layers&&D){e.bindShader("main");e.bindWorldMatrix("u_mvp");e.setParameter("u_texture",0);for(b=0,c=this.layers.length;b<c;b++){var g=this.layers[b];if(g.shouldRender()&&this.shouldRenderGeoset(g)){var l=this.geosets[g.geosetId],h=[1,1,1,1],v=[0,0];g.setMaterial();e.bindTexture(this.textures[Math.floor(d(g.tracks.textureId,g.textureId,this))].fileName,0);if(this.geosetAnimations)for(var i=this.geosetAnimations.length;i--;)if(f=
this.geosetAnimations[i],f.geosetId===g.geosetId&&(f=d(f.tracks.color,f.color,this),1!==f[0]||1!==f[1]||1!==f[2]))h[0]=f[0],h[1]=f[1],h[2]=f[2];h[3]=d(g.tracks.alpha,g.alpha,this);e.setParameter("u_modifier",h);4294967295!==g.textureAnimationId&&this.textureAnimations&&(f=d(this.textureAnimations[g.textureAnimationId].tracks.translation,[0,0,0],this),v[0]=f[0],v[1]=f[1]);e.setParameter("u_uv_offset",v);0<M?(this.skeleton.bind(),l.renderHW(g.coordId)):l.render(this.skeleton.nodes,g.coordId)}}}a.depthMask(1);
if(!this.spawned&&this.particleEmitters&&D)for(b=0,c=this.particleEmitters.length;b<c;b++)this.particleEmitters[b].render();if(this.ribbonEmitters&&U){a.disable(a.CULL_FACE);e.bindShader("ribbons");e.bindWorldMatrix("u_mvp");e.setParameter("u_texture",0);for(b=0,c=this.ribbonEmitters.length;b<c;b++)this.ribbonEmitters[b].render(this)}if(this.particleEmitters2&&V){a.depthMask(0);a.enable(a.BLEND);a.disable(a.CULL_FACE);e.bindShader("particles");e.bindWorldMatrix("u_mvp");e.setParameter("u_texture",
0);for(b=0,c=this.particleEmitters2.length;b<c;b++)this.particleEmitters2[b].render(this);a.depthMask(1);a.disable(a.BLEND);a.enable(a.CULL_FACE)}if(w&&this.collisionShapes&&S){a.depthMask(1);e.bindShader("white");e.bindWorldMatrix("u_mvp");for(b=0,c=this.collisionShapes.length;b<c;b++)this.collisionShapes[b].render()}a.disable(a.BLEND);a.enable(a.CULL_FACE)},shouldRenderGeoset:function(a){var b,c;if(this.geosetAnimations)for(b=0,c=this.geosetAnimations.length;b<c;b++){var e=this.geosetAnimations[b];
if(e.geosetId===a.geosetId&&e.tracks.alpha)return 0.1<d(e.tracks.alpha,1,this)}return!0},setTeamColor:function(a){for(var a=10>a?"0"+a:""+a,b=0,c=this.textures.length;b<c;b++){var d=this.textures[b],e=d.replaceableId;if(1===e||2===e)d.fileName=d.fileName.replace(/\d\d/,a)}},setAnimation:function(a){this.sequence&&this.sequence===this.sequences[a]?this.frame=this.sequence.interval[0]:(a=f.clamp(a,-1,this.sequences.length-1),-1===a?(this.sequence=null,this.frame=this.time=0):(this.sequence=this.sequences[a],
this.frame=this.sequence.interval[0]))},setAnimationLooping:function(a){this.loopingMode=f.clamp(a,0,2)}};var K={1:"TeamColor/TeamColor00",2:"TeamGlow/TeamGlow00",11:"Cliff/Cliff0",31:"LordaeronTree/LordaeronSummerTree",32:"AshenvaleTree/AshenTree",33:"BarrensTree/BarrensTree",34:"NorthrendTree/NorthTree",35:"Mushroom/MushroomTree",36:"RuinsTree/RuinsTree",37:"OutlandMushroomTree/MushroomTree"};p.prototype={render:function(b,c){for(var d=[],f=[],g=this.positions,l=this.animatedPositions,h=0,v=g.length/
3;h<v;h++){d[0]=d[1]=d[2]=0;f[0]=g[3*h+0];f[1]=g[3*h+1];f[2]=g[3*h+2];for(var i=this.boneNumbers[h],j=0,n=i;j<n;j++){var z=b[this.boneIndices[4*h+j]-1].worldMatrix,K=f[0],C=f[1],p=f[2];d[0]+=K*z[0]+C*z[4]+p*z[8]+z[12];d[1]+=K*z[1]+C*z[5]+p*z[9]+z[13];d[2]+=K*z[2]+C*z[6]+p*z[10]+z[14]}i=1/i;l[3*h+0]=d[0]*i;l[3*h+1]=d[1]*i;l[3*h+2]=d[2]*i}a.bindBuffer(a.ARRAY_BUFFER,this.buffers.vertices);a.bufferSubData(a.ARRAY_BUFFER,this.offsets[0],l);a.vertexAttribPointer(e.getParameter("a_position"),3,a.FLOAT,
!1,12,this.offsets[0]);a.vertexAttribPointer(e.getParameter("a_uv"),2,a.FLOAT,!1,8,this.offsets[1]+c*this.uvSetSize);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.buffers.faces);a.drawElements(a.TRIANGLES,this.faces,a.UNSIGNED_SHORT,0)},renderHW:function(b){a.bindBuffer(a.ARRAY_BUFFER,this.buffers.vertices);a.vertexAttribPointer(e.getParameter("a_position"),3,a.FLOAT,!1,12,this.offsets[0]);a.vertexAttribPointer(e.getParameter("a_uv"),2,a.FLOAT,!1,8,this.offsets[1]+b*this.uvSetSize);a.vertexAttribPointer(e.getParameter("a_bones"),
4,a.FLOAT,!1,16,this.offsets[2]);a.vertexAttribPointer(e.getParameter("a_bone_number"),1,a.FLOAT,!1,4,this.offsets[3]);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.buffers.faces);a.drawElements(a.TRIANGLES,this.faces,a.UNSIGNED_SHORT,0)}};var z={"0":0,1:1,2:2,3:3,4:3,5:3,6:3};k.prototype={setMaterial:function(){switch(this.filterMode){case 1:e.setParameter("u_type",[1,0,0]);a.depthMask(1);a.disable(a.BLEND);break;case 2:e.setParameter("u_type",[0,0,0]);a.depthMask(0);a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,
a.ONE_MINUS_SRC_ALPHA);break;case 3:e.setParameter("u_type",[0,1,0]);a.enable(a.BLEND);a.depthMask(0);a.blendFunc(a.SRC_COLOR,a.ONE);break;case 4:e.setParameter("u_type",[0,0,0]);a.depthMask(0);a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE);break;case 5:case 6:e.setParameter("u_type",[0,0,1]);a.depthMask(0);a.enable(a.BLEND);a.blendFunc(a.SRC_ZERO,a.SRC_COLOR);break;default:e.setParameter("u_type",[0,0,0]),a.depthMask(1),a.disable(a.BLEND)}this.twoSided?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE)},
shouldRender:function(){return 0.1<d(this.tracks.alpha,1,this.model)}};m.prototype={reset:function(a){var b=d(a.tracks.speed,a.initialVelocity,this.model),c=d(a.tracks.latitude,a.latitude,this.model),e=d(a.tracks.longitude,a.longitude,this.model),g=d(a.tracks.lifespan,a.lifespan,this.model);this.alive=!0;this.health=g;f.mat4.multVec3(a.node.worldMatrix,a.node.pivot,this.position);var l=[],h=[],v=[],g=[];f.mat4.makeRotateY(l,f.random(-c,c));f.mat4.makeRotateZ(h,f.random(-e,e));f.mat4.multMat(h,l,v);
f.mat4.multVec3(v,[0,0,1],g);f.vec3.normalize(g,g);e=this.position;c=[e[0],e[1],e[2]];e=[e[0]+g[0],e[1]+g[1],e[2]+g[2]];f.mat4.multVec3(a.node.worldMatrix,c,c);f.mat4.multVec3(a.node.worldMatrix,e,e);f.vec3.subtract(e,c,g);f.vec3.normalize(g,g);f.vec3.scale(g,b,g);this.velocity=g;this.orientation=f.random(0,2*Math.PI)},update:function(a){this.alive&&(a=d(a.tracks.gravity,a.gravity,this.model),this.health-=J*G,this.velocity[2]-=a*J*G,this.position[0]+=this.velocity[0]*J*G,this.position[1]+=this.velocity[1]*
J*G,this.position[2]+=this.velocity[2]*J*G)}};t.prototype={update:function(a){var b,c;this.spawnModel&&this.spawnModel.update();for(b=0,c=this.particles.length;b<c;b++){var e=this.particles[b];e.alive&&(0>=e.health?(e.alive=!1,this.reusables.push(b)):e.update(this))}if(a&&this.shouldRender()&&(this.lastCreation+=1*G,a=d(this.tracks.emissionRate,this.emissionRate,this.model)*J/(1/this.lastCreation),1<=a))for(b=this.lastCreation=0;b<a;b++)0<this.reusables.length&&this.particles[this.reusables.pop()].reset(this)},
render:function(){var a=this.spawnModel;if(a)for(var b=0,c=this.particles.length;b<c;b++){var d=this.particles[b];if(0<d.health){var f=d.position;e.pushMatrix();e.translate(f[0],f[1],f[2]);e.rotate(d.orientation,0,0,1);a.render();e.popMatrix()}}},shouldRender:function(){return 0.1<d(this.tracks.visibility,0,this.model)}};o.prototype={reset:function(a,b){var c=a.node.pivot,e=0.5*d(a.tracks.width,a.width,this.model),g=0.5*d(a.tracks.length,a.length,this.model),l=d(a.tracks.speed,a.speed,this.model),
h=f.toRad(d(a.tracks.latitude,a.latitude,this.model));this.alive=!0;this.health=a.lifespan;this.head=b;f.mat4.multVec3(a.node.worldMatrix,[c[0]+f.random(-e,e),c[1]+f.random(-g,g),c[2]],this.position);this.speed=l+f.random(-a.variation,a.variation);c=[];g=[];l=[];e=[];f.mat4.makeRotateY(c,f.random(-h,h));f.mat4.makeRotateZ(g,f.random(-Math.PI,Math.PI));f.mat4.multMat(g,c,l);f.mat4.multVec3(l,[0,0,1],e);f.vec3.normalize(e,e);c=this.position;h=[c[0],c[1],c[2]];c=[c[0]+e[0],c[1]+e[1],c[2]+e[2]];f.mat4.multVec3(a.node.worldMatrix,
h,h);f.mat4.multVec3(a.node.worldMatrix,c,c);f.vec3.subtract(c,h,e);f.vec3.normalize(e,e);f.vec3.scale(e,this.speed,e);this.velocity=e;this.head||(h=0.5*a.tailLength,this.position[0]-=h*e,this.position[1]-=h*e,this.position[2]-=h*e,this.tailLength=h);this.scale=1;this.column=this.row=0},update:function(a){if(this.alive){var b=d(a.tracks.gravity,a.gravity,this.model);this.health-=J*G;this.velocity[2]-=b*J*G;this.position[0]+=this.velocity[0]*J*G;this.position[1]+=this.velocity[1]*J*G;this.position[2]+=
this.velocity[2]*J*G;var c=0===a.lifespan?0:1-this.health/a.lifespan,e;c<a.time?(e=c/a.time,b=a.segmentScaling[0]+e*(a.segmentScaling[1]-a.segmentScaling[0]),f.vec4.lerp(a.colors[0],a.colors[1],e,this.color)):(e=(c-a.time)/(1-a.time),b=a.segmentScaling[1]+e*(a.segmentScaling[2]-a.segmentScaling[1]),f.vec4.lerp(a.colors[1],a.colors[2],e,this.color));c*=a.numberOfFrames;this.index=0;var g;0!==a.headOrTail&&(c<a.headFrames?(e=a.headInterval[1]-a.headInterval[0]+1,this.index=a.headInterval[0]+(c-0)%e):
c<a.headFrames+a.headDecayFrames?(e=a.headDecayInterval[1]-a.headDecayInterval[0]+1,g=a.headFrames,this.index=a.headDecayInterval[0]+(c-g)%e):c<a.headFrames+a.headDecayFrames+a.tailFrames?(e=a.tailInterval[1]-a.tailInterval[0]+1,g=a.headFrames+a.headDecayFrames,this.index=a.tailInterval[0]+(c-g)%e):c<a.headFrames+a.headDecayFrames+a.tailFrames+a.tailDecayFrames&&(e=a.tailDecayInterval[1]-a.tailDecayInterval[0]+1,g=a.headFrames+a.headDecayFrames+a.tailFrames,this.index=a.tailDecayInterval[0]+(c-g)%
e));this.row=Math.round(1===a.columns?0:this.index/a.columns);this.column=Math.round(1===a.columns?0:this.index%a.columns);this.scale=b}}};l.prototype={update:function(a){var b,c;for(b=0,c=this.particles.length;b<c;b++){var e=this.particles[b];e.alive&&(0>=e.health?(e.alive=!1,this.reusables.push(b)):e.update(this))}if(a&&this.shouldRender()&&(this.lastCreation+=1*G,a=d(this.tracks.emissionRate,this.emissionRate,this.model)*J/(1/this.lastCreation),1<=a))for(b=this.lastCreation=0;b<a;b++)this.head&&
0<this.reusables.length&&this.particles[this.reusables.pop()].reset(this,!0),this.tail&&0<this.reusables.length&&this.particles[this.reusables.pop()].reset(this,!1)},render:function(b){var c=this.data,d=[-1,-1,0],g=[-1,1,0],l=[1,1,0],h=[1,-1,0],v=[1,0,0],i=[0,1,0],j=[0,0,1];if(!this.node.xYQuad){var n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];f.mat4.rotate(n,-f.toRad(B[1]),0,0,1);f.mat4.rotate(n,-f.toRad(B[0]),1,0,0);this.head&&(f.mat4.multVec3(n,d,d),f.mat4.multVec3(n,g,g),f.mat4.multVec3(n,l,l),f.mat4.multVec3(n,
h,h));this.tail&&(f.mat4.multVec3(n,v,v),f.mat4.multVec3(n,i,i),f.mat4.multVec3(n,j,j))}i=0;for(j=this.particles.length;i<j;i++){var z=this.particles[i],n=54*i;if(0<z.health){var K=z.position,C=z.scale,p=this.cellWidth*z.column,q=this.cellHeight*z.row,r=this.cellWidth*(z.column+1),k=this.cellHeight*(z.row+1),m=z.color,s=m[0],t=m[1],W=m[2],m=m[3],o=K[0],u=K[1],K=K[2],x,w,y,E,G,H,F,A,I;if(z.head)x=o+d[0]*C,w=u+d[1]*C,y=K+d[2]*C,E=o+g[0]*C,G=u+g[1]*C,H=K+g[2]*C,F=o+l[0]*C,A=u+l[1]*C,I=K+l[2]*C,o+=h[0]*
C,u+=h[1]*C,C=K+h[2]*C;else{var D=z.tailLength,z=z.velocity;x=D*z[0];w=D*z[1];y=D*z[2];var Ba=o+x,z=u+w,D=K+y,o=o-x,u=u-w,K=K-y;x=Ba-v[0]*C;w=z-v[1]*C;y=D-v[2]*C;E=o-v[0]*C;G=u-v[1]*C;H=K-v[2]*C;F=o+v[0]*C;A=u+v[1]*C;I=K+v[2]*C;o=Ba+v[0]*C;u=z+v[1]*C;C=D+v[2]*C}c[n+0]=x;c[n+1]=w;c[n+2]=y;c[n+3]=p;c[n+4]=q;c[n+5]=s;c[n+6]=t;c[n+7]=W;c[n+8]=m;c[n+9]=E;c[n+10]=G;c[n+11]=H;c[n+12]=p;c[n+13]=k;c[n+14]=s;c[n+15]=t;c[n+16]=W;c[n+17]=m;c[n+18]=F;c[n+19]=A;c[n+20]=I;c[n+21]=r;c[n+22]=k;c[n+23]=s;c[n+24]=t;
c[n+25]=W;c[n+26]=m;c[n+27]=x;c[n+28]=w;c[n+29]=y;c[n+30]=p;c[n+31]=q;c[n+32]=s;c[n+33]=t;c[n+34]=W;c[n+35]=m;c[n+36]=F;c[n+37]=A;c[n+38]=I;c[n+39]=r;c[n+40]=k;c[n+41]=s;c[n+42]=t;c[n+43]=W;c[n+44]=m;c[n+45]=o;c[n+46]=u;c[n+47]=C;c[n+48]=r;c[n+49]=q;c[n+50]=s;c[n+51]=t;c[n+52]=W;c[n+53]=m}else for(p=0;6>p;p++)q=n+9*p,c[q+0]=0,c[q+1]=0,c[q+2]=0}switch(this.filterMode){case 1:a.blendFunc(a.SRC_COLOR,a.ONE);break;case 2:case 3:a.blendFunc(a.SRC_ZERO,a.SRC_COLOR);break;case 4:a.blendFunc(a.SRC_ALPHA,
a.ONE);break;default:a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA)}e.bindTexture(b.textures[this.textureId].fileName,0);a.bindBuffer(a.ARRAY_BUFFER,this.buffer);a.bufferSubData(a.ARRAY_BUFFER,0,this.data);a.vertexAttribPointer(e.getParameter("a_position"),3,a.FLOAT,!1,36,0);a.vertexAttribPointer(e.getParameter("a_uv"),2,a.FLOAT,!1,36,12);a.vertexAttribPointer(e.getParameter("a_color"),4,a.FLOAT,!1,36,20);a.drawArrays(a.TRIANGLES,0,6*this.particles.length)},shouldRender:function(){return 0.1<d(this.tracks.visibility,
1,this.model)}};n.prototype={update:function(a){this.health-=J*G;a=a.gravity*J*J*G;this.p1[2]-=a;this.p2[2]-=a}};v.prototype={update:function(a){for(var b=0,c=this.ribbons.length;b<c;b++)this.ribbons[b].update(this);for(;0<this.ribbons.length&&0>=this.ribbons[0].health;)this.ribbons.shift();if(a&&this.shouldRender()&&(this.lastCreation+=1*G,a=Math.floor(this.emissionRate*J/(1/this.lastCreation)),0<a))for(this.lastCreation=0;a--;)this.ribbons.push(new n(this,this.model))},render:function(){var b,c,
f=Math.min(this.ribbons.length,this.maxRibbons);if(2<f){b=d(this.tracks.textureSlot,0,this.model);var g=(Math.floor(b/this.rows)-1)/this.rows,l=1/f*this.cellWidth,h=g+this.cellHeight,n=this.data;for(b=0,c=f;b<c;b++){var v=10*b,i=this.ribbons[b],j=(f-b)*l,z=j-l,C=i.p2,i=i.p1;n[v+0]=C[0];n[v+1]=C[1];n[v+2]=C[2];n[v+3]=j;n[v+4]=g;n[v+5]=i[0];n[v+6]=i[1];n[v+7]=i[2];n[v+8]=z;n[v+9]=h}a.bindBuffer(a.ARRAY_BUFFER,this.buffer);a.bufferSubData(a.ARRAY_BUFFER,0,this.data);a.vertexAttribPointer(e.getParameter("a_position"),
3,a.FLOAT,!1,20,0);a.vertexAttribPointer(e.getParameter("a_uv"),2,a.FLOAT,!1,20,12);for(b=0,c=this.layers.length;b<c;b++)l=this.layers[b],l.shouldRender()&&(h=[1,1,1,1],g=[0,0],l.setMaterial(),e.bindTexture(r.textures[Math.floor(d(l.tracks.textureId,l.textureId,this.model))].fileName,0),n=d(this.tracks.color,this.color,this.model),v=d(this.tracks.alpha,this.alpha,this.model),h[0]=n[0],h[1]=n[1],h[2]=n[2],h[3]=v,e.setParameter("u_modifier",h),4294967295!==l.textureAnimationId&&this.model.textureAnimations&&
(l=d(this.model.textureAnimations[l.textureAnimationId].tracks.translation,[0,0,0],this.model),g[0]=l[0],g[1]=l[1]),e.setParameter("u_uv_offset",g),e.setParameter("u_type",[0,0,0]),a.drawArrays(a.TRIANGLE_STRIP,0,2*f))}},shouldRender:function(){return 0.1<d(this.tracks.visibility,1,this.model)}};return{Parser:C,Model:j}}(),za=function(){function b(a){this.sd=a}function d(a){var b,c=a.animIds;this.animIds={};for(a=0,b=c.length;a<b;a++)this.animIds[c[a]]=a}function h(a){var c,d,e=a.animIds;this.name=
a.name;this.runsConcurrent=a.runsConcurrent;this.priority=a.priority;this.stsIndex=a.stsIndex;this.animIds={};for(c=0,d=e.length;c<d;c++)this.animIds[e[c]]=c;this.animRefs=a.animRefs;a=a.sd;this.sd=[new b(a[0]),new b(a[1]),new b(a[2]),new b(a[3]),new b(a[4]),new b(a[5]),1,new b(a[7]),new b(a[8]),1,1,new b(a[11]),new b(a[12])]}function i(a,b,c){this.name=a.name;this.stcIndices=a.stcIndices;this.sts=b;this.stc=c}function j(b){var c,e,g=b.sts,K=b.stc,z=b.stg;this.initialReference=b.initialReference;
this.bones=b.bones;this.sequences=b.sequences;this.sts=[];this.stc=[];this.stg=[];for(c=0,e=g.length;c<e;c++)this.sts[c]=new d(g[c]);for(c=0,e=K.length;c<e;c++)this.stc[c]=new h(K[c]);for(c=0,e=z.length;c<e;c++)this.stg[c]=new i(z[c],this.sts,this.stc);this.hwbones=new Float32Array(16*b.bones.length);this.boneTexture=a.createTexture();this.boneTextureSize=4*Math.max(2,f.powerOfTwo(b.bones.length+1));this.texelFraction=1/this.boneTextureSize;this.boneFraction=4*this.texelFraction;a.activeTexture(a.TEXTURE15);
a.bindTexture(a.TEXTURE_2D,this.boneTexture);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.boneTextureSize,1,0,a.RGBA,a.FLOAT,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);for(c=0,e=this.bones.length;c<e;c++)this.bones[c].worldMatrix=[];this.addGlobalAnims();this.update(-1)}function p(a){this.bone=a.bone;this.matrix=a.matrix;var b=a.size,c;0===a.shape?c=e.newCube(-b[0],-b[1],-b[2],b[0],b[1],b[2]):1===a.shape&&(c=e.newSphere(0,
0,0,9,9,b[0]));this.shape=c}function q(b,c,d,e,f){var g,h,i=b.verticesCount,j=b.firstVertexIndex,m=b.firstBoneLookupIndex,p=b.triangleIndicesCount,r=b.firstTriangleIndex,k=new Float32Array(3*i),s=new Float32Array(4*i),t=new Float32Array(2*i*f),o=new Float32Array(4*i),u=new Uint16Array(4*i),x=new Uint8Array(4*i),b=new Uint16Array(3*p);for(g=0;g<i;g++){var w=c[j+g];h=w.position;var y=w.normal,W=w.uvs,B=w.tangent,D=w.boneLookupIndices,w=w.boneWeights;k[3*g+0]=h[0];k[3*g+1]=h[1];k[3*g+2]=h[2];s[4*g+0]=
y[0];s[4*g+1]=y[1];s[4*g+2]=y[2];s[4*g+3]=y[3];for(h=0;h<f;h++)y=W[h],t[2*g*f+2*h+0]=y[0],t[2*g*f+2*h+1]=y[1];o[4*g+0]=B[0];o[4*g+1]=B[1];o[4*g+2]=B[2];o[4*g+3]=B[3];u[4*g+0]=e[m+D[0]];u[4*g+1]=e[m+D[1]];u[4*g+2]=e[m+D[2]];u[4*g+3]=e[m+D[3]];x[4*g+0]=w[0];x[4*g+1]=w[1];x[4*g+2]=w[2];x[4*g+3]=w[3]}for(g=0;g<p;g++)b[g]=d[r+g];c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c);a.bufferData(a.ARRAY_BUFFER,k,a.STATIC_DRAW);d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferData(a.ARRAY_BUFFER,s,
a.STATIC_DRAW);s=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,s);a.bufferData(a.ARRAY_BUFFER,t,a.STATIC_DRAW);t=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,t);a.bufferData(a.ARRAY_BUFFER,o,a.STATIC_DRAW);o=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,o);a.bufferData(a.ARRAY_BUFFER,u,a.STATIC_DRAW);u=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,u);a.bufferData(a.ARRAY_BUFFER,x,a.STATIC_DRAW);x=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,x);a.bufferData(a.ELEMENT_ARRAY_BUFFER,b,a.STATIC_DRAW);
this.buffers={position:c,normal:d,uv:s,tangent:t,bone:o,weight:u,face:x};this.uvSetCount=f;this.triangleIndicesCount=p}function m(a,b,c,d){this.imagePath="";if(a){for(var f=Object.keys(a),g=0,h=f.length;g<h;g++){var i=f[g];this[i]=a[i]}this.model=d;this.type=b;a=a.imagePath.toLowerCase();""!==a&&(this.imagePath=a.toLowerCase(),d=d.texturePaths,d[a]||(d[a]=1,e.newTexture(a,L.mpqFile(a),!0,!0)));this.op=c;c=this.uvSource;d=0;1===c?d=1:9===c?d=2:10===c&&(d=3);this.uvCoordinate=d}}function r(a,b){for(var c=
Object.keys(a),d=0,e=c.length;d<e;d++){var f=c[d];this[f]=a[f]}this.layers=[new m(a.diffuseLayer,"diffuse",2,b),new m(a.decalLayer,"decal",2,b),new m(a.specularLayer,"specular",2,b),new m(a.glossLayer,"gloss",2,b),new m(a.emissiveLayer,"emissive",this.emisBlendType,b),new m(a.emissive2Layer,"emissive2",this.emisMode,b),new m(a.evioLayer,"evio",2,b),new m(a.evioMaskLayer,"evioMask",2,b),new m(a.alphaMaskLayer,"alphaMask",2,b),new m(a.alphaMask2Layer,"alphaMask2",2,b),new m(a.normalLayer,"normal",2,
b),new m(a.heightLayer,"heightMap",2,b),new m(a.lightMapLayer,"lightMap",2,b),new m(a.ambientOcclusionLayer,"ao",2,b)]}function k(a,b){this.setup(a);b&&b({lengthComputable:!0,total:100,loaded:100});this.ready=!0}var o=function(){function a(b){b=ea(b,4);return[2*(b[0]/255)-1,2*(b[1]/255)-1,2*(b[2]/255)-1,2*(b[3]/255)-1]}function b(a){return ea(a,4)}function d(a){return ca(a,2,"Uint16")}function e(a){return{minBorder:s(a),maxBorder:s(a),radius:g(a)}}function f(a,b){var c=new A(a),d=a.index;a.index=
b[c.index].offset;c=x(a,c.entries);a.index=d;return c}function h(a,b,c){var d=new A(a),e=b[d.index],d=a.index;a.index=e.offset;b=new c(a,b,e.version);a.index=d;return b}function i(a,b,c){var d=new A(a),e=b[d.index],f=a.index,g=[];e||(console.log("Error in parseReference"),console.log("Func is: "+c));for(a.index=e.offset;d.entries--;)g.push(new c(a,b,e.version));a.index=f;return g}function j(a,b,c){var d=new A(a),e=b[d.index],f=a.index,g=[];for(a.index=e.offset;d.entries--;)g.push(c(a,b,e.version));
a.index=f;return g}function m(a,b,c){var d=new A(a),e=a.index,f=[];for(a.index=b[d.index].offset;d.entries--;)f.push(new q(a,b,c));a.index=e;return f}function p(a,b,c){var d={};d.version=c;d.name=f(a,b);d.unknown0=y(a);d.unknown1=da(a);d.unknown2=t(a);d.matrix=na(a);d.unknown3=y(a);d.unknown4=y(a);d.unknown5=y(a);0<c&&(d.unknown6=y(a),d.unknown7=y(a));1<c&&(d.unknown8=y(a));return d}function q(a,b,d){this.keys=j(a,b,y);this.flags=c(a);this.biggestKey=c(a);this.values=j(a,b,d)}function k(a,b){this.interpolationType=
t(a);this.animFlags=t(a);this.animId=c(a);this.initValue=b(a);this.nullValue=b(a);this.unknown0=y(a)}function r(a){this.shape=c(a);this.bone=da(a);this.unknown0=t(a);this.matrix=na(a);this.unknown1=c(a);this.unknown2=c(a);this.unknown3=c(a);this.unknown4=c(a);this.unknown5=c(a);this.unknown6=c(a);this.size=s(a)}function o(a,d,e){this.version=e;this.unknown0=c(a);this.imagePath=f(a,d);this.color=new k(a,b);this.flags=c(a);this.uvSource=c(a);this.colorChannels=c(a);this.rgbMultiply=new k(a,g);this.rgbAdd=
new k(a,g);this.unknown1=c(a);this.unknown2=y(a);this.unknown3=c(a);this.replaceableChannel=c(a);this.unknown4=y(a);this.unknown5=c(a);this.unknown6=c(a);this.unknown7=new k(a,c);this.unknown8=new k(a,ja);this.flipBook=new k(a,da);this.uvOffset=new k(a,ja);this.uvAngle=new k(a,s);this.uvTiling=new k(a,ja);this.unknown9=new k(a,c);this.unknown10=new k(a,g);this.brightness=new k(a,g);this.unknown11=y(a);this.fresnelFlags=c(a);this.fresnelStrength=g(a);this.fresnelStart=g(a);this.triPlannarOffset=s(a);
this.triPlannarScale=s(a)}function u(a,b){this.name=f(a,b);this.creepLayer=h(a,b,o)}function w(a,b,c){this.version=c}function W(a,b,d){this.version=d;this.name=f(a,b);this.unknown0=c(a);this.unknown1=c(a);this.volumeDensity=new k(a,g);this.colorDefiningLayer=h(a,b,o);this.unknown2=h(a,b,o);this.unknown3=h(a,b,o);this.unknown4=c(a);this.unknown5=c(a)}function B(a,b,c){this.version=c;this.name=f(a,b);this.terrainLayer=h(a,b,o)}function D(a,b,d){this.version=d;this.materialReferenceIndex=c(a);this.alphaFactor=
new k(a,g)}function E(a,b,d){this.version=d;this.name=f(a,b);this.unknown0=c(a);this.sections=i(a,b,D)}function F(a,b,d){this.version=d;this.name=f(a,b);this.unknown0=c(a);this.strengthFactor=new k(a,g);this.normalLayer=h(a,b,o);this.strengthLayer=h(a,b,o);this.flags=c(a);this.priority=y(a)}function G(a,b,d){this.name=f(a,b);this.specialFlags=c(a);this.flags=c(a);this.blendMode=c(a);this.priority=y(a);this.unknown0=c(a);this.specularity=g(a);this.depthBlend=g(a);this.alphaTestThreshold=aa(a);this.unknown1=
aa(a);this.unknown2=aa(a);this.unknown3=aa(a);this.specMult=g(a);this.emisMult=g(a);this.diffuseLayer=h(a,b,o);this.decalLayer=h(a,b,o);this.specularLayer=h(a,b,o);15<d&&(this.glossLayer=h(a,b,o));this.emissiveLayer=h(a,b,o);this.emissive2Layer=h(a,b,o);this.evioLayer=h(a,b,o);this.evioMaskLayer=h(a,b,o);this.alphaMaskLayer=h(a,b,o);this.alphaMask2Layer=h(a,b,o);this.normalLayer=h(a,b,o);this.heightLayer=h(a,b,o);this.lightMapLayer=h(a,b,o);this.ambientOcclusionLayer=h(a,b,o);this.unknown4=c(a);this.layerBlendType=
c(a);this.emisBlendType=c(a);this.emisMode=c(a);this.specType=c(a);this.unknown5=new k(a,c);this.unknown6=new k(a,c)}function H(a){this.materialType=c(a);this.materialIndex=c(a)}function I(a,b,d){this.version=d;this.bone=c(a);this.name=f(a,b);this.fieldOfView=new k(a,g);this.unknown0=c(a);this.farClip=new k(a,g);this.nearClip=new k(a,g);this.clip2=new k(a,g);this.focalDepth=new k(a,g);this.falloffStart=new k(a,g);this.falloffEnd=new k(a,g);this.depthOfField=new k(a,g)}function J(a,b,d){this.version=
d;this.type=aa(a);this.unknown0=aa(a);this.bone=da(a);this.flags=c(a);this.unknown1=c(a);this.unknown2=y(a);this.lightColor=new k(a,s);this.lightIntensity=new k(a,g);this.specularColor=new k(a,s);this.specularIntensity=new k(a,g);this.attenuationFar=new k(a,g);this.unknown3=g(a);this.attenuationNear=new k(a,g);this.hotSpot=new k(a,g);this.falloff=new k(a,g)}function L(a){this.unknown0=c(a);this.boundings=new k(a,e)}function M(a){this.unknown0=c(a);this.regionIndex=t(a);this.unknown1=c(a);this.materialReferenceIndex=
t(a);this.unknown2=t(a)}function N(a){this.unknown0=c(a);this.unknown1=c(a);this.firstVertexIndex=c(a);this.verticesCount=c(a);this.firstTriangleIndex=c(a);this.triangleIndicesCount=c(a);this.bonesCount=t(a);this.firstBoneLookupIndex=t(a);this.boneLookupIndicesCount=t(a);this.unknown2=t(a);this.boneWeightPairsCount=aa(a);this.unknown3=aa(a);this.rootBoneIndex=t(a)}function O(a,b,d){this.version=d;this.triangles=j(a,b,t);this.regions=i(a,b,N);this.batches=i(a,b,M);this.MSEC=i(a,b,L);this.unknown0=
c(a)}function P(b,c){this.position=s(b);this.boneWeights=ea(b,4);this.boneLookupIndices=ea(b,4);this.normal=a(b);for(var d=c,e=[];d--;){var f=ca(b,2,"Int16");e.push([f[0]/2048,f[1]/2048])}this.uvs=e;this.tangent=a(b)}function Q(a,b,d){this.version=d;this.unknown0=y(a);this.name=f(a,b);this.flags=c(a);this.parent=da(a);this.unknown1=t(a);this.location=new k(a,s);this.rotation=new k(a,ka);this.scale=new k(a,s);this.visibility=new k(a,c)}function R(a,b,d){this.version=d;this.animIds=j(a,b,c);this.unknown0=
y(a);this.unknown1=y(a);this.unknown2=y(a);this.unknown3=da(a);this.unknown4=t(a)}function S(a,b,d){this.version=d;this.name=f(a,b);this.stcIndices=j(a,b,c)}function T(a,h,l){this.version=l;this.name=f(a,h);this.runsConcurrent=t(a);this.priority=t(a);this.stsIndex=t(a);this.stsIndexCopy=t(a);this.animIds=j(a,h,c);this.animRefs=j(a,h,d);this.unknown0=c(a);this.sd=[m(a,h,p),m(a,h,ja),m(a,h,s),m(a,h,ka),m(a,h,b),m(a,h,g),new A(a),m(a,h,da),m(a,h,t),new A(a),new A(a),m(a,h,c),m(a,h,e)]}function U(a,b,
d){this.version=d;this.unknown0=y(a);this.unknown1=y(a);this.name=f(a,b);this.animationStart=c(a);this.animationEnd=c(a);this.movementSpeed=g(a);this.flags=c(a);this.frequency=c(a);this.unknown2=c(a);this.unknown3=c(a);this.unknown4=c(a);2>d&&(this.unknown5=c(a));this.boundingSphere=e(a);this.unknown6=c(a);this.unknown7=c(a);this.unknown8=c(a)}function V(a,b,d){this.version=d;this.name=f(a,b);this.flags=c(a);this.sequences=i(a,b,U);this.stc=i(a,b,T);this.stg=i(a,b,S);this.unknown0=g(a);this.unknown1=
g(a);this.unknown2=g(a);this.unknown3=g(a);this.sts=i(a,b,R);this.bones=i(a,b,Q);this.skinBones=c(a);var h=c(a),l=1;h&1048576?l=4:h&524288?l=3:h&262144&&(l=2);this.vertexFlags=h;var h=this.uvSetCount=l,v=new A(a),l=a.index,n=[];a.index=b[v.index].offset;for(v=v.entries/(28+4*h);v--;)n.push(new P(a,h));a.index=l;this.vertices=n;this.divisions=i(a,b,O);this.boneLookup=j(a,b,t);this.boundings=e(a);this.unknown4To19=Z(a,16);this.attachmentPoints=new A(a);this.attachmentPointAddons=new A(a);this.ligts=
i(a,b,J);this.shbx=new A(a);this.cameras=i(a,b,I);this.unknown20=new A(a);this.materialMaps=i(a,b,H);this.materials=[i(a,b,G),i(a,b,F),i(a,b,E),i(a,b,B),i(a,b,W),i(a,b,w),i(a,b,u)];24<d&&(this.unknown21=new A(a));25<d&&(this.unknown22=new A(a));this.particleEmitters=new A(a);this.particleEmitterCopies=new A(a);this.ribbonEmitters=new A(a);this.projections=new A(a);this.forces=new A(a);this.warps=new A(a);this.unknown23=new A(a);this.rigidBodies=new A(a);this.unknown24=new A(a);this.physicsJoints=
new A(a);this.unknown25=new A(a);this.ikjt=new A(a);this.unknown26=new A(a);24<d&&(this.unknown27=new A(a));this.patu=new A(a);this.trgd=new A(a);this.initialReference=j(a,b,na);this.tightHitTest=new r(a);this.fuzzyHitTestObjects=i(a,b,r);this.attachmentVolumes=new A(a);this.attachmentVolumesAddon0=new A(a);this.attachmentVolumesAddon1=new A(a);this.bbsc=new A(a);this.tmd=new A(a);this.unknown28=c(a);this.unknown29=new A(a)}function A(a){this.entries=c(a);this.index=c(a);this.flags=c(a)}function X(a){this.tag=
x(a,4);this.offset=c(a);this.entries=c(a);this.version=c(a)}function Y(a){this.indexOffset=c(a);this.entries=c(a);this.modelHeader=new A(a)}return function(a){if("43DM"===x(a,4)){var b=new Y(a);a.index=b.indexOffset;for(var c=[],d=0;d<b.entries;d++)c[d]=new X(a);b=c[b.modelHeader.index];a.index=b.offset;return new V(a,c,b.version)}return null}}();b.prototype={getValue:function(a,b,c,d){a=this.sd[a];1===d&&(c&=a.biggestKey);var d=a.keys,a=a.values,e=this.getInterval(d,c),g=e[0],e=e[1],h=d.length;if(g===
h)return e===h?b.initValue:a[e];if(e===h||g>=e)return a[g];c=f.clamp((c-d[g])/(d[e]-d[g]),0,1);return("number"===typeof a[g]?f.interpolator.scalar:3===a[g].length?f.interpolator.vector:f.interpolator.quaternion)(a[g],0,0,a[e],c,b.interpolationType)},getInterval:function(a,b){for(var c=a.length,d=0;d!==a.length&&b>a[d];)c=d,d++;return[c,d]}};d.prototype={hasData:function(a){return!!this.animIds[a.animId]}};h.prototype={getValue:function(a,b){var c=this.animRefs[this.animIds[a.animId]];return c?this.sd[c[1]].getValue(c[0],
a,b,this.runsConcurrent):a.initValue}};i.prototype={getValue:function(a,b){var c,d,e=this.stcIndices;for(c=0,d=e.length;c<d;c++){var f=this.stc[e[c]];if(this.sts[f.stsIndex].hasData(a))return f.getValue(a,b)}return a.initValue}};j.prototype={addGlobalAnims:function(){var a,b,c,d,e,f=this.stg;for(a=0,b=f.length;a<b;a++){var g=f[a],h=g.name.toLowerCase();"glbirth"===h?c=g:"glstand"===h?d=g:"gldeath"===h&&(e=g)}for(a=0,b=f.length;a<b;a++)g=f[a],h=g.name.toLowerCase(),"glbirth"!==h&&"glstand"!==h&&"gldeath"!==
h&&(-1!==h.indexOf("birth")&&c?g.stcIndices=g.stcIndices.concat(c.stcIndices):-1!==h.indexOf("death")&&e?g.stcIndices=g.stcIndices.concat(e.stcIndices):d&&(g.stcIndices=g.stcIndices.concat(d.stcIndices)))},update:function(a,b){for(var c=0,d=this.bones.length;c<d;c++)this.updateBone(this.bones[c],a,b);this.updateHW(a)},updateHW:function(b){for(var c=this.bones,d=this.hwbones,e=this.initialReference,g=0,h=c.length;g<h;g++){var i=16*g,j=[];-1!==b?f.mat4.multMat(c[g].worldMatrix,e[g],j):j=[1,0,0,0,0,
1,0,0,0,0,1,0,0,0,0,1];d[i+0]=j[0];d[i+1]=j[1];d[i+2]=j[2];d[i+3]=j[3];d[i+4]=j[4];d[i+5]=j[5];d[i+6]=j[6];d[i+7]=j[7];d[i+8]=j[8];d[i+9]=j[9];d[i+10]=j[10];d[i+11]=j[11];d[i+12]=j[12];d[i+13]=j[13];d[i+14]=j[14];d[i+15]=j[15]}a.activeTexture(a.TEXTURE15);a.bindTexture(a.TEXTURE_2D,this.boneTexture);a.texSubImage2D(a.TEXTURE_2D,0,0,0,4*c.length,1,a.RGBA,a.FLOAT,d)},getValue:function(a,b,c){return-1!==b?this.stg[b].getValue(a,c):a.initValue},updateBone:function(a,b,c){var d=[1,0,0,0,0,1,0,0,0,0,1,
0,0,0,0,1],e=this.getValue(a.location,b,c),g=this.getValue(a.scale,b,c),b=this.getValue(a.rotation,b,c);(0!==e[0]||0!==e[1]||0!==e[2])&&f.mat4.translate(d,e[0],e[1],e[2]);(1!==g[0]||1!==g[1]||1!==g[2])&&f.mat4.scale(d,g[0],g[1],g[2]);(0!==b[0]||0!==b[1]||0!==b[2]||1!==b[3])&&f.mat4.rotateQ(d,b);-1!==a.parent?f.mat4.multMat(this.bones[a.parent].worldMatrix,d,a.worldMatrix):a.worldMatrix=d},bind:function(){e.setParameter("u_bones",15);e.setParameter("u_bone_size",this.boneFraction);e.setParameter("u_pixel_size",
this.texelFraction);a.activeTexture(a.TEXTURE15);a.bindTexture(a.TEXTURE_2D,this.boneTexture)}};p.prototype={render:function(){this.shape&&this.shape.renderLines()}};q.prototype={render:function(){var b=this.buffers,c=this.uvSetCount;a.bindBuffer(a.ARRAY_BUFFER,b.position);a.vertexAttribPointer(e.getParameter("a_position"),3,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,b.normal);a.vertexAttribPointer(e.getParameter("a_normal"),4,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,b.uv);for(var d=0;d<c;d++)a.vertexAttribPointer(e.getParameter("a_uv"+
d),2,a.FLOAT,!1,8*c,8*d);a.bindBuffer(a.ARRAY_BUFFER,b.tangent);a.vertexAttribPointer(e.getParameter("a_tangent"),4,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,b.bone);a.vertexAttribPointer(e.getParameter("a_bones"),4,a.UNSIGNED_SHORT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,b.weight);a.vertexAttribPointer(e.getParameter("a_weights"),4,a.UNSIGNED_BYTE,!0,0,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.face);a.drawElements(a.TRIANGLES,this.triangleIndicesCount,a.UNSIGNED_SHORT,0)}};m.prototype={bind:function(a){var b=
this.imagePath;if(""!==b&&e.textureReady(b)){var c=this.type,d="u_"+c,f=d+"LayerSettings.";e.setParameter(d+"Map",a);e.bindTexture(b,a);e.setParameter(f+"enabled",1);e.setParameter(f+"op",this.op);e.setParameter(f+"channels",this.colorChannels);"diffuse"==c?e.setParameter(f+"teamColorMode",1):e.setParameter(f+"teamColorMode",0);e.setParameter(f+"multAddAlpha",[this.model.getValue(this.rgbMultiply),this.model.getValue(this.rgbAdd),0]);e.setParameter(f+"useAlphaFactor",0);e.setParameter(f+"invert",
this.flags&16);e.setParameter(f+"multColor",0);e.setParameter(f+"addColor",0);e.setParameter(f+"clampResult",this.flags&32);e.setParameter(f+"useConstantColor",this.flags&&1024);e.setParameter(f+"constantColor",this.model.getValue(this.color));e.setParameter(f+"uvSource",this.uvSource);e.setParameter(f+"uvCoordinate",this.uvCoordinate)}else e.setParameter(f+"enabled",0)},unbind:function(){e.setParameter("u_"+this.type+"LayerSettings.enabled",0)}};r.prototype={bindCommon:function(){1===this.blendMode?
(a.enable(a.BLEND),a.blendFunc(a.ONE,a.ONE)):2===this.blendMode?(a.enable(a.BLEND),a.blendFunc(a.ONE,a.ONE)):a.disable(a.BLEND);this.flags&8?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE)},bind:function(){this.bindCommon();e.setParameter("u_specularity",this.specularity);e.setParameter("u_specMult",this.specMult);e.setParameter("u_emisMult",this.emisMult);e.setParameter("u_lightAmbient",[0.02,0.02,0.02,0]);for(var a=0;14>a;a++)this.layers[a].bind(a+1)},unbind:function(){a.disable(a.BLEND);a.enable(a.CULL_FACE);
for(var b=0;14>b;b++)this.layers[b].unbind()},bindDiffuse:function(){this.bindCommon();this.layers[0].bind(1)},bindSpecular:function(){this.bindCommon();e.setParameter("u_specularity",this.specularity);e.setParameter("u_specMult",this.specMult);this.layers[2].bind(3)},bindNormalMap:function(){this.bindCommon();this.layers[10].bind(11)},bindEmissive:function(){this.bindCommon();e.setParameter("u_emisMult",this.emisMult);this.layers[4].bind(5);this.layers[5].bind(6)},bindDecal:function(){this.bindCommon();
this.layers[1].bind(2)}};k.prototype={addMaterial:function(a,b,c){a=this.materials[a];a[b]=a[b]||new r(c,this);return a[b]},setup:function(a){function b(a,c){a=a.material.priority;c=c.material.priority;return a<c?1:a==c?0:-1}var c,d,e=a.divisions[0],f=a.uvSetCount,g=e.regions;this.uvSetCount=f;this.regions=[];for(c=0,d=g.length;c<d;c++)this.regions.push(new q(g[c],a.vertices,e.triangles,a.boneLookup,f));this.batches=[];this.materials=[[]];this.texturePaths={};var g=a.materialMaps,h=a.materials,f=
[];for(c=0,d=e.batches.length;c<d;c++){var i=e.batches[c],k=i.regionIndex,i=g[i.materialReferenceIndex];1===i.materialType&&(k=this.regions[k],i=this.addMaterial(0,i.materialIndex,h[0][i.materialIndex]),f.push({region:k,material:i}))}e=[[],[],[],[],[],[]];for(c=0,d=f.length;c<d;c++)e[f[c].material.blendMode].push(f[c]);for(c=0;6>c;c++)e[c].sort(b);this.batches=e[0].concat(e[1]).concat(e[2]).concat(e[3]).concat(e[4]).concat(e[5]);this.skeleton=new j(a);if(0<a.fuzzyHitTestObjects.length){this.fuzzyHitTestObjects=
[];for(c=0,d=a.fuzzyHitTestObjects.length;c<d;c++)this.fuzzyHitTestObjects[c]=new p(a.fuzzyHitTestObjects[c])}this.teamId=this.loopingMode=this.frame=0;this.sequences=a.sequences;this.sequenceId=-1;this.extent=a.tightHitTest.size[0]||2},update:function(){var a=this.sequenceId;if(-1!==a){var b=this.sequences[a];this.frame+=1E3*J*G;if(this.frame>b.animationEnd&&(0===this.loopingMode&&!(b.flags&1)||2===this.loopingMode))this.frame=0;this.skeleton.update(a,this.frame)}},getValue:function(a){return this.skeleton.getValue(a,
this.sequenceId,this.frame)},render:function(){var b=xa[this.teamId];e.bindShader(E);e.bindWorldMatrix("u_mvp");e.bindViewMatrix("u_mv");e.setParameter("u_teamColor",[b[0]/255,b[1]/255,b[2]/255]);e.setParameter("u_eyePos",$);e.setParameter("u_lightPos",ha);this.skeleton.bind();for(var b=0,c=this.batches.length;b<c;b++){var d=this.batches[b],f=d.region,d=d.material;"standard"===E?d.bind():"diffuse"===E?d.bindDiffuse():"normalmap"===E||"unshaded_normalmap"===E?d.bindNormalMap():"specular"===E?d.bindSpecular():
"specular_normalmap"===E?(d.bindSpecular(),d.bindNormalMap()):"emissive"===E?d.bindEmissive():"decal"===E&&d.bindDecal();f.render();d.unbind()}if(w&&this.fuzzyHitTestObjects&&S){a.depthMask(1);e.bindShader("white");for(b=0,c=this.fuzzyHitTestObjects.length;b<c;b++)f=this.fuzzyHitTestObjects[b],e.pushMatrix(),e.multMat(this.skeleton.bones[f.bone].worldMatrix),e.multMat(f.matrix),e.bindWorldMatrix("u_mvp"),e.popMatrix(),f.render()}},setTeamColor:function(a){this.teamId=f.clamp(a,0,16)},setAnimation:function(a){a=
f.clamp(a,-1,this.sequences.length-1);this.frame=0;this.sequenceId=a;-1===a&&this.skeleton.update(-1)},setAnimationLooping:function(a){this.loopingMode=f.clamp(a,0,2)}};return{Parser:o,Model:k}}();pa&&""!==pa?(p({status:"Downloading the model file"}),fa(pa,!0,b,T,p)):qa&&""!==qa?(p({status:"Downloading the model file"}),fa(L.mpqFile(qa),!0,b,T,p)):oa&&""!==oa?(p({status:"Downloading the model data file"}),fa(L.header(oa),!1,d,T,p)):console.log("No input file");e.viewSize(H.width,H.height);e.setPerspective(45,
H.width/H.height,0.1,5E4);R=e.newShader("world",N.vsworld,u+N.psworld);S=e.newShader("white",N.vswhite,u+N.pswhite);e.newTexture("grass","http://www.hiveworkshop.com/model_viewer/images/grass.png");e.newTexture("water","http://www.hiveworkshop.com/model_viewer/images/water.png");e.newTexture("bedrock","http://www.hiveworkshop.com/model_viewer/images/bedrock.png");e.newTexture("sky",L.mpqFile("Environment/Sky/LordaeronSummerSky/LordaeronSummerSky.blp"));sa=e.newRectangle(0,0,-1,300,300,6);o=e.newRectangle(0,
0,-33,300,300,6);wa=e.newSphere(0,0,0,5,10,2E4);var Aa=!0;j();Ca(function(){var a=va();Aa=!(a&&document[a])});return{getCameras:function(){return r&&r.cameras?r.cameras:[]},getCamera:function(){return I},setCamera:function(a){r&&(I=a,r.cameras&&-1<a&&a<r.cameras.length&&(ba=r.cameras[a]))},resetCamera:k,getAnimations:function(){return r&&r.sequences?r.sequences:[]},playAnimation:function(a){r&&r.setAnimation(a)},stopAnimation:function(){r&&r.setAnimation(0)},setAnimationSpeed:function(a){G=a},setLoopingMode:function(a){r&&
r.setAnimationLooping(a)},setTeamColor:function(a){return r?(r.setTeamColor(a),xa[a]):[0,0,0]},setWorld:function(a){P=a},showLights:function(){},showShapes:function(a){w=a},resize:function(a,b){e.viewSize(a,b);e.setPerspective(45,a/b,0.1,5E4)},move:function(a,b){-1===I&&(2===F&&(a*=0.01,b*=0.01),i[0]+=a,i[1]-=b)},zoom:function(a){-1===I&&(i[2]=f.clamp(i[2]*a,Q[0],Q[1]))},rotate:function(a,b){-1===I&&(B[1]+=a,B[0]+=b)}}}})();
}());