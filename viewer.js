// Copyright (c) 2013 Chananya Freiman (aka GhostWolf)
(function(){"use strict";(function(){function ua(c){this.buffer=c;this.index=0;this.dataview=new DataView(this.buffer);this.size=c.byteLength}function v(c,f){var g=[];c.size-c.index<f&&(f=c.size-c.index);for(var i=0;i<f;i++)g[i]=String.fromCharCode(""+c.dataview.getUint8(c.index+i));c.index+=f;return g.join("").replace(/\0/g,"")}function va(c,f){var g=[];c.size-c.index<f&&(f=c.size-c.index);for(var i=0;i<f;i++)g[i]=String.fromCharCode(""+c.dataview.getUint8(c.index+i));return g.join("").replace(/\0/g,"")}function T(c,f){var g=
c.dataview["get"+f](c.index,!0);c.index+=la[f];return g}function ba(c,f,g){for(var i=[],q=0;q<f;q++)i[q]=T(c,g);return i}function ma(c,f,g,i){for(var q=[],o=0;o<f;o++)q[o]=ba(c,g,i);return q}function ca(c){return T(c,"Int16")}function w(c){return T(c,"Int32")}function aa(c){return T(c,"Uint8")}function x(c){return T(c,"Uint16")}function c(c){return T(c,"Uint32")}function g(c){return T(c,"Float32")}function ea(c,f){return ba(c,f,"Uint8")}function X(c,f){return ba(c,f,"Uint32")}function Z(c,f){return ba(c,
f,"Float32")}function ja(c){return Z(c,2)}function s(c){return Z(c,3)}function ka(c){return Z(c,4)}function na(c){return Z(c,16)}function wa(){var c=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var f=0;f<c.length;f++){var g=c[f]+"Hidden";if(g in document)return g}return null}function Ca(c){var f=wa();f&&document.addEventListener(f.substr(0,f.length-6)+"visibilitychange",c,!1)}function fa(c,f,g,i,q){var o=new XMLHttpRequest;g&&o.addEventListener("load",g,!1);i&&o.addEventListener("error",
i,!1);q&&o.addEventListener("progress",q,!1);o.open("GET",c,!0);f&&(o.responseType="arraybuffer");o.send()}function Da(c,f,g){"mousewheel"===f&&c.addEventListener("DOMMouseScroll",g,!1);c.addEventListener(f,g,!1)}function Ea(c){function g(b,a){var d=String.hashCode(b);Y[d]||(Y[d]=new B(b,a));return Y[d]}function B(a,d){var h=b.createShader(d);this.source=a;this.type=d;this.id=h;b.shaderSource(h,a);b.compileShader(h);b.getShaderParameter(h,b.COMPILE_STATUS)?this.ready=!0:(console.warn(b.getShaderInfoLog(h)),
console.log(a))}function i(a,d){var h=b.createProgram();this.vertexUnit=a;this.fragmentUnit=d;this.id=h;b.attachShader(h,a.id);b.attachShader(h,d.id);b.linkProgram(h);b.getProgramParameter(h,b.LINK_STATUS)?(this.uniforms=this.getParameters("Uniform","UNIFORMS"),this.attribs=this.getParameters("Attrib","ATTRIBUTES"),this.ready=!0):console.warn(b.getProgramInfoLog(h))}function q(a,d,h,e,c,k){y&&b.vertexAttribPointer(y.getParameter(a)[0],d,h,e,c,k)}function o(a,d,h){var e=b.createTexture();b.bindTexture(b.TEXTURE_2D,
e);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,d?b.CLAMP_TO_EDGE:b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,h?b.CLAMP_TO_EDGE:b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_LINEAR);b.generateMipmap(b.TEXTURE_2D);b.bindTexture(b.TEXTURE_2D,null);return e}function s(b,a,d,h,e,c){this.name=b;if("string"===typeof a){this.image=new Image;var k=
this;this.image.onload=function(){k.id=o(this,d,h);k.ready=!0;da[b]=1;"function"===typeof e&&e(b)};this.image.onerror=function(){console.log("Failed to load "+b);"function"===typeof c&&c(b)};this.image.src=a}else this.image=a,this.id=o(a,d,h),this.ready=!0,da[b]=1,"function"===typeof e&&e(b)}function a(a,d,h,e,c){var c=c.target.response,k=new Int32Array(c,0,31);if(542327876===k[0]){var j=k[2],f=k[3],g=k[4],H=k[7],i=k[21],k=k[1]+4,r,m;827611204===i?(r=8,m=I.COMPRESSED_RGBA_S3TC_DXT1_EXT):861165636===
i?(r=16,m=I.COMPRESSED_RGBA_S3TC_DXT3_EXT):894720068===i&&(r=16,m=I.COMPRESSED_RGBA_S3TC_DXT5_EXT);if(m){j=Math.max(1,j&131072?H:0);this.id=b.createTexture();b.bindTexture(b.TEXTURE_2D,this.id);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,d?b.CLAMP_TO_EDGE:b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,h?b.CLAMP_TO_EDGE:b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);for(d=0;d<j;d++)2<=g&&2<=f&&(h=Math.max(4,
g)/4*Math.max(4,f)/4*r,H=new Uint8Array(c,k,h),b.compressedTexImage2D(b.TEXTURE_2D,d,m,g,f,0,H),k+=h,g*=0.5,f*=0.5);b.bindTexture(b.TEXTURE_2D,null);this.ready=!0;da[a]=1;"function"===typeof e&&e(a)}else console.warn(a+" is using a compression type that is not supported (supported types: DXT1, DXT3, DXT5)"),"function"===typeof onerror&&onerror(a)}else console.warn(a+" is not a valid DDS file"),"function"===typeof onerror&&onerror(a)}function d(b,a,d){console.warn("Failed to load "+b);"function"===
typeof a&&a(b,d)}function h(b,h,e,c,k,j){this.name=b;console.log("Loading "+b);I?fa(h,!0,a.bind(this,b,e,c,k),d.bind(this,b,j)):(console.warn("Didn't load "+b+" because your WebGL context does not support compressed texture formats"),"function"===typeof j&&j(b))}function k(b,a,d,e,c,k){if(p[b])"function"===typeof c&&c(b);else{var j=V.exec(b)[1]||V.exec(a)[1];p[b]=j&&"dds"===j.toLowerCase()?new h(b,a,d,e,c,k):new s(b,a,d,e,c,k)}return p[b]}function j(a,d,h,e,c,k){k=k||1;this.buffer=b.createBuffer();
this.data=new Float32Array([a-e,d-c,h,0,1*k,a+e,d-c,h,1*k,1*k,a-e,d+c,h,0,0,a+e,d+c,h,1*k,0]);b.bindBuffer(b.ARRAY_BUFFER,this.buffer);b.bufferData(b.ARRAY_BUFFER,this.data,b.STATIC_DRAW)}function H(a,d,h,e,c,k){var j=[],f=[],g,H;for(g=0;g<=e;g++){H=g*Math.PI/e;var i=Math.sin(H),r=Math.cos(H);for(H=0;H<=c;H++){var m=2*H*Math.PI/c,o=Math.sin(m),m=Math.cos(m)*i,q=r,o=o*i,$=1-H/c,M=g/e;j.push(a+m*k);j.push(d+q*k);j.push(h+o*k);j.push($);j.push(M)}}for(g=0;g<e;g++)for(H=0;H<c;H++)a=g*(c+1)+H,d=a+c+1,
f.push(a),f.push(d),f.push(a+1),f.push(d),f.push(d+1),f.push(a+1);this.vertexArray=new Float32Array(j);this.indexArray=new Uint16Array(f);this.vertexBuffer=b.createBuffer();this.indexBuffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,this.vertexBuffer);b.bufferData(b.ARRAY_BUFFER,this.vertexArray,b.STATIC_DRAW);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indexBuffer);b.bufferData(b.ELEMENT_ARRAY_BUFFER,this.indexArray,b.STATIC_DRAW)}function e(a,d,h,e,c,k){this.buffer=b.createBuffer();this.data=new Float32Array([a,
c,h,a,c,k,a,c,k,e,c,k,e,c,k,e,c,h,e,c,h,a,c,h,a,d,h,a,d,k,a,d,k,e,d,k,e,d,k,e,d,h,e,d,h,a,d,h,a,d,k,a,c,k,a,c,h,a,d,h,e,d,k,e,c,k,e,c,h,e,d,h]);b.bindBuffer(b.ARRAY_BUFFER,this.buffer);b.bufferData(b.ARRAY_BUFFER,this.data,b.STATIC_DRAW)}for(var b,$=["webgl","experimental-webgl","webkit-3d","moz-webgl"],ha=0,M=$.length;ha<M;++ha){try{b=c.getContext($[ha],{antialias:!0,alpha:!1})}catch(v){}if(b)break}if(b){var r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],K=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],w=[],x=[],p={},da=
{},Y={},O={},P={},y,D="",E=[],t={};t[b.FLOAT]="1f";t[b.FLOAT_VEC2]="2fv";t[b.FLOAT_VEC3]="3fv";t[b.FLOAT_VEC4]="4fv";t[b.INT]="1i";t[b.INT_VEC2]="2iv";t[b.INT_VEC3]="3iv";t[b.INT_VEC4]="4iv";t[b.BOOL]="1f";t[b.BOOL_VEC2]="2fv";t[b.BOOL_VEC3]="3fv";t[b.BOOL_VEC4]="4fv";t[b.FLOAT_MAT2]="Matrix2fv";t[b.FLOAT_MAT3]="Matrix3fv";t[b.FLOAT_MAT4]="Matrix4fv";t[b.SAMPLER_2D]="1i";t[b.SAMPLER_CUBE]="1i";var $=b.getExtension("OES_texture_float"),I=b.getExtension("WEBGL_compressed_texture_s3tc");b.getExtension("WEBGL_depth_texture");
b.getExtension("WEBGL_draw_buffers");b.viewport(0,0,c.width,c.height);b.depthFunc(b.LEQUAL);b.enable(b.DEPTH_TEST);b.enable(b.CULL_FACE);i.prototype={getParameters:function(a,d){for(var h=this.id,e={},c=0,k=b.getProgramParameter(h,b["ACTIVE_"+d]);c<k;c++){var j=b["getActive"+a](h,c),f=b["get"+a+"Location"](h,j.name);e[j.name]=[f,j.type]}return e},setParameter:function(a,d){var h=this.uniforms[a],e;if(h)if(e=h[0],h=t[h[1]],"M"===h[0])b["uniform"+h](e,!1,d);else b["uniform"+h](e,d);else if(e=b.getUniformLocation(this.id,
a))if(h=this.uniforms[a.match(/([\w]+)/)[1]+"[0]"])this.uniforms[a]=[e,h[1]],this.setParameter(a,d)},getParameter:function(a){return this.uniforms[a]||this.attribs[a]},bind:function(){if(this.ready){b.useProgram(this.id);for(var a=this.attribs,d=Object.keys(a),h=0,e=d.length;h<e;h++)b.enableVertexAttribArray(a[d[h]][0])}},unbind:function(){for(var a=this.attribs,d=Object.keys(a),h=0,e=d.length;h<e;h++)b.disableVertexAttribArray(a[d[h]][0]);b.useProgram(null)}};s.prototype={bind:function(a){this.ready&&
(b.activeTexture(b["TEXTURE"+(a||0)]),b.bindTexture(b.TEXTURE_2D,this.id))},unbind:function(){b.bindTexture(b.TEXTURE_2D,0)}};h.prototype=s.prototype;var V=/(?:\.([^.]+))?$/;j.prototype={render:function(){y&&(b.bindBuffer(b.ARRAY_BUFFER,this.buffer),q("a_position",3,b.FLOAT,!1,20,0),q("a_uv",2,b.FLOAT,!1,20,12),b.drawArrays(b.TRIANGLE_STRIP,0,4))}};H.prototype={render:function(){y&&(b.bindBuffer(b.ARRAY_BUFFER,this.vertexBuffer),q("a_position",3,b.FLOAT,!1,20,0),q("a_uv",2,b.FLOAT,!1,20,12),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,
this.indexBuffer),b.drawElements(b.TRIANGLES,this.indexArray.length,b.UNSIGNED_SHORT,0))},renderLines:function(){b.bindBuffer(b.ARRAY_BUFFER,this.vertexBuffer);q("a_position",3,b.FLOAT,!1,20,0);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indexBuffer);b.drawElements(b.LINES,this.indexArray.length,b.UNSIGNED_SHORT,0)}};e.prototype={renderLines:function(){y&&(b.bindBuffer(b.ARRAY_BUFFER,this.buffer),q("a_position",3,b.FLOAT,!1,12,0),b.drawArrays(b.LINES,0,24))}};k("\x00","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAIAAAD91JpzAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAAMSURBVBhXY0ACDAwAAA4AAXqxuTAAAAAASUVORK5CYII=");
return{viewSize:function(a,d){b.viewport(0,0,a,d)},setPerspective:function(a,b,d,h){f.mat4.makePerspective(r,a,b,d,h)},loadIdentity:function(){K=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},translate:function(a,b,d){f.mat4.translate(K,a,b,d)},rotate:function(a,b,d,h){f.mat4.rotate(K,a,b,d,h)},scale:function(a,b,d){f.mat4.scale(K,a,b,d)},lookAt:function(a,b,d){f.mat4.makeLookAt(K,a,b,d)},multMat:function(a){f.mat4.multMat(K,a,K)},pushMatrix:function(){x.push(Object.copy(K))},popMatrix:function(){K=x.pop()},
newShader:function(a,d,h,e){if(!O[a]){for(var e=e||[],c=0;c<e.length;c++)e[c]="#define "+e[c];e=e.join("\n")+"\n";d=g(e+d,b.VERTEX_SHADER);h=g(e+h,b.FRAGMENT_SHADER);d.ready&&h.ready&&(O[a]=new i(d,h),P[a]={})}return!O[a]||!O[a].ready?!1:O[a]},bindShader:function(a){var b=O[a];if(b&&(!y||y.id!==b.id))y&&y.unbind(),D=a,y=b,y.bind()},setParameter:function(a,b){if(y){var d=P[D][a],h=!1;b instanceof Array?Array.equals(d,b)||(h=!0):d!==b&&(h=!0);h&&(P[D][a]=b,y.setParameter(a,b))}},vertexAttribPointer:q,
bindMVP:function(a){y&&(f.mat4.multMat(r,K,w),y.setParameter(a,w))},bindView:function(a){y&&y.setParameter(a,K)},newTexture:k,bindTexture:function(a,b){var d=p[a];if(!d||!d.ready)d=p["\x00"];b=b||0;if(!E[b]||E[b].name!==a)E[b]=d,d.bind(b)},textureReady:function(a){return 1===da[a]},newRectangle:function(a,b,d,h,e,c){return new j(a,b,d,h,e,c)},newSphere:function(a,b,d,h,e,c){return new H(a,b,d,h,e,c)},newCube:function(a,b,d,h,c,k){return new e(a,b,d,h,c,k)},gl:b,hasFloatTexture:$}}console.error("Could not create a WebGL context")}
var f=function(){function c(a){return 0===a?0:0>a?-1:1}var g=Math.PI/180,s=180/Math.PI,i={setFromValues:function(a,d,h,c){a[0]=d;a[1]=h;a[2]=c},setFromArray:function(a,d){a[0]=d[0];a[1]=d[1];a[2]=d[2]},add:function(a,d,h){h[0]=a[0]+d[0];h[1]=a[1]+d[1];h[2]=a[2]+d[2];return h},subtract:function(a,d,h){h[0]=a[0]-d[0];h[1]=a[1]-d[1];h[2]=a[2]-d[2];return h},negate:function(a,d){d[0]=-a[0];d[1]=-a[1];d[2]=-a[2];return d},scale:function(a,d,h){h[0]=a[0]*d;h[1]=a[1]*d;h[2]=a[2]*d;return h},magnitudeSquared:function(a){var d=
a[0],h=a[1],a=a[2];return d*d+h*h+a*a},magnitude:function(a){var d=a[0],h=a[1],a=a[2];return Math.sqrt(d*d+h*h+a*a)},normalize:function(a,d){var h=1/this.magnitude(a);d[0]=a[0]*h;d[1]=a[1]*h;d[2]=a[2]*h;return d},dot:function(a,d){return a[0]*d[0]+a[1]*d[1]+a[2]*d[2]},cross:function(a,d,h){var c=a[0],j=a[1],a=a[2],f=d[0],e=d[1],d=d[2];h[0]=j*d-a*e;h[1]=a*f-c*d;h[2]=c*e-j*f;return h},lerp:function(a,d,h,c){var j=a[0],f=a[1],a=a[2];c[0]=(d[0]-j)*h+j;c[1]=(d[1]-f)*h+f;c[2]=(d[2]-a)*h+a;return c},hermite:function(a,
d,h,c,j,f){var e=j*j,b=e*(j-2)+j,g=e*(j-1),i=e*(3-2*j),a=this.scale(a,e*(2*j-3)+1,[]),d=this.scale(d,b,[]),h=this.scale(h,g,[]),c=this.scale(c,i,[]);f[0]=a[0]+d[0]+h[0]+c[0];f[1]=a[1]+d[1]+h[1]+c[1];f[2]=a[2]+d[2]+h[2]+c[2];return f},bezier:function(a,d,h,c,j,f){var e=1-j,b=j*j,g=e*e,i=3*j*g,m=3*b*e,j=b*j,a=this.scale(a,g*e,[]),d=this.scale(d,i,[]),h=this.scale(h,m,[]),c=this.scale(c,j,[]);f[0]=a[0]+d[0]+h[0]+c[0];f[1]=a[1]+d[1]+h[1]+c[1];f[2]=a[2]+d[2]+h[2]+c[2];return f},equals:function(a,d){return a.length===
d.length&&a[0]===d[0]&&a[1]===d[1]&&a[2]===d[2]}},q={setFromValues:function(a,d,h,c,j){a[0]=d;a[1]=h;a[2]=c;a[3]=j},setFromArray:function(a,d){a[0]=d[0];a[1]=d[1];a[2]=d[2];a[3]=d[3]},add:function(a,d,h){h[0]=a[0]+d[0];h[1]=a[1]+d[1];h[2]=a[2]+d[2];h[3]=a[3]+d[3];return h},subtract:function(a,d,h){h[0]=a[0]-d[0];h[1]=a[1]-d[1];h[2]=a[2]-d[2];h[3]=a[3]-d[3];return h},negate:function(a,d){d[0]=-a[0];d[1]=-a[1];d[2]=-a[2];d[3]=-a[3];return d},scale:function(a,d,h){h[0]=a[0]*d;h[1]=a[1]*d;h[2]=a[2]*d;
h[3]=a[3]*d;return h},magnitudeSquared:function(a){var d=a[0],h=a[1],c=a[2],a=a[3];return d*d+h*h+c*c+a*a},magnitude:function(a){var d=a[0],h=a[1],c=a[2],a=a[3];return Math.sqrt(d*d+h*h+c*c+a*a)},normalize:function(a,d){var h=1/this.magnitude(a);d[0]=a[0]*h;d[1]=a[1]*h;d[2]=a[2]*h;d[3]=a[3]*h;return d},dot:function(a,d){return a[0]*d[0]+a[1]*d[1]+a[2]*d[2]+a[3]*d[3]},lerp:function(a,d,h,c){var j=a[0],f=a[1],e=a[2],a=a[3];c[0]=(d[0]-j)*h+j;c[1]=(d[1]-f)*h+f;c[2]=(d[2]-e)*h+e;c[3]=(d[3]-a)*h+a;return c},
equals:function(a,d){return a.length===d.length&&a[0]===d[0]&&a[1]===d[1]&&a[2]===d[2]&&a[3]===d[3]}},o={create:q.create,createFromArray:q.createFromArray,createFromValues:q.createFromValues,clone:q.clone,setFromValues:q.setFromValues,setFromArray:q.setFromArray,add:q.add,negate:q.negate,scale:q.scale,magnitudeSquared:q.magnitudeSquared,magnitude:q.magnitude,normalize:q.normalize,dot:q.dot,nlerp:q.lerp,fromAxisAngle:function(a,d,h){var c=[],j=d*g/2,d=Math.cos(j),j=Math.sin(j);i.normalize(a,c);this.setFromValues(h,
c[0]*j,c[1]*j,c[2]*j,d);return h},toAxisAngle:function(a,d){var h=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);d[0]=a[0]/h;d[1]=a[1]/h;d[2]=a[2]/h;d[3]=2*Math.acos(a[3]);return d},fromEulerAngles:function(a,d,h,c){var j=a*g/2,f=d*g/2,e=h*g/2,h=Math.sin(j),d=Math.sin(f),a=Math.sin(e),j=Math.cos(j),f=Math.cos(f),e=Math.cos(e);this.setFromValues(c,a*j*f-e*h*d,e*h*f+a*j*d,e*j*d-a*h*f,e*j*f+a*h*d);this.normalize(c,c);return c},fromAngles:function(a,d,h,c){return this.fromEulerAngles(d,h,a,c)},conjugate:function(a,
d){d[0]=-a[0];d[1]=-a[1];d[2]=-a[2];d[3]=a[3];return d},concat:function(a,d,h){var c=a[0],f=a[1],g=a[2],a=a[3],e=d[0],b=d[1],i=d[2],d=d[3];h[0]=a*e+c*d+f*i-g*b;h[1]=a*b-c*i+f*d+g*e;h[2]=a*i+c*b-f*e+g*d;h[3]=a*d-c*e-f*b-g*i},fromRotationMatrix4:function(a,d){var h=a[0],c=a[5],j=a[10],g=Math.sqrt(Math.max(0,1-h+c-j))/2,e=Math.sqrt(Math.max(0,1-h-c+j))/2,b=Math.sqrt(Math.max(0,1+h+c+j))/2;d[0]=Math.sqrt(Math.max(0,1+h-c-j))/2;d[0]=f.copysign(g,a[0]-a[6]);d[1]=f.copysign(e,a[2]-a[8]);d[2]=f.copysign(b,
a[4]-a[1]);return d},toRotationMatrix4:function(a,d){var h=a[0],c=a[1],f=a[2],g=a[3],e=2*h,b=2*c,i=2*f,m=e*g,o=b*g,g=i*g,e=e*h,q=b*h,h=i*h,b=b*c,c=i*c,f=i*f;d[0]=1-(b+f);d[1]=q+g;d[2]=h-o;d[3]=0;d[4]=q-g;d[5]=1-(e+f);d[6]=c+m;d[7]=0;d[8]=h+o;d[9]=c-m;d[10]=1-(e+b);d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return d},multVec3:function(a,d,h){var c=[];i.normalize(d,c);c[3]=0;var f=[];o.conjugate(a,f);o.concat(c,f,c);o.concat(a,c,c);a=i.magnitude(d);i.setFromValues(h,c[0],c[1],c[2]);i.scale(h,a,h);return h},
slerp:function(a,d,c,f){if(0>c)return this.setFromArray(f,a),f;if(1<c)return this.setFromArray(f,d),f;var j=this.dot(a,d);if(1<j||-1>j)return this.setFromArray(f,d),f;var g=1;0>j&&(g=-1,j=-j);var e=Math.acos(j);if(1.0E-6>=e)return this.setFromArray(f,d),f;var b=1/Math.sin(e),j=Math.sin((1-c)*e)*b,c=g*Math.sin(c*e)*b;f[0]=a[0]*j+d[0]*c;f[1]=a[1]*j+d[1]*c;f[2]=a[2]*j+d[2]*c;f[3]=a[3]*j+d[3]*c;return f},sqlerp:function(a,d,c,f,j,g){var e=[],b=[];this.slerp(a,f,j,e);this.slerp(d,c,j,b);this.slerp(e,b,
2*j*(1-j),g);return g}},v=function(){return{scalar:function(a,d,c,g,j,i){switch(i){case 0:return a;case 1:return f.lerp(a,g,j);case 2:return f.hermite(a,d,c,g,j);case 3:return f.bezier(a,d,c,g,j)}},vector:function(a,d,c,g,j,i){switch(i){case 0:return a;case 1:return f.vec3.lerp(a,g,j,[]);case 2:return f.vec3.hermite(a,d,c,g,j,[]);case 3:return f.vec3.bezier(a,d,c,g,j,[])}},quaternion:function(a,d,c,g,j,i){switch(i){case 0:return a;case 1:return f.quaternion.slerp(a,g,j,[]);case 2:case 3:return f.quaternion.sqlerp(a,
d,c,g,j,[])}}}}();return{EPSILON:1.0E-6,random:function(a,d){return a+Math.random()*(d-a)},clamp:function(a,d,c){return Math.min(Math.max(a,d),c)},lerp:function(a,d,c){return a+c*(d-a)},hermite:function(a,d,c,f,g){var i=g*g;return a*(i*(2*g-3)+1)+d*(i*(g-2)+g)+c*i*(g-1)+f*i*(3-2*g)},bezier:function(a,d,c,f,g){var i=1-g,e=g*g,b=i*i;return a*b*i+d*3*g*b+c*3*e*i+f*e*g},toRad:function(a){return a*g},toDeg:function(a){return a*s},sign:c,copysign:function(a,d){var h=c(a),f=c(d);return 0===f?0:h!==f?-a:
a},powerOfTwo:function(a){a--;a|=a>>1;a|=a>>2;a|=a>>4;a|=a>>8;a|=a>>16;a++;return a},vec3:i,vec4:q,quaternion:o,mat4:{create:function(){return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},createIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},createFromArray:function(a){var d=this.create();this.setFromArray(d,a);return d},createFromValues:function(a,d,c,f,g,i,e,b,m,o,q,s,r,K,B,v){var p=this.create();this.setFromValues(p,a,d,c,f,g,i,e,b,m,o,q,s,r,K,B,v);return p},setFromValues:function(a,d,c,f,g,
i,e,b,m,o,q,s,r,B,v,w,p){a[0]=d;a[1]=c;a[2]=f;a[3]=g;a[4]=i;a[5]=e;a[6]=b;a[7]=m;a[8]=o;a[9]=q;a[10]=s;a[11]=r;a[12]=B;a[13]=v;a[14]=w;a[15]=p},setFromArray:function(a,d){a[0]=d[0];a[1]=d[1];a[2]=d[2];a[3]=d[3];a[4]=d[4];a[5]=d[5];a[6]=d[6];a[7]=d[7];a[8]=d[8];a[9]=d[9];a[10]=d[10];a[11]=d[11];a[12]=d[12];a[13]=d[13];a[14]=d[14];a[15]=d[15]},setColumnValues:function(a,d,c,f,g,i){d*=4;a[d]=c;a[d+1]=f;a[d+2]=g;a[d+3]=i},setColumn:function(a,d,c){d*=4;a[d]=c[0];a[d+1]=c[1];a[d+2]=c[2];a[d+3]=c[3]},setRowValues:function(a,
d,c,f,g,i){a[d]=c;a[d+4]=f;a[d+8]=g;a[d+12]=i},setRow:function(a,d,c){a[d]=c[0];a[d+4]=c[1];a[d+8]=c[2];a[d+12]=c[3]},setDiagonalValues:function(a,d,c,f,g){a[0]=d;a[5]=c;a[10]=f;a[15]=g},getColumn:function(a,d,c){d*=4;c[0]=a[d];c[1]=a[d+1];c[2]=a[d+2];c[3]=a[d+3]},getRow:function(a,d,c){c[0]=a[d];c[1]=a[d+4];c[2]=a[d+8];c[3]=a[d+12]},getElement:function(a,d,c){return a[d+4*c]},setElement:function(a,d,c,f){a[d+4*c]=f},multMat:function(a,d,c){var f=a[0],g=a[1],i=a[2],e=a[3],b=a[4],m=a[5],o=a[6],q=a[7],
s=a[8],r=a[9],B=a[10],v=a[11],w=a[12],p=a[13],x=a[14],a=a[15],Q=d[0],O=d[1],P=d[2],y=d[3],D=d[4],E=d[5],t=d[6],I=d[7],V=d[8],U=d[9],R=d[10],S=d[11],F=d[12],G=d[13],L=d[14],d=d[15];c[0]=f*Q+b*O+s*P+w*y;c[1]=g*Q+m*O+r*P+p*y;c[2]=i*Q+o*O+B*P+x*y;c[3]=e*Q+q*O+v*P+a*y;c[4]=f*D+b*E+s*t+w*I;c[5]=g*D+m*E+r*t+p*I;c[6]=i*D+o*E+B*t+x*I;c[7]=e*D+q*E+v*t+a*I;c[8]=f*V+b*U+s*R+w*S;c[9]=g*V+m*U+r*R+p*S;c[10]=i*V+o*U+B*R+x*S;c[11]=e*V+q*U+v*R+a*S;c[12]=f*F+b*G+s*L+w*d;c[13]=g*F+m*G+r*L+p*d;c[14]=i*F+o*G+B*L+x*d;c[15]=
e*F+q*G+v*L+a*d;return c},makeTranslate:function(a,d,c,f){this.makeIdentity(a);this.setColumnValues(a,3,d,c,f,1);return a},makeScale:function(a,d,c,f){this.makeIdentity(a);this.setDiagonalValues(a,d,c,f,1);return a},makeRotate:function(a,d,c,f,g){var i=Math.cos(d),e=1-i,d=Math.sin(d);this.setFromValues(a,c*c*e+i,c*f*e+g*d,c*g*e-f*d,0,c*f*e-g*d,f*f*e+i,f*g*e+c*d,0,c*g*e+f*d,f*g*e-c*d,g*g*e+i,0,0,0,0,1);return a},makeRotateX:function(a,d){var c=Math.cos(d),f=Math.sin(d);this.setFromValues(a,1,0,0,0,
0,c,f,0,0,-f,c,0,0,0,0,1);return a},makeRotateY:function(a,d){var c=Math.cos(d),f=Math.sin(d);this.setFromValues(a,c,0,-f,0,0,1,0,0,f,0,c,0,0,0,0,1);return a},makeRotateZ:function(a,d){var c=Math.cos(d),f=Math.sin(d);this.setFromValues(a,c,f,0,0,-f,c,0,0,0,0,1,0,0,0,0,1);return a},makePerspective:function(a,d,c,f,g){var i=d/2,d=g-f,e=Math.sin(i);if(0===d||0===e||0===c)return a;i=Math.cos(i)/e;this.setFromValues(a,i/c,0,0,0,0,i,0,0,0,0,-(g+f)/d,-1,0,0,-(2*f*g)/d,0);return a},makeLookAt:function(a,
d,c,f){var g=[],m=[],e=[];i.subtract(c,d,g);i.normalize(g,g);g[3]=0;i.cross(g,f,m);i.normalize(m,m);m[3]=0;i.cross(m,g,e);i.normalize(e,e);e[3]=0;i.negate(g,g);this.setRow(a,0,m);this.setRow(a,1,e);this.setRow(a,2,g);this.setRowValues(a,3,0,0,0,1);this.translate(a,-d[0],-d[1],-d[2]);return a},translate:function(a,d,c,f){this.setColumnValues(a,3,a[0]*d+a[4]*c+a[8]*f+a[12],a[1]*d+a[5]*c+a[9]*f+a[13],a[2]*d+a[6]*c+a[10]*f+a[14],a[3]*d+a[7]*c+a[11]*f+a[15]);return a},scale:function(a,d,c,f){this.setFromValues(a,
a[0]*d,a[1]*d,a[2]*d,a[3]*d,a[4]*c,a[5]*c,a[6]*c,a[7]*c,a[8]*f,a[9]*f,a[10]*f,a[11]*f,a[12],a[13],a[14],a[15]);return a},rotate:function(a,c,f,g,j){var i=a[0],e=a[1],b=a[2],m=a[3],o=a[4],q=a[5],s=a[6],r=a[7],B=a[8],v=a[9],w=a[10],p=a[11],x=a[12],Q=a[13],O=a[14],P=a[15],y=Math.cos(c),D=Math.sin(c),E=1-y,c=f*f*E+y,t=f*g*E+j*D,I=f*j*E-g*D,L=f*g*E-j*D,U=g*g*E+y,R=g*j*E+f*D,S=f*j*E+g*D,f=g*j*E-f*D,j=j*j*E+y;this.setFromValues(a,i*c+o*t+B*I,e*c+q*t+v*I,b*c+s*t+w*I,m*c+r*t+p*I,i*L+o*U+B*R,e*L+q*U+v*R,b*
L+s*U+w*R,m*L+r*U+p*R,i*S+o*f+B*j,e*S+q*f+v*j,b*S+s*f+w*j,m*S+r*f+p*j,x,Q,O,P);return a},rotateQ:function(a,c){var g=[];f.quaternion.toRotationMatrix4(c,g);f.mat4.multMat(a,g,a);return a},multVec3:function(a,c,f){var g=c[0],i=c[1],c=c[2];f[0]=g*a[0]+i*a[4]+c*a[8]+a[12];f[1]=g*a[1]+i*a[5]+c*a[9]+a[13];f[2]=g*a[2]+i*a[6]+c*a[10]+a[14];return f},decompose:function(a,c,f,g){var j=a[0],m=a[1],e=a[2],b=a[4],q=a[5],s=a[6],B=a[8],v=a[9],r=a[10],w=a[12],x=a[13],Q=a[14],a=[],p=[];p[0]=j;p[1]=m;p[2]=e;g[0]=
i.magnitude(p);p[0]=b;p[1]=q;p[2]=s;g[1]=i.magnitude(p);p[0]=B;p[1]=v;p[2]=r;g[2]=i.magnitude(p);c[0]=w;c[1]=x;c[2]=Q;if(0===g[0]||0===g[1]||0===g[2])return!1;c=[1/g[0],1/g[1],1/g[2]];this.setFromValues(a,j*c[0],m*c[0],e*c[0],0,b*c[1],q*c[1],s*c[1],0,B*c[2],v*c[2],r*c[2],0,0,0,0,1);o.fromRotationMatrix4(a,f);return!0}},interpolator:v}}(),la={Int8:1,Int16:2,Int32:4,Uint8:1,Uint16:2,Uint32:4,Float32:4,Float64:8};window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||
window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c){window.setTimeout(c,1E3/60)}}());String.hashCode=function(c){for(var f=0,g=0,i=c.length;g<i;g++)f=31*f+c.charCodeAt(g),f&=f;return f};Object.copy=function(c){for(var f=Object.keys(c),g=c instanceof Array?[]:{},i=0,q=f.length;i<q;i++){var o=f[i];g[o]="object"===typeof o?Object.copy(c[o]):c[o]}return g};Array.equals=function(c,f){if(!c||!f||c.length!==f.length)return!1;for(var g=0,i=c.length;g<
i;g++)if(c[g]instanceof Array&&f[g]instanceof Array){if(!Array.equals(c[g],f[g]))return!1}else if(c[g]!==f[g])return!1;return!0};var L={header:function(c){return"http://www.hiveworkshop.com/forums/apps.php?p=textures&id="+c},mpqFile:function(c){return"http://www.hiveworkshop.com/forums/apps.php?p=mpq_file&file="+c},customFile:function(c){return"http://www.hiveworkshop.com/forums/"+c}};window.Viewer=function(m){var Q,B,i;function q(a,b,c,d){if("MDLX"==a){a=new ya.Parser(b,o);a.ready&&(document.title=
a.modelChunk.name.replace(/^.*[\\\/]/,"").replace(/\..*/,""),o({status:"Setting the model for rendering"}),ga&&console.log(a),b=t+N.wpsmain,a.geosetChunk&&(la&&Fa&&(I=e.newShader("main",N.vsbonetexture+N.wvshardskinningtexture,b),M=2),!I&&a.boneChunk.bones.length<Ga/4-1&&(I=e.newShader("main",N.wvshardskinningarray,b),M=1),I||(I=e.newShader("main",N.wvssoftskinning,b),M=0),I&&(0===M?console.log("Running in SOFTware mode."):1===M?console.log("Running in HARDware mode (array)."):2===M&&console.log("Running in HARDware mode (texture)."))),
a.particleEmitter2Chunk&&(V=e.newShader("particles",N.wvsparticles,t+N.wpsparticles)),a.ribbonEmitterChunk&&(U=e.newShader("ribbons",N.wvssoftskinning,b)),r=new ya.Model(a,d,!1,o),ga&&console.log(r));for(d=0;13>d;d++)b=10>d?"0"+d:d,a="ReplaceableTextures/TeamColor/TeamColor"+b+".blp",b="ReplaceableTextures/TeamGlow/TeamGlow"+b+".blp",e.newTexture(a,L.mpqFile(a)),e.newTexture(b,L.mpqFile(b))}else{if(a=new za.Parser(b,o))document.title=a.name.replace(/^.*[\\\/]/,"").replace(/\..*/,""),o({status:"Setting the model for rendering"}),
ga&&console.log(a),r=new za.Model(a,o),d="EXPLICITUV"+(r.uvSetCount-1),a=N.vsbonetexture+N.svscommon+"\n"+N.svsstandard,b=N.spscommon+"\n",c=t+b+N.spsspecialized,e.newShader("standard",a,t+b+N.spsstandard,[d]),e.newShader("diffuse",a,c,[d,"DIFFUSE_PASS"]),e.newShader("normals",a,c,[d,"NORMALS_PASS"]),e.newShader("normalmap",a,c,[d,"NORMALS_PASS","HIGHRES_NORMALS"]),e.newShader("specular",a,c,[d,"SPECULAR_PASS"]),e.newShader("specular_normalmap",a,c,[d,"SPECULAR_PASS","HIGHRES_NORMALS"]),e.newShader("emissive",
a,c,[d,"EMISSIVE_PASS"]),e.newShader("unshaded",a,c,[d,"UNSHADED_PASS"]),e.newShader("unshaded_normalmap",a,c,[d,"UNSHADED_PASS","HIGHRES_NORMALS"]),e.newShader("decal",a,c,[d,"DECAL_PASS"]),ga&&console.log(r);Da(document.getElementById("shaders-select"),"change",function(a){D=a.target.value})}}function o(a){if(m.onprogress)m.onprogress(a)}function T(a){if(m.onerror)m.onerror(a)}function a(a){var a=new ua(a.target.response),b=va(a,4);"MDLX"==b?(E=1,Q=[30,2E3],q(b,a,m,ra)):"43DM"==b?(E=2,Q=[0.2,20],
q(b,a,m,ra)):(console.log("Invalid file"),console.log("Magic is: "+b));k();if(m.onload)m.onload(E)}function d(b){b=JSON.parse(b.target.response);ra=b.textures;o({status:"Downloading the model file"});fa(L.customFile(b.url),!0,a,T,o)}function h(a){1<P&&R&&(e.bindShader("world"),b.disable(b.CULL_FACE),e.pushMatrix(),2==E&&e.scale(0.0125,0.0125,0.0125),e.bindMVP("u_mvp"),e.popMatrix(),a?(Y[0]+=O[0],Y[1]+=O[1],e.setParameter("u_uv_offset",Y),e.setParameter("u_a",0.6)):(e.setParameter("u_uv_offset",[0,
0]),e.setParameter("u_a",1)),2<P?a?(b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),e.bindTexture("water",0),ta.render(),b.disable(b.BLEND)):(e.bindTexture("bedrock",0),p.render()):(e.bindTexture("grass",0),ta.render()))}function k(){i[0]=0;i[1]=0;1===E?(i[2]=3*r.extent,B=[315,225]):(i[2]=6*r.extent,B=[315,315])}function j(){requestAnimationFrame(j);if(Aa){r&&r.update();var a=[];if(-1===K){var b=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],c=f.toRad(B[1]),d=f.toRad(B[0]);f.mat4.translate(b,
i[0],i[1],-i[2]);f.mat4.rotate(b,d,1,0,0);f.mat4.rotate(b,c,0,0,1);f.mat4.multVec3(b,[0,0,1],a);e.loadIdentity();e.multMat(b)}else a=sa.position,cameraDest=sa.targetPosition,e.lookAt(a,cameraDest,up);$=a;0<P&&R&&(e.bindShader("world"),e.setParameter("u_uv_offset",[0,0]),e.setParameter("u_a",1),e.pushMatrix(),e.loadIdentity(),e.bindMVP("u_mvp"),e.bindTexture("sky"),da.render(),e.popMatrix());h();r&&r.render();2<P&&h(!0)}}var H=m.canvas,e=Ea(H),b=e.gl;i=[0,0,0];Q=[0,0];B=[0,0];var $=[0,0,0],ha=[0,0,
2.5],M=0,ra={},r,K=-1,sa,ta,p,da,Y=[0,0],O=[f.random(-0.004,0.004),f.random(-0.004,0.004)],P=1,y=!1,D="standard",E=0,t="precision mediump float;\n",I,V,U,R,S,F=1/60,G=1,oa=m.MODEL_ID,pa=m.MODEL_PATH,qa=m.MPQ_PATH,ga=m.DEBUG_MODE,la=b.getExtension("OES_texture_float"),Fa=0<b.getParameter(b.MAX_VERTEX_TEXTURE_IMAGE_UNITS),Ga=b.getParameter(b.MAX_VERTEX_UNIFORM_VECTORS),xa=[[255,3,3],[0,66,255],[28,230,185],[84,0,129],[255,252,1],[254,138,14],[32,192,0],[229,91,176],[149,150,151],[126,191,241],[16,98,
70],[78,42,4],[40,40,40]],N={vsbonetexture:"uniform sampler2D u_bones;uniform float u_bone_size;uniform float u_pixel_size;mat4 boneAtIndex(float A){return mat4(texture2D(u_bones,vec2(A*u_bone_size,0)),texture2D(u_bones,vec2(A*u_bone_size+u_pixel_size,0)),texture2D(u_bones,vec2(A*u_bone_size+u_pixel_size*2.0,0)),texture2D(u_bones,vec2(A*u_bone_size+u_pixel_size*3.0,0)));}",vsworld:"uniform mat4 u_mvp;uniform vec2 u_uv_offset;attribute vec3 a_position;attribute vec2 a_uv;varying vec2 v_uv;void main(){v_uv=a_uv+u_uv_offset;gl_Position=u_mvp*vec4(a_position,1);}",
vswhite:"uniform mat4 u_mvp;attribute vec3 a_position;void main(){gl_Position=u_mvp*vec4(a_position,1);}",psworld:"uniform sampler2D u_texture;uniform float u_a;varying vec2 v_uv;void main(){gl_FragColor=vec4(texture2D(u_texture,v_uv).rgb,u_a);}",pswhite:"void main(){gl_FragColor=vec4(1);}",wvssoftskinning:"uniform mat4 u_mvp;uniform vec2 u_uv_offset;attribute vec3 a_position;attribute vec2 a_uv;varying vec2 v_uv;void main(){v_uv=a_uv+u_uv_offset;gl_Position=u_mvp*vec4(a_position,1);}",wvshardskinningarray:"uniform mat4 u_mvp;uniform mat4 u_bones[62];uniform vec2 u_uv_offset;attribute vec3 a_position;attribute vec2 a_uv;attribute vec4 a_bones;attribute float a_bone_number;varying vec2 v_uv;void main(){vec4 A=vec4(0);vec4 B=vec4(a_position,1);A+=u_bones[int(a_bones[0])]*B;A+=u_bones[int(a_bones[1])]*B;A+=u_bones[int(a_bones[2])]*B;A+=u_bones[int(a_bones[3])]*B;A/=a_bone_number;v_uv=a_uv+u_uv_offset;gl_Position=u_mvp*A;}",
wvshardskinningtexture:"uniform mat4 u_mvp;uniform vec2 u_uv_offset;attribute vec3 a_position;attribute vec2 a_uv;attribute vec4 a_bones;attribute float a_bone_number;varying vec2 v_uv;void main(){vec4 A=vec4(0);vec4 B=vec4(a_position,1);A+=boneAtIndex(a_bones[0])*B;A+=boneAtIndex(a_bones[1])*B;A+=boneAtIndex(a_bones[2])*B;A+=boneAtIndex(a_bones[3])*B;A/=a_bone_number;v_uv=a_uv+u_uv_offset;gl_Position=u_mvp*A;}",wvsparticles:"uniform mat4 u_mvp;attribute vec3 a_position;attribute vec2 a_uv;attribute vec4 a_color;varying vec2 v_uv;varying vec4 v_color;void main(){v_uv=a_uv;v_color=a_color;gl_Position=u_mvp*vec4(a_position,1);}",
wpsmain:"uniform sampler2D u_texture;uniform bvec3 u_type;uniform vec4 u_modifier;varying vec3 v_normal;varying vec2 v_uv;void main(){vec4 A=texture2D(u_texture,v_uv);if(u_type[0]&&A.a<.7){discard;}if(u_type[1]&&A.r<.2&&A.g<.2&&A.b<.2){discard;}if(u_type[2]&&A.r>.9&&A.g>.9&&A.b>.9){discard;}gl_FragColor=A*u_modifier;}",wpsparticles:"uniform sampler2D u_texture;varying vec2 v_uv;varying vec4 v_color;void main(){gl_FragColor=texture2D(u_texture,v_uv)*v_color;}",svscommon:"vec3 TBN(vec3 A,vec3 B,vec3 C,vec3 D){vec3 E;E.x=dot(A,B);E.y=dot(A,C);E.z=dot(A,D);return E;}",
svsstandard:"uniform mat4 u_mvp;uniform mat4 u_mv;uniform vec3 u_eyePos;uniform vec3 u_lightPos;attribute vec3 a_position;attribute vec4 a_normal;attribute vec2 a_uv0;\n#ifdef EXPLICITUV1\nattribute vec2 a_uv1;\n#endif\n#ifdef EXPLICITUV2\nattribute vec2 a_uv1;attribute vec2 a_uv2\n#endif\n#ifdef EXPLICITUV3\nattribute vec2 a_uv1;attribute vec2 a_uv2attribute vec2 a_uv3\n#endif\nattribute vec4 a_tangent;attribute vec4 a_bones;attribute vec4 a_weights;varying vec3 v_normal;varying vec2 v_uv[4];varying vec3 v_lightDir;varying vec3 v_eyeVec;varying vec3 v_halfVec;void transform(vec3 A,vec3 B,vec3 C,vec4 D,vec4 E,out vec3 F,out vec3 G,out vec3 H){vec4 I=vec4(A,1);vec4 J=vec4(B,0);vec4 K=vec4(C,0);vec4 L;mat4 M=boneAtIndex(D[0])*E[0];mat4 N=boneAtIndex(D[1])*E[1];mat4 O=boneAtIndex(D[2])*E[2];mat4 P=boneAtIndex(D[3])*E[3];L=vec4(0);L+=M*I;L+=N*I;L+=O*I;L+=P*I;F=vec3(L);L=vec4(0);L+=M*J;L+=N*J;L+=O*J;L+=P*J;G=normalize(vec3(L));L=vec4(0);L+=M*K;L+=N*K;L+=O*K;L+=P*K;H=normalize(vec3(L));}void main(){vec3 A,B,C;transform(a_position,vec3(a_normal),vec3(a_tangent),a_bones,a_weights,A,B,C);mat3 D=mat3(u_mv);vec3 E=(u_mv*vec4(A,1)).xyz;vec3 F=normalize(D*B);vec3 G=normalize(D*C);vec3 H=normalize(cross(F,G)*a_normal.w);vec3 I=normalize(u_lightPos-E);v_lightDir=normalize(TBN(I,G,H,F));vec3 J=normalize(u_eyePos-E);vec3 K=normalize(J-u_lightPos);v_eyeVec=TBN(J,G,H,F);v_halfVec=TBN(K,G,H,F);v_normal=F;v_uv[0]=a_uv0;\n#ifdef EXPLICITUV1\nv_uv[1]=a_uv1;\n#endif\n#ifdef EXPLICITUV2\nv_uv[1]=a_uv1;v_uv[2]=a_uv2;\n#endif\n#ifdef EXPLICITUV3\nv_uv[1]=a_uv1;v_uv[2]=a_uv2;v_uv[3]=a_uv3;\n#endif\ngl_Position=u_mvp*vec4(A,1);}",
spscommon:"uniform vec3 u_teamColor;varying vec3 v_normal;varying vec2 v_uv[4];varying vec3 v_lightDir;varying vec3 v_eyeVec;varying vec3 v_halfVec;struct LayerSettings{bool enabled;float op;float channels;float teamColorMode;vec3 multAddAlpha;bool useAlphaFactor;bool invert;bool multColor;bool addColor;bool clampResult;bool useConstantColor;vec4 constantColor;float uvSource;float uvCoordinate;float fresnelMode;float fresnelTransformMode;mat4 fresnelTransform;bool fresnelClamp;vec3 fresnelExponentBiasScale;};\n#define SPECULAR_RGB 0.0\n#define SPECULAR_A_ONLY 1.0\n#define FRESNELMODE_NONE 0.0\n#define FRESNELMODE_STANDARD 1.0\n#define FRESNELMODE_INVERTED 2.0\n#define FRESNELTRANSFORM_NONE 0.0\n#define FRESNELTRANSFORM_SIMPLE 1.0\n#define FRESNELTRANSFORM_NORMALIZED 2.0\n#define UVMAP_EXPLICITUV0 0.0\n#define UVMAP_EXPLICITUV1 1.0\n#define UVMAP_REFLECT_CUBICENVIO 2.0\n#define UVMAP_REFLECT_SPHERICALENVIO 3.0\n#define UVMAP_PLANARLOCALZ 4.0\n#define UVMAP_PLANARWORLDZ 5.0\n#define UVMAP_PARTICLE_FLIPBOOK 6.0\n#define UVMAP_CUBICENVIO 7.0\n#define UVMAP_SPHERICALENVIO 8.0\n#define UVMAP_EXPLICITUV2 9.0\n#define UVMAP_EXPLICITUV3 10.0\n#define UVMAP_PLANARLOCALX 11.0\n#define UVMAP_PLANARLOCALY 12.0\n#define UVMAP_PLANARWORLDX 13.0\n#define UVMAP_PLANARWORLDY 14.0\n#define UVMAP_SCREENSPACE 15.0\n#define UVMAP_TRIPLANAR_LOCAL 16.0\n#define UVMAP_TRIPLANAR_WORLD 17.0\n#define UVMAP_TRIPLANAR_WORLD_LOCAL_Z 18.0\n#define CHANNELSELECT_RGB 0.0\n#define CHANNELSELECT_RGBA 1.0\n#define CHANNELSELECT_A 2.0\n#define CHANNELSELECT_R 3.0\n#define CHANNELSELECT_G 4.0\n#define CHANNELSELECT_B 5.0\n#define TEAMCOLOR_NONE 0.0\n#define TEAMCOLOR_DIFFUSE 1.0\n#define TEAMCOLOR_EMISSIVE 2.0\n#define LAYEROP_MOD 0.0\n#define LAYEROP_MOD2X 1.0\n#define LAYEROP_ADD 2.0\n#define LAYEROP_LERP 3.0\n#define LAYEROP_TEAMCOLOR_EMISSIVE_ADD 4.0\n#define LAYEROP_TEAMCOLOR_DIFFUSE_ADD 5.0\n#define LAYEROP_ADD_NO_ALPHA 6.0\nfloat calculateFresnelTerm(vec3 A,vec3 B,float C,mat4 D,float E,bool F){vec3 G=B;float H;if(E!=FRESNELTRANSFORM_NONE){G=(D*vec4(G,1.0)).xyz;if(E==FRESNELTRANSFORM_NORMALIZED){G=normalize(G);}}if(F){H=1.0-clamp(-dot(A,G),.0,1.0);}else{H=1.0-abs(dot(A,G));}H=max(H,.0000001);return pow(H,C);}vec3 combineLayerColor(vec4 A,vec3 B,LayerSettings C){if(C.op==LAYEROP_MOD){B*=A.rgb;}else if(C.op==LAYEROP_MOD2X){B*=A.rgb*2.0;}else if(C.op==LAYEROP_ADD){B+=A.rgb*A.a;}else if(C.op==LAYEROP_ADD_NO_ALPHA){B+=A.rgb;}else if(C.op==LAYEROP_LERP){B=mix(B,A.rgb,A.a);}else if(C.op==LAYEROP_TEAMCOLOR_EMISSIVE_ADD){B+=A.a*u_teamColor;}else if(C.op==LAYEROP_TEAMCOLOR_DIFFUSE_ADD){B+=A.a*u_teamColor;}return B;}vec4 chooseChannel(float A,vec4 B){if(A==CHANNELSELECT_R){B=B.rrrr;}else if(A==CHANNELSELECT_G){B=B.gggg;}else if(A==CHANNELSELECT_B){B=B.bbbb;}else if(A==CHANNELSELECT_A){B=B.aaaa;}else if(A==CHANNELSELECT_RGB){B.a=1.0;}return B;}vec2 getUV(LayerSettings A){if(A.uvCoordinate==1.0){return v_uv[1];}else if(A.uvCoordinate==2.0){return v_uv[2];}else if(A.uvCoordinate==3.0){return v_uv[3];}return v_uv[0];}vec4 sampleLayer(sampler2D A,LayerSettings B){if(B.useConstantColor&&false){return B.constantColor;}return texture2D(A,getUV(B));}vec4 computeLayerColor(sampler2D A,LayerSettings B){vec4 C=sampleLayer(A,B);vec4 D=chooseChannel(B.channels,C);if(B.useAlphaFactor&&false){D.a*=B.multAddAlpha.z;}if(B.teamColorMode==TEAMCOLOR_DIFFUSE){D=vec4(mix(u_teamColor,D.rgb,C.a),1);}else if(B.teamColorMode==TEAMCOLOR_EMISSIVE){D=vec4(mix(u_teamColor,D.rgb,C.a),1);}if(B.invert){D=vec4(1)-D;}if(B.multColor&&false){D*=B.multAddAlpha.x;}if(B.addColor&&false){D+=B.multAddAlpha.y;}if(B.clampResult){D=clamp(D,.0,1.0);}if(B.fresnelMode!=FRESNELMODE_NONE){float E=calculateFresnelTerm(v_normal,v_eyeVec,B.fresnelExponentBiasScale.x,B.fresnelTransform,B.fresnelTransformMode,B.fresnelClamp);if(B.fresnelMode==FRESNELMODE_INVERTED){E=1.0-E;}E=clamp(E*B.fresnelExponentBiasScale.z+B.fresnelExponentBiasScale.y,.0,1.0);D*=E;}return D;}vec3 decodeNormal(sampler2D A){vec4 B=texture2D(A,v_uv[0]);vec3 C;C.xy=2.0*B.wy-1.0;C.z=sqrt(max(.0,1.0-dot(C.xy,C.xy)));return C;}vec4 computeSpecular(sampler2D A,LayerSettings B,float C,float D,vec3 E){vec4 F;if(B.enabled){F=computeLayerColor(A,B);}else{F=vec4(0);}float G=pow(max(-dot(v_halfVec,E),.0),C)*D;return F*G;}",
spsstandard:"uniform float u_specularity;uniform float u_specMult;uniform float u_emisMult;uniform vec4 u_lightAmbient;uniform LayerSettings u_diffuseLayerSettings;uniform sampler2D u_diffuseMap;uniform LayerSettings u_decalLayerSettings;uniform sampler2D u_decalMap;uniform LayerSettings u_specularLayerSettings;uniform sampler2D u_specularMap;uniform LayerSettings u_glossLayerSettings;uniform sampler2D u_glossMap;uniform LayerSettings u_emissiveLayerSettings;uniform sampler2D u_emissiveMap;uniform LayerSettings u_emissive2LayerSettings;uniform sampler2D u_emissive2Map;uniform LayerSettings u_evioLayerSettings;uniform sampler2D u_evioMap;uniform LayerSettings u_evioMaskLayerSettings;uniform sampler2D u_evioMaskMap;uniform LayerSettings u_alphaLayerSettings;uniform sampler2D u_alphaMap;uniform LayerSettings u_alphaMaskLayerSettings;uniform sampler2D u_alphaMaskMap;uniform LayerSettings u_normalLayerSettings;uniform sampler2D u_normalMap;uniform LayerSettings u_heightLayerSettings;uniform sampler2D u_heightMap;uniform LayerSettings u_lightMapLayerSettings;uniform sampler2D u_lightMapMap;uniform LayerSettings u_aoLayerSettings;uniform sampler2D u_aoMap;void main(){vec3 A;vec4 B=u_lightAmbient;vec3 C;vec3 D;if(u_normalLayerSettings.enabled){C=decodeNormal(u_normalMap);}else{C=v_normal;}float E=max(dot(C,v_lightDir),.0);if(E>.0){if(u_diffuseLayerSettings.enabled){vec4 F=computeLayerColor(u_diffuseMap,u_diffuseLayerSettings);A=combineLayerColor(F,A,u_diffuseLayerSettings);}if(u_decalLayerSettings.enabled){vec4 G=computeLayerColor(u_decalMap,u_decalLayerSettings);A=combineLayerColor(G,A,u_decalLayerSettings);}vec4 H=computeSpecular(u_specularMap,u_specularLayerSettings,u_specularity,u_specMult,C);if(u_lightMapLayerSettings.enabled){vec4 I=computeLayerColor(u_lightMapMap,u_lightMapLayerSettings)*2.0;D=I.rgb;}/*B.rgb=A*D+H.rgb;*/B.rgb=(A+H.rgb)*E;bool J=false;vec3 K;vec4 L;if(u_emissiveLayerSettings.enabled){L=computeLayerColor(u_emissiveMap,u_emissiveLayerSettings);if(u_emissiveLayerSettings.op==LAYEROP_MOD||u_emissiveLayerSettings.op==LAYEROP_MOD2X||u_emissiveLayerSettings.op==LAYEROP_LERP){B.rgb=combineLayerColor(L,B.rgb,u_emissiveLayerSettings);}else{K=combineLayerColor(L,K,u_emissiveLayerSettings);J=true;}}if(u_emissive2LayerSettings.enabled){L=computeLayerColor(u_emissive2Map,u_emissive2LayerSettings);if(!J&&(u_emissive2LayerSettings.op==LAYEROP_MOD||u_emissive2LayerSettings.op==LAYEROP_MOD2X||u_emissive2LayerSettings.op==LAYEROP_LERP)){B.rgb=combineLayerColor(L,B.rgb,u_emissive2LayerSettings);}else{K=combineLayerColor(L,K,u_emissive2LayerSettings);J=true;}}if(J){B.rgb+=K*u_emisMult;}}gl_FragColor=B;}",
spsspecialized:"#ifdef DIFFUSE_PASS\nuniform LayerSettings u_diffuseLayerSettings;uniform sampler2D u_diffuseMap;\n#endif\n#ifdef SPECULAR_PASS\nuniform LayerSettings u_specularLayerSettings;uniform sampler2D u_specularMap;uniform float u_specularity;uniform float u_specMult;\n#endif\n#ifdef HIGHRES_NORMALS\nuniform LayerSettings u_normalLayerSettings;uniform sampler2D u_normalMap;\n#endif\n#ifdef EMISSIVE_PASS\nuniform LayerSettings u_emissiveLayerSettings;uniform sampler2D u_emissiveMap;uniform LayerSettings u_emissive2LayerSettings;uniform sampler2D u_emissive2Map;uniform float u_emisMult;\n#endif\n#ifdef DECAL_PASS\nuniform LayerSettings u_decalLayerSettings;uniform sampler2D u_decalMap;\n#endif\nvoid main(){vec4 A=vec4(0);vec3 B;\n#ifdef HIGHRES_NORMALS\nB=decodeNormal(u_normalMap);\n#else\nB=v_normal;\n#endif\n#ifdef DIFFUSE_PASS\nA=computeLayerColor(u_diffuseMap,u_diffuseLayerSettings);\n#endif\n#ifdef NORMALS_PASS\nA=vec4(B,1);\n#endif\n#ifdef SPECULAR_PASS\nA=computeSpecular(u_specularMap,u_specularLayerSettings,u_specularity,u_specMult,B);\n#endif\n#ifdef EMISSIVE_PASS\nbool C=false;vec3 D=vec3(0);vec4 E;if(u_emissiveLayerSettings.enabled){E=computeLayerColor(u_emissiveMap,u_emissiveLayerSettings);if(u_emissiveLayerSettings.op==LAYEROP_MOD||u_emissiveLayerSettings.op==LAYEROP_MOD2X||u_emissiveLayerSettings.op==LAYEROP_LERP){A.rgb=combineLayerColor(E,A.rgb,u_emissiveLayerSettings);}else{D=combineLayerColor(E,D,u_emissiveLayerSettings);C=true;}}if(u_emissive2LayerSettings.enabled){E=computeLayerColor(u_emissive2Map,u_emissive2LayerSettings);if(!C&&(u_emissive2LayerSettings.op==LAYEROP_MOD||u_emissive2LayerSettings.op==LAYEROP_MOD2X||u_emissive2LayerSettings.op==LAYEROP_LERP)){A.rgb=combineLayerColor(E,A.rgb,u_emissive2LayerSettings);}else{D=combineLayerColor(E,D,u_emissive2LayerSettings);C=true;}}if(C){A.rgb+=D.rgb*u_emisMult;}\n#endif\n#ifdef UNSHADED_PASS\nfloat F=max(dot(B,v_lightDir),.0);A=vec4(F,F,F,1);\n#endif\n#ifdef DECAL_PASS\nif(u_decalLayerSettings.enabled){vec4 G=computeLayerColor(u_decalMap,u_decalLayerSettings);A.rgb=combineLayerColor(G,A.rgb,u_decalLayerSettings);A.a=1.0;}\n#endif\ngl_FragColor=A;}"},
ya=function(){function a(b,c,d,e,g,h){var l;l=b.length;for(var u=0;u!==b.length&&d>b[u].time;)l=u,u++;l!==b.length&&b[l].time<e&&(l=b.length);u!==b.length&&b[u].time>g&&(u=b.length);l=[l,u];g=b.length;e=l[0];l=l[1];if(e===g)return l===g?h:b[l].vector;if(l===g)return b[e].vector;e=b[e];l=b[l];if(e.time>=l.time)return e.vector;b=f.clamp((d-e.time)/(l.time-e.time),0,1);return("number"===typeof e.vector?f.interpolator.scalar:3===e.vector.length?f.interpolator.vector:f.interpolator.quaternion)(e.vector,
e.outTan,l.inTan,l.vector,b,c)}function d(b,c,e){if(b){if(4294967295!==b.globalSequenceId){var f=e.globalSequences[b.globalSequenceId];return a(b.tracks,b.interpolationType,e.time%f,0,f,c)}if(e.sequence)return f=e.sequence.interval,a(b.tracks,b.interpolationType,e.frame,f[0],f[1],c)}return c}function h(a,c){var d,e,g=a.pivotPointChunk.points;this.model=c;this.nodes=a.nodes;for(d=0,e=a.nodes.length;d<e;d++){var l=a.nodes[d];l.pivot=g[l.objectId]||[0,0,0];l.worldMatrix=[]}this.bones=[];if(a.boneChunk){g=
a.boneChunk.bones;for(d=0,e=g.length;d<e;d++)this.bones.push(g[d].node)}0<M&&(this.hwbones=new Float32Array(16+16*this.bones.length));2===M&&(this.boneTexture=b.createTexture(),this.boneTextureSize=4*Math.max(2,f.powerOfTwo(this.bones.length+1)),this.texelFraction=1/this.boneTextureSize,this.boneFraction=4*this.texelFraction,b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,this.boneTexture),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,this.boneTextureSize,1,0,b.RGBA,b.FLOAT,null),b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST));this.root={objectId:4294967295};this.root.children=this.setup(a.nodes,this.root)}function i(a){this.node=a.node;var b=a.vertices,c=b[0],b=b[1],d=a.boundsRadius,f;0===a.type?f=e.newCube(c[0],c[1],c[2],b[0],b[1],b[2]):2===a.type&&(f=e.newSphere(c[0],c[1],c[2],9,9,d));this.shape=f}function j(a,b,c,d){this.sequences=[];this.loopingMode=0;this.spawned=c;this.time=this.frame=0;this.setup(a);d&&d({lengthComputable:!0,
total:100,loaded:100});a.textureChunk&&(d&&d({status:"Loading textures"}),this.loadTextures(a,b,d));this.ready=!0}function q(a,b,c,d,f){0!==b&&(a="ReplaceableTextures/"+J[b]+".blp");this.fileName=a.replace(/\\/g,"/");this.replaceableId=b;(a=c[a])&&a.included?(this.custom=!0,this.glTexture=e.newTexture(this.fileName,L.customFile(a.url),!1,!1,d,f)):this.glTexture=e.newTexture(this.fileName,L.mpqFile(this.fileName),!1,!1,d,f)}function o(a){var c,d,e,f,g=new Float32Array(a.vertexPositions),l=a.textureCoordinateSets;
e=2*l[0].length;var h=new Float32Array(l.length*e);for(c=0,d=a.textureCoordinateSets.length;c<d;c++)h.set(l[c],c*e);var l=new Float32Array(4*a.vertexPositions.length),u=new Float32Array(a.vertexPositions.length),i=new Uint16Array(a.faces),j=[];this.uvSetSize=4*e;for(c=0,d=a.matrixGroups.length,f=0;c<d;c++)j.push(a.matrixIndexes.slice(f,f+a.matrixGroups[c])),f+=a.matrixGroups[c];for(c=0,d=g.length/3,f=0;c<d;c++){var n=j[a.vertexGroups[c]],z=0;for(e=0;4>e;e++)n&&e<n.length?(l[f]=n[e]+1,z+=1):l[f]=0,
f+=1;u[c]=z}this.offsets=[0,g.byteLength];this.offsets[2]=this.offsets[1]+h.byteLength;this.offsets[3]=this.offsets[2]+l.byteLength;this.offsets[4]=this.offsets[3]+u.byteLength;this.buffers={vertices:b.createBuffer(),faces:b.createBuffer()};c=this.offsets[4];0===M&&(c=this.offsets[2],this.positions=g,this.animatedPositions=new Float32Array(a.vertexPositions.length),this.boneNumbers=u,this.boneIndices=l);b.bindBuffer(b.ARRAY_BUFFER,this.buffers.vertices);b.bufferData(b.ARRAY_BUFFER,c,b.STATIC_DRAW);
b.bufferSubData(b.ARRAY_BUFFER,this.offsets[0],g);b.bufferSubData(b.ARRAY_BUFFER,this.offsets[1],h);0<M&&(b.bufferSubData(b.ARRAY_BUFFER,this.offsets[2],l),b.bufferSubData(b.ARRAY_BUFFER,this.offsets[3],u));b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.buffers.faces);b.bufferData(b.ELEMENT_ARRAY_BUFFER,i,b.STATIC_DRAW);this.faces=i.length}function k(a,b,c){for(var d=Object.keys(a),e=d.length;e--;){var f=d[e];this[f]=a[f]}this.model=c;this.geosetId=b;this.renderOrder=z[a.filterMode]||0}function m(a){this.model=
a;this.position=[]}function p(a,b){var c,d;d=Object.keys(a);for(c=d.length;c--;)this[d[c]]=a[d[c]];this.model=b;this.lastCreation=0;this.spawnModelFileName=this.spawnModelFileName.replace(/\\/g,"/").replace("MDL","MDX");fa(L.mpqFile(this.spawnModelFileName),!0,function(a){a=new C(new ua(a.target.response));a.ready&&(this.spawnModel=new j(a,{},!0),this.spawnModel.setAnimation(0),ga&&console.log(this.spawnModel))}.bind(this));if(this.tracks.emissionRate){var e=this.tracks.emissionRate,f=0;for(c=0,d=
e.length;c<d;c++){var g=e[c];g.vector>f&&(f=g.vector)}c=Math.round(2*f*Math.ceil(this.lifespan))}else c=Math.round(this.emissionRate*Math.ceil(this.lifespan));this.particles=[];for(this.reusables=[];c--;)this.particles[c]=new m(b),this.reusables.push(c)}function t(){this.color=[];this.position=[]}function l(a,c){var d,e;e=Object.keys(a);for(d=e.length;d--;)this[e[d]]=a[e[d]];this.model=c;this.lastCreation=0;if(this.tracks.emissionRate){var f=this.tracks.emissionRate,g=0;for(d=0,e=f.length;d<e;d++){var l=
f[d];l.vector>g&&(g=l.vector)}d=2*Math.ceil(g)*Math.ceil(this.lifespan)}else d=Math.ceil(this.emissionRate)*Math.ceil(this.lifespan)+3;this.head=0===this.headOrTail||2===this.headOrTail;this.tail=1===this.headOrTail||2===this.headOrTail;this.head&&this.tail&&(d*=2);this.particles=[];this.reusables=[];this.buffer=b.createBuffer();this.data=new Float32Array(54*d);b.bindBuffer(b.ARRAY_BUFFER,this.buffer);for(b.bufferData(b.ARRAY_BUFFER,this.data,b.DYNAMIC_DRAW);d--;)this.particles[d]=new t(c),this.reusables.push(d);
this.head?(this.headFrames=(this.headInterval[1]-this.headInterval[0]+1)*this.headInterval[2],this.headDecayFrames=(this.headDecayInterval[1]-this.headDecayInterval[0]+1)*this.headDecayInterval[2]):this.headDecayFrames=this.headFrames=0;this.tail?(this.tailFrames=(this.tailInterval[1]-this.tailInterval[0]+1)*this.tailInterval[2],this.tailDecayFrames=(this.tailDecayInterval[1]-this.tailDecayInterval[0]+1)*this.tailDecayInterval[2]):this.tailDecayFrames=this.tailFrames=0;this.numberOfFrames=this.headFrames+
this.headDecayFrames+this.tailFrames+this.tailDecayFrames;this.cellWidth=1/this.columns;this.cellHeight=1/this.rows;this.colors=[];for(d=0;3>d;d++)this.colors[d]=[this.segmentColor[d][0],this.segmentColor[d][1],this.segmentColor[d][2],this.segmentAlpha[d]/255]}function n(a){this.alive=!0;this.health=a.lifespan;var b=a.node.pivot,c=d(a.tracks.heightBelow,a.heightBelow,this.model),e=d(a.tracks.heightAbove,a.heightAbove,this.model);this.p1=[b[0],b[1]-c,b[2]];this.p2=[b[0],b[1]+e,b[2]];f.mat4.multVec3(a.node.worldMatrix,
this.p1,this.p1);f.mat4.multVec3(a.node.worldMatrix,this.p2,this.p2)}function u(a,c,d){var e,f=Object.keys(a);for(e=f.length;e--;)this[f[e]]=a[f[e]];this.maxRibbons=e=Math.ceil(this.emissionRate*this.lifespan);this.model=d;this.lastCreation=0;this.ribbons=[];this.data=new Float32Array(10*e);this.buffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,this.buffer);b.bufferData(b.ARRAY_BUFFER,this.data,b.DYNAMIC_DRAW);this.cellWidth=1/this.columns;this.cellHeight=1/this.rows;d=[[],[],[],[]];a=c[this.materialId].layers;
for(e=0,c=a.length;e<c;e++)f=new k(a[e],0),d[f.renderOrder].push(f);this.layers=d[0].concat(d[1]).concat(d[2]).concat(d[3])}var C=function(){function a(b){return{boundsRadius:g(b),minimum:s(b),maximum:s(b)}}function b(a,c,d,e){for(var f=0,ia=[];f!==c;){var g=new d(a,e),f=f+g.inclusiveSize;ia.push(g)}return ia}function d(a,b,c){for(var e=[];b--;)e.push(new c(a));return e}function e(a,b,c){for(var d=[];b--;)d.push(c(a));return d}function f(a,b){for(var c={};B[b][va(a,4)];){var d=B[b][v(a,4)];c[d[1]]=
new u(a,d[0])}return c}function l(a,b){var c=new i(a);b.push(c);return c}function h(a,b,c){this.time=w(a);this.vector=c(a);1<b&&(this.inTan=c(a),this.outTan=c(a))}function u(a,b){var d=c(a);this.interpolationType=c(a);this.globalSequenceId=c(a);for(this.tracks=[];d--;)this.tracks.push(new h(a,this.interpolationType,b))}function i(a){this.inclusiveSize=c(a);this.name=v(a,80);this.objectId=c(a);this.parentId=c(a);var b=c(a);0===b?this.helper=!0:(b&1&&(this.dontInheritTranslation=!0),b&2&&(this.dontInheritRotation=
!0),b&4&&(this.dontInheritScaling=!0),b&8&&(this.billboarded=!0),b&16&&(this.billboardedLockX=!0),b&32&&(this.billboardedLockY=!0),b&64&&(this.billboardedLockZ=!0),b&128&&(this.cameraAnchored=!0),b&256&&(this.bone=!0),b&512&&(this.light=!0),b&1024&&(this.eventObject=!0),b&2048&&(this.attachment=!0),b&4096&&(this.particleEmitter=!0),b&8192&&(this.collisionShape=!0),b&16384&&(this.ribbonEmitter=!0),b&32768&&(this.emitterUsesMdlOrUnshaded=!0),b&65536&&(this.emitterUsesTgaOrSortPrimitivesFarZ=!0),b&131072&&
(this.lineEmitter=!0),b&262144&&(this.unfogged=!0),b&524288&&(this.modelSpace=!0),b&1048576&&(this.xYQuad=!0));this.flags=b;this.tracks=f(a,"NODE")}function j(b){this.name=v(b,80);this.interval=X(b,2);this.moveSpeed=g(b);this.flags=c(b);this.rarity=g(b);this.syncPoint=c(b);this.extent=a(b)}function n(a){this.replaceableId=c(a);this.fileName=v(a,260);this.flags=c(a)}function z(a){this.inclusiveSize=c(a);this.filterMode=c(a);var b=c(a);b&1&&(this.unshaded=!0);b&2&&(this.sphereEnvironmentMap=!0);b&16&&
(this.twoSided=!0);b&32&&(this.unfogged=!0);b&48&&(this.noDepthTest=!0);b&64&&(this.noDepthSet=!0);this.shadingFlags=b;this.textureId=c(a);this.textureAnimationId=c(a);this.coordId=c(a);this.alpha=g(a);this.tracks=f(a,"LAYS")}function J(a){this.inclusiveSize=c(a);this.priorityPlane=c(a);this.flags=c(a);12<this.inclusiveSize&&(v(a,4),this.layers=d(a,c(a),z))}function C(a){this.inclusiveSize=c(a);this.tracks=f(a,"TXAN")}function o(b){this.inclusiveSize=c(b);v(b,4);this.vertexPositions=Z(b,3*c(b));v(b,
4);this.vertexNormals=Z(b,3*c(b));v(b,4);this.faceTypeGroups=X(b,c(b));v(b,4);this.faceGroups=X(b,c(b));v(b,4);var d=c(b);this.faces=ba(b,d,"Uint16");v(b,4);this.vertexGroups=ea(b,c(b));v(b,4);this.matrixGroups=X(b,c(b));v(b,4);this.matrixIndexes=X(b,c(b));this.materialId=c(b);this.selectionGroup=c(b);this.selectionFlags=c(b);this.extent=a(b);this.extents=e(b,c(b),a);v(b,4);this.textureCoordinateSets=[];for(var d=0,f=c(b);d<f;d++)v(b,4),this.textureCoordinateSets[d]=Z(b,2*c(b))}function q(a){this.inclusiveSize=
c(a);this.alpha=g(a);this.flags=c(a);this.color=s(a);this.geosetId=c(a);this.tracks=f(a,"GEOA")}function k(a,b){this.node=l(a,b);this.geosetId=c(a);this.geosetAnimationId=c(a);this.inclusiveSize=this.node.inclusiveSize+8}function r(a,b){this.inclusiveSize=c(a);this.node=l(a,b);this.type=c(a);this.attenuationStart=c(a);this.attenuationEnd=c(a);this.color=s(a);this.intensity=g(a);this.ambientColor=s(a);this.ambientIntensity=g(a);this.tracks=f(a,"LITE")}function m(a,b){this.inclusiveSize=c(a);this.node=
l(a,b);this.emissionRate=g(a);this.gravity=g(a);this.longitude=g(a);this.latitude=g(a);this.spawnModelFileName=v(a,260);this.lifespan=g(a);this.initialVelocity=g(a);this.tracks=f(a,"PREM")}function W(a,b){this.inclusiveSize=c(a);this.node=l(a,b);this.speed=g(a);this.variation=g(a);this.latitude=g(a);this.gravity=g(a);this.lifespan=g(a);this.emissionRate=g(a);this.length=g(a);this.width=g(a);this.filterMode=c(a);this.rows=c(a);this.columns=c(a);this.headOrTail=c(a);this.tailLength=g(a);this.time=g(a);
this.segmentColor=ma(a,3,3,"Float32");this.segmentAlpha=ea(a,3);this.segmentScaling=Z(a,3);this.headInterval=X(a,3);this.headDecayInterval=X(a,3);this.tailInterval=X(a,3);this.tailDecayInterval=X(a,3);this.textureId=c(a);this.squirt=c(a);this.priorityPlane=c(a);this.replaceableId=c(a);this.tracks=f(a,"PRE2")}function p(a,b){this.inclusiveSize=c(a);this.node=l(a,b);this.heightAbove=g(a);this.heightBelow=g(a);this.alpha=g(a);this.color=s(a);this.lifespan=g(a);this.textureSlot=c(a);this.emissionRate=
c(a);this.rows=c(a);this.columns=c(a);this.materialId=c(a);this.gravity=g(a);this.tracks=f(a,"RIBB")}function t(a){this.inclusiveSize=c(a);this.name=v(a,80);this.position=s(a);this.fieldOfView=g(a);this.farClippingPlane=g(a);this.nearClippingPlane=g(a);this.targetPosition=s(a);this.tracks=f(a,"CAMS")}function x(a,b){this.node=l(a,b);var d=c(a);this.type=d;this.inclusiveSize=this.node.inclusiveSize+4;0===d||1===d||3===d?(this.vertices=ma(a,2,3,"Float32"),this.inclusiveSize+=24):2===d&&(this.vertices=
[s(a)],this.inclusiveSize+=12);if(2===d||3===d)this.boundsRadius=g(a),this.inclusiveSize+=4}var B={LAYS:{KMTF:[c,"textureId"],KMTA:[g,"alpha"]},TXAN:{KTAT:[s,"translation"],KTAR:[ka,"rotation"],KTAS:[s,"scaling"]},GEOA:{KGAO:[g,"alpha"],KGAC:[s,"color"]},LITE:{KLAS:[g,"attenuationStart"],KLAE:[g,"attenuationEnd"],KLAC:[s,"color"],KLAI:[g,"intensity"],KLBI:[g,"ambientIntensity"],KLBC:[s,"ambientColor"],KLAV:[g,"visibility"]},ATCH:{KATV:[g,"visibility"]},PREM:{KPEE:[g,"emissionRate"],KPEG:[g,"gravity"],
KPLN:[g,"longitude"],KPLT:[g,"latitude"],KPEL:[g,"lifespan"],KPES:[g,"speed"],KPEV:[g,"visibility"]},PRE2:{KP2S:[g,"speed"],KP2R:[g,"variation"],KP2L:[g,"latitude"],KP2G:[g,"gravity"],KP2E:[g,"emissionRate"],KP2N:[g,"length"],KP2W:[g,"width"],KP2V:[g,"visibility"]},RIBB:{KRHA:[g,"heightAbove"],KRHB:[g,"heightBelow"],KRAL:[g,"alpha"],KRCO:[s,"color"],KRTX:[c,"textureSlot"],KRVS:[g,"visibility"]},CAMS:{KCTR:[s,"positionTranslation"],KTTR:[s,"targetTranslation"],KCRL:[c,"rotation"]},NODE:{KGTR:[s,"translation"],
KGRT:[ka,"rotation"],KGSC:[s,"scaling"]}},y={MODL:[function(b){this.name=v(b,80);this.animationFileName=v(b,260);this.extent=a(b);this.blendTime=c(b)},"modelChunk"],SEQS:[function(a,b){this.sequences=d(a,b/132,j)},"sequenceChunk"],GLBS:[function(a,b){this.sequences=e(a,b/4,c)},"globalSequenceChunk"],TEXS:[function(a,b){this.textures=d(a,b/268,n)},"textureChunk"],MTLS:[function(a,c){this.materials=b(a,c,J)},"materialChunk"],TXAN:[function(a,c){this.animations=b(a,c,C)},"textureAnimationChunk"],GEOS:[function(a,
c){this.geosets=b(a,c,o)},"geosetChunk"],GEOA:[function(a,c){this.animations=b(a,c,q)},"geosetAnimationChunk"],BONE:[function(a,c,d){this.bones=b(a,c,k,d)},"boneChunk"],LITE:[function(a,c,d){this.lights=b(a,c,r,d)},"lightChunk"],HELP:[function(a,b,c){for(var d=l,e=0,f=[];e!==b;){var ia=d(a,c),e=e+ia.inclusiveSize;f.push(ia)}this.helpers=f},"helperChunk"],PIVT:[function(a,b){this.points=ma(a,b/12,3,"Float32")},"pivotPointChunk"],PREM:[function(a,c,d){this.emitters=b(a,c,m,d)},"particleEmitterChunk"],
PRE2:[function(a,c,d){this.emitters=b(a,c,W,d)},"particleEmitter2Chunk"],RIBB:[function(a,c,d){this.emitters=b(a,c,p,d)},"ribbonEmitterChunk"],CAMS:[function(a,c){this.cameras=b(a,c,t)},"cameraChunk"],CLID:[function(a,c,d){this.shapes=b(a,c,x,d)},"collisionShapeChunk"]};return function(a,b){if("MDLX"===v(a,4)){for(this.nodes=[];0<a.size-a.index;){var d=v(a,4),e=c(a);(d=y[d])?this[d[1]]=new d[0](a,e,this.nodes):(d=a,d.index+=e,0>d.index?d.index=0:d.index>d.size&&(d.index=d.size));"function"===typeof b&&
b({lengthComputable:!0,total:a.size,loaded:a.index})}this.ready=!0}}}();h.prototype={setup:function(a,b){for(var c=[],d=a.length;d--;){var e=a[d];e.parentId===b.objectId&&4294967295!==e.objectId&&(e.children=this.setup(a,e),e.parent=b,c.push(e))}return c},update:function(){this.updateNodes(this.root);0<M&&this.updateHW()},updateNodes:function(a){for(var b=0,c=a.children.length;b<c;b++){var d=a.children[b];this.updateNode(d);this.updateNodes(d)}},updateHW:function(){for(var a=0,c=this.bones.length;a<
c;a++){var d=16*a+16;this.hwbones[d+0]=this.bones[a].worldMatrix[0];this.hwbones[d+1]=this.bones[a].worldMatrix[1];this.hwbones[d+2]=this.bones[a].worldMatrix[2];this.hwbones[d+3]=this.bones[a].worldMatrix[3];this.hwbones[d+4]=this.bones[a].worldMatrix[4];this.hwbones[d+5]=this.bones[a].worldMatrix[5];this.hwbones[d+6]=this.bones[a].worldMatrix[6];this.hwbones[d+7]=this.bones[a].worldMatrix[7];this.hwbones[d+8]=this.bones[a].worldMatrix[8];this.hwbones[d+9]=this.bones[a].worldMatrix[9];this.hwbones[d+
10]=this.bones[a].worldMatrix[10];this.hwbones[d+11]=this.bones[a].worldMatrix[11];this.hwbones[d+12]=this.bones[a].worldMatrix[12];this.hwbones[d+13]=this.bones[a].worldMatrix[13];this.hwbones[d+14]=this.bones[a].worldMatrix[14];this.hwbones[d+15]=this.bones[a].worldMatrix[15]}2===M&&(b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,this.boneTexture),b.texSubImage2D(b.TEXTURE_2D,0,0,0,4+4*this.bones.length,1,b.RGBA,b.FLOAT,this.hwbones))},updateNode:function(a){var b=a.pivot,c=d(a.tracks.translation,
[0,0,0],this.model),e=d(a.tracks.rotation,[0,0,0,1],this.model),g=d(a.tracks.scaling,[1,1,1],this.model),l=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];(0!==c[0]||0!==c[1]||0!==c[2])&&f.mat4.translate(l,c[0],c[1],c[2]);if(0!==e[0]||0!==e[1]||0!==e[2]||1!==e[3])c=[],f.quaternion.toRotationMatrix4(e,c),f.mat4.translate(l,b[0],b[1],b[2]),f.mat4.multMat(l,c,l),f.mat4.translate(l,-b[0],-b[1],-b[2]);if(1!==g[0]||1!==g[1]||1!==g[2])f.mat4.translate(l,b[0],b[1],b[2]),f.mat4.scale(l,g[0],g[1],g[2]),f.mat4.translate(l,
-b[0],-b[1],-b[2]);4294967295!==a.parent.objectId?f.mat4.multMat(a.parent.worldMatrix,l,a.worldMatrix):a.worldMatrix=l;a.billboarded&&(e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f.mat4.translate(e,b[0],b[1],b[2]),f.mat4.rotate(e,-f.toRad(B[1]+270),0,0,1),f.mat4.rotate(e,f.toRad(B[0]-90),0,1,0),f.mat4.translate(e,-b[0],-b[1],-b[2]),f.mat4.multMat(a.worldMatrix,e,a.worldMatrix))},bind:function(){2===M?(b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,this.boneTexture),e.setParameter("u_bones",1),e.setParameter("u_bone_size",
this.boneFraction),e.setParameter("u_pixel_size",this.texelFraction)):1===M&&e.setParameter("u_bones",this.hwbones)}};i.prototype={render:function(){this.shape&&(e.pushMatrix(),e.multMat(this.node.worldMatrix),e.bindWorldMatrix("u_mvp"),this.shape.renderLines(),e.popMatrix())}};j.prototype={setup:function(a){var b,c,d,e,f;a.materialChunk&&(this.materials=a.materialChunk.materials);if(a.geosetChunk){b=a.geosetChunk.geosets;var g=[[],[],[],[]];this.geosets=[];for(c=0,d=b.length;c<d;c++){e=b[c];var j=
this.materials[e.materialId].layers;this.geosets.push(new o(e));for(e=0,f=j.length;e<f;e++){var n=new k(j[e],c,this);g[n.renderOrder].push(n)}}this.layers=g[0].concat(g[1]).concat(g[2]).concat(g[3])}a.sequenceChunk&&(this.sequences=a.sequenceChunk.sequences);a.cameraChunk&&(this.cameras=a.cameraChunk.cameras);a.geosetAnimationChunk&&(this.geosetAnimations=a.geosetAnimationChunk.animations);a.globalSequenceChunk&&(this.globalSequences=a.globalSequenceChunk.sequences);a.textureAnimationChunk&&(this.textureAnimations=
a.textureAnimationChunk.animations);if(a.particleEmitterChunk){b=a.particleEmitterChunk.emitters;this.particleEmitters=[];for(c=0,d=b.length;c<d;c++)this.particleEmitters[c]=new p(b[c],this)}if(a.particleEmitter2Chunk){b=a.particleEmitter2Chunk.emitters;this.particleEmitters2=[];for(c=0,d=b.length;c<d;c++)this.particleEmitters2[c]=new l(b[c],this)}if(a.ribbonEmitterChunk){b=a.ribbonEmitterChunk.emitters;this.ribbonEmitters=[];for(c=0,d=b.length;c<d;c++)this.ribbonEmitters[c]=new u(b[c],this.materials,
this)}if(a.collisionShapeChunk){b=a.collisionShapeChunk.shapes;this.collisionShapes=[];for(c=0,d=b.length;c<d;c++)this.collisionShapes[c]=new i(b[c])}this.skeleton=new h(a,this);this.extent=a.modelChunk.extent.maximum[0]||100},loadTextures:function(a,b,c){function d(){f++;c&&c({lengthComputable:!0,total:l.length,loaded:f+g})}function e(){g++;c&&c({lengthComputable:!0,total:l.length,loaded:f+g})}var f=0,g=0,l=a.textureChunk.textures;this.textures=[];for(var a=0,h=l.length;a<h;a++)this.textures.push(new q(l[a].fileName,
l[a].replaceableId,b,d,e))},updateEmitters:function(a,b){if(a)for(var c=0,d=a.length;c<d;c++)a[c].update(b)},update:function(){var a=!1;this.sequence&&(this.time+=16*G,this.frame+=16*G,a=!0,this.frame>=this.sequence.interval[1]&&(2===this.loopingMode||0===this.loopingMode&&0===this.sequence.flags?this.frame=this.sequence.interval[0]:(this.time-=16*G,this.frame=this.sequence.interval[1]),a=!1));this.skeleton.update();this.updateEmitters(this.particleEmitters,a);this.updateEmitters(this.particleEmitters2,
a);this.updateEmitters(this.ribbonEmitters,a)},render:function(){var a,c,f;if(this.layers&&I){e.bindShader("main");e.bindMVP("u_mvp");e.setParameter("u_texture",0);for(a=0,c=this.layers.length;a<c;a++){var g=this.layers[a];if(g.shouldRender()&&this.shouldRenderGeoset(g)){var l=this.geosets[g.geosetId],h=[1,1,1,1],u=[0,0];g.setMaterial();e.bindTexture(this.textures[Math.floor(d(g.tracks.textureId,g.textureId,this))].fileName,0);if(this.geosetAnimations)for(var i=this.geosetAnimations.length;i--;)if(f=
this.geosetAnimations[i],f.geosetId===g.geosetId&&(f=d(f.tracks.color,f.color,this),1!==f[0]||1!==f[1]||1!==f[2]))h[0]=f[0],h[1]=f[1],h[2]=f[2];h[3]=d(g.tracks.alpha,g.alpha,this);e.setParameter("u_modifier",h);4294967295!==g.textureAnimationId&&this.textureAnimations&&(f=d(this.textureAnimations[g.textureAnimationId].tracks.translation,[0,0,0],this),u[0]=f[0],u[1]=f[1]);e.setParameter("u_uv_offset",u);0<M?(this.skeleton.bind(),l.renderHW(g.coordId)):l.render(this.skeleton.nodes,g.coordId)}}}b.depthMask(1);
if(!this.spawned&&this.particleEmitters&&I)for(a=0,c=this.particleEmitters.length;a<c;a++)this.particleEmitters[a].render();if(this.ribbonEmitters&&U){b.disable(b.CULL_FACE);e.bindShader("ribbons");e.bindMVP("u_mvp");e.setParameter("u_texture",0);for(a=0,c=this.ribbonEmitters.length;a<c;a++)this.ribbonEmitters[a].render(this)}if(this.particleEmitters2&&V){b.depthMask(0);b.enable(b.BLEND);b.disable(b.CULL_FACE);e.bindShader("particles");e.bindMVP("u_mvp");e.setParameter("u_texture",0);for(a=0,c=this.particleEmitters2.length;a<
c;a++)this.particleEmitters2[a].render(this);b.depthMask(1);b.disable(b.BLEND);b.enable(b.CULL_FACE)}if(y&&this.collisionShapes&&S){b.depthMask(1);e.bindShader("white");e.bindMVP("u_mvp");for(a=0,c=this.collisionShapes.length;a<c;a++)this.collisionShapes[a].render()}b.disable(b.BLEND);b.enable(b.CULL_FACE)},shouldRenderGeoset:function(a){var b,c;if(this.geosetAnimations)for(b=0,c=this.geosetAnimations.length;b<c;b++){var e=this.geosetAnimations[b];if(e.geosetId===a.geosetId&&e.tracks.alpha)return 0.1<
d(e.tracks.alpha,1,this)}return!0},setTeamColor:function(a){for(var a=10>a?"0"+a:""+a,b=0,c=this.textures.length;b<c;b++){var d=this.textures[b],e=d.replaceableId;if(1===e||2===e)d.fileName=d.fileName.replace(/\d\d/,a)}},setAnimation:function(a){this.sequence&&this.sequence===this.sequences[a]?this.frame=this.sequence.interval[0]:(a=f.clamp(a,-1,this.sequences.length-1),-1===a?(this.sequence=null,this.frame=this.time=0):(this.sequence=this.sequences[a],this.frame=this.sequence.interval[0]))},setAnimationLooping:function(a){this.loopingMode=
f.clamp(a,0,2)}};var J={1:"TeamColor/TeamColor00",2:"TeamGlow/TeamGlow00",11:"Cliff/Cliff0",31:"LordaeronTree/LordaeronSummerTree",32:"AshenvaleTree/AshenTree",33:"BarrensTree/BarrensTree",34:"NorthrendTree/NorthTree",35:"Mushroom/MushroomTree",36:"RuinsTree/RuinsTree",37:"OutlandMushroomTree/MushroomTree"};o.prototype={render:function(a,c){for(var d=[],f=[],g=this.positions,l=this.animatedPositions,h=0,u=g.length/3;h<u;h++){d[0]=d[1]=d[2]=0;f[0]=g[3*h+0];f[1]=g[3*h+1];f[2]=g[3*h+2];for(var i=this.boneNumbers[h],
j=0,n=i;j<n;j++){var z=a[this.boneIndices[4*h+j]-1].worldMatrix,J=f[0],C=f[1],o=f[2];d[0]+=J*z[0]+C*z[4]+o*z[8]+z[12];d[1]+=J*z[1]+C*z[5]+o*z[9]+z[13];d[2]+=J*z[2]+C*z[6]+o*z[10]+z[14]}i=1/i;l[3*h+0]=d[0]*i;l[3*h+1]=d[1]*i;l[3*h+2]=d[2]*i}b.bindBuffer(b.ARRAY_BUFFER,this.buffers.vertices);b.bufferSubData(b.ARRAY_BUFFER,this.offsets[0],l);e.vertexAttribPointer("a_position",3,b.FLOAT,!1,12,this.offsets[0]);e.vertexAttribPointer("a_uv",2,b.FLOAT,!1,8,this.offsets[1]+c*this.uvSetSize);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,
this.buffers.faces);b.drawElements(b.TRIANGLES,this.faces,b.UNSIGNED_SHORT,0)},renderHW:function(a){b.bindBuffer(b.ARRAY_BUFFER,this.buffers.vertices);e.vertexAttribPointer("a_position",3,b.FLOAT,!1,12,this.offsets[0]);e.vertexAttribPointer("a_uv",2,b.FLOAT,!1,8,this.offsets[1]+a*this.uvSetSize);e.vertexAttribPointer("a_bones",4,b.FLOAT,!1,16,this.offsets[2]);e.vertexAttribPointer("a_bone_number",1,b.FLOAT,!1,4,this.offsets[3]);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.buffers.faces);b.drawElements(b.TRIANGLES,
this.faces,b.UNSIGNED_SHORT,0)}};var z={"0":0,1:1,2:2,3:3,4:3,5:3,6:3};k.prototype={setMaterial:function(){switch(this.filterMode){case 1:e.setParameter("u_type",[1,0,0]);b.depthMask(1);b.disable(b.BLEND);break;case 2:e.setParameter("u_type",[0,0,0]);b.depthMask(0);b.enable(b.BLEND);b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA);break;case 3:e.setParameter("u_type",[0,1,0]);b.enable(b.BLEND);b.depthMask(0);b.blendFunc(b.SRC_COLOR,b.ONE);break;case 4:e.setParameter("u_type",[0,0,0]);b.depthMask(0);
b.enable(b.BLEND);b.blendFunc(b.SRC_ALPHA,b.ONE);break;case 5:case 6:e.setParameter("u_type",[0,0,1]);b.depthMask(0);b.enable(b.BLEND);b.blendFunc(b.SRC_ZERO,b.SRC_COLOR);break;default:e.setParameter("u_type",[0,0,0]),b.depthMask(1),b.disable(b.BLEND)}this.twoSided?b.disable(b.CULL_FACE):b.enable(b.CULL_FACE)},shouldRender:function(){return 0.1<d(this.tracks.alpha,1,this.model)}};m.prototype={reset:function(a){var b=d(a.tracks.speed,a.initialVelocity,this.model),c=d(a.tracks.latitude,a.latitude,this.model),
e=d(a.tracks.longitude,a.longitude,this.model),g=d(a.tracks.lifespan,a.lifespan,this.model);this.alive=!0;this.health=g;f.mat4.multVec3(a.node.worldMatrix,a.node.pivot,this.position);var l=[],h=[],u=[],g=[];f.mat4.makeRotateY(l,f.random(-c,c));f.mat4.makeRotateZ(h,f.random(-e,e));f.mat4.multMat(h,l,u);f.mat4.multVec3(u,[0,0,1],g);f.vec3.normalize(g,g);e=this.position;c=[e[0],e[1],e[2]];e=[e[0]+g[0],e[1]+g[1],e[2]+g[2]];f.mat4.multVec3(a.node.worldMatrix,c,c);f.mat4.multVec3(a.node.worldMatrix,e,e);
f.vec3.subtract(e,c,g);f.vec3.normalize(g,g);f.vec3.scale(g,b,g);this.velocity=g;this.orientation=f.random(0,2*Math.PI)},update:function(a){this.alive&&(a=d(a.tracks.gravity,a.gravity,this.model),this.health-=F*G,this.velocity[2]-=a*F*G,this.position[0]+=this.velocity[0]*F*G,this.position[1]+=this.velocity[1]*F*G,this.position[2]+=this.velocity[2]*F*G)}};p.prototype={update:function(a){var b,c;this.spawnModel&&this.spawnModel.update();for(b=0,c=this.particles.length;b<c;b++){var e=this.particles[b];
e.alive&&(0>=e.health?(e.alive=!1,this.reusables.push(b)):e.update(this))}if(a&&this.shouldRender()&&(this.lastCreation+=1*G,a=d(this.tracks.emissionRate,this.emissionRate,this.model)*F/(1/this.lastCreation),1<=a))for(b=this.lastCreation=0;b<a;b++)0<this.reusables.length&&this.particles[this.reusables.pop()].reset(this)},render:function(){var a=this.spawnModel;if(a)for(var b=0,c=this.particles.length;b<c;b++){var d=this.particles[b];if(0<d.health){var f=d.position;e.pushMatrix();e.translate(f[0],
f[1],f[2]);e.rotate(d.orientation,0,0,1);a.render();e.popMatrix()}}},shouldRender:function(){return 0.1<d(this.tracks.visibility,0,this.model)}};t.prototype={reset:function(a,b){var c=a.node.pivot,e=0.5*d(a.tracks.width,a.width,this.model),g=0.5*d(a.tracks.length,a.length,this.model),l=d(a.tracks.speed,a.speed,this.model),h=f.toRad(d(a.tracks.latitude,a.latitude,this.model));this.alive=!0;this.health=a.lifespan;this.head=b;f.mat4.multVec3(a.node.worldMatrix,[c[0]+f.random(-e,e),c[1]+f.random(-g,g),
c[2]],this.position);this.speed=l+f.random(-a.variation,a.variation);c=[];g=[];l=[];e=[];f.mat4.makeRotateY(c,f.random(-h,h));f.mat4.makeRotateZ(g,f.random(-Math.PI,Math.PI));f.mat4.multMat(g,c,l);f.mat4.multVec3(l,[0,0,1],e);f.vec3.normalize(e,e);c=this.position;h=[c[0],c[1],c[2]];c=[c[0]+e[0],c[1]+e[1],c[2]+e[2]];f.mat4.multVec3(a.node.worldMatrix,h,h);f.mat4.multVec3(a.node.worldMatrix,c,c);f.vec3.subtract(c,h,e);f.vec3.normalize(e,e);f.vec3.scale(e,this.speed,e);this.velocity=e;this.head||(h=
0.5*a.tailLength,this.position[0]-=h*e,this.position[1]-=h*e,this.position[2]-=h*e,this.tailLength=h);this.scale=1;this.column=this.row=0},update:function(a){if(this.alive){var b=d(a.tracks.gravity,a.gravity,this.model);this.health-=F*G;this.velocity[2]-=b*F*G;this.position[0]+=this.velocity[0]*F*G;this.position[1]+=this.velocity[1]*F*G;this.position[2]+=this.velocity[2]*F*G;var c=0===a.lifespan?0:1-this.health/a.lifespan,e;c<a.time?(e=c/a.time,b=a.segmentScaling[0]+e*(a.segmentScaling[1]-a.segmentScaling[0]),
f.vec4.lerp(a.colors[0],a.colors[1],e,this.color)):(e=(c-a.time)/(1-a.time),b=a.segmentScaling[1]+e*(a.segmentScaling[2]-a.segmentScaling[1]),f.vec4.lerp(a.colors[1],a.colors[2],e,this.color));c*=a.numberOfFrames;this.index=0;var g;0!==a.headOrTail&&(c<a.headFrames?(e=a.headInterval[1]-a.headInterval[0]+1,this.index=a.headInterval[0]+(c-0)%e):c<a.headFrames+a.headDecayFrames?(e=a.headDecayInterval[1]-a.headDecayInterval[0]+1,g=a.headFrames,this.index=a.headDecayInterval[0]+(c-g)%e):c<a.headFrames+
a.headDecayFrames+a.tailFrames?(e=a.tailInterval[1]-a.tailInterval[0]+1,g=a.headFrames+a.headDecayFrames,this.index=a.tailInterval[0]+(c-g)%e):c<a.headFrames+a.headDecayFrames+a.tailFrames+a.tailDecayFrames&&(e=a.tailDecayInterval[1]-a.tailDecayInterval[0]+1,g=a.headFrames+a.headDecayFrames+a.tailFrames,this.index=a.tailDecayInterval[0]+(c-g)%e));this.row=Math.round(1===a.columns?0:this.index/a.columns);this.column=Math.round(1===a.columns?0:this.index%a.columns);this.scale=b}}};l.prototype={update:function(a){var b,
c;for(b=0,c=this.particles.length;b<c;b++){var e=this.particles[b];e.alive&&(0>=e.health?(e.alive=!1,this.reusables.push(b)):e.update(this))}if(a&&this.shouldRender()&&(this.lastCreation+=1*G,a=d(this.tracks.emissionRate,this.emissionRate,this.model)*F/(1/this.lastCreation),1<=a))for(b=this.lastCreation=0;b<a;b++)this.head&&0<this.reusables.length&&this.particles[this.reusables.pop()].reset(this,!0),this.tail&&0<this.reusables.length&&this.particles[this.reusables.pop()].reset(this,!1)},render:function(a){var c=
this.data,d=[-1,-1,0],g=[-1,1,0],l=[1,1,0],h=[1,-1,0],u=[1,0,0],i=[0,1,0],j=[0,0,1];if(!this.node.xYQuad){var n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];f.mat4.rotate(n,-f.toRad(B[1]),0,0,1);f.mat4.rotate(n,-f.toRad(B[0]),1,0,0);this.head&&(f.mat4.multVec3(n,d,d),f.mat4.multVec3(n,g,g),f.mat4.multVec3(n,l,l),f.mat4.multVec3(n,h,h));this.tail&&(f.mat4.multVec3(n,u,u),f.mat4.multVec3(n,i,i),f.mat4.multVec3(n,j,j))}i=0;for(j=this.particles.length;i<j;i++){var z=this.particles[i],n=54*i;if(0<z.health){var J=
z.position,C=z.scale,o=this.cellWidth*z.column,q=this.cellHeight*z.row,k=this.cellWidth*(z.column+1),r=this.cellHeight*(z.row+1),m=z.color,s=m[0],W=m[1],v=m[2],m=m[3],p=J[0],t=J[1],J=J[2],w,x,y,D,G,H,E,A,I;if(z.head)w=p+d[0]*C,x=t+d[1]*C,y=J+d[2]*C,D=p+g[0]*C,G=t+g[1]*C,H=J+g[2]*C,E=p+l[0]*C,A=t+l[1]*C,I=J+l[2]*C,p+=h[0]*C,t+=h[1]*C,C=J+h[2]*C;else{var F=z.tailLength,z=z.velocity;w=F*z[0];x=F*z[1];y=F*z[2];var Ba=p+w,z=t+x,F=J+y,p=p-w,t=t-x,J=J-y;w=Ba-u[0]*C;x=z-u[1]*C;y=F-u[2]*C;D=p-u[0]*C;G=t-u[1]*
C;H=J-u[2]*C;E=p+u[0]*C;A=t+u[1]*C;I=J+u[2]*C;p=Ba+u[0]*C;t=z+u[1]*C;C=F+u[2]*C}c[n+0]=w;c[n+1]=x;c[n+2]=y;c[n+3]=o;c[n+4]=q;c[n+5]=s;c[n+6]=W;c[n+7]=v;c[n+8]=m;c[n+9]=D;c[n+10]=G;c[n+11]=H;c[n+12]=o;c[n+13]=r;c[n+14]=s;c[n+15]=W;c[n+16]=v;c[n+17]=m;c[n+18]=E;c[n+19]=A;c[n+20]=I;c[n+21]=k;c[n+22]=r;c[n+23]=s;c[n+24]=W;c[n+25]=v;c[n+26]=m;c[n+27]=w;c[n+28]=x;c[n+29]=y;c[n+30]=o;c[n+31]=q;c[n+32]=s;c[n+33]=W;c[n+34]=v;c[n+35]=m;c[n+36]=E;c[n+37]=A;c[n+38]=I;c[n+39]=k;c[n+40]=r;c[n+41]=s;c[n+42]=W;c[n+
43]=v;c[n+44]=m;c[n+45]=p;c[n+46]=t;c[n+47]=C;c[n+48]=k;c[n+49]=q;c[n+50]=s;c[n+51]=W;c[n+52]=v;c[n+53]=m}else for(o=0;6>o;o++)q=n+9*o,c[q+0]=0,c[q+1]=0,c[q+2]=0}switch(this.filterMode){case 1:b.blendFunc(b.SRC_COLOR,b.ONE);break;case 2:case 3:b.blendFunc(b.SRC_ZERO,b.SRC_COLOR);break;case 4:b.blendFunc(b.SRC_ALPHA,b.ONE);break;default:b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA)}e.bindTexture(a.textures[this.textureId].fileName,0);b.bindBuffer(b.ARRAY_BUFFER,this.buffer);b.bufferSubData(b.ARRAY_BUFFER,
0,this.data);e.vertexAttribPointer("a_position",3,b.FLOAT,!1,36,0);e.vertexAttribPointer("a_uv",2,b.FLOAT,!1,36,12);e.vertexAttribPointer("a_color",4,b.FLOAT,!1,36,20);b.drawArrays(b.TRIANGLES,0,6*this.particles.length)},shouldRender:function(){return 0.1<d(this.tracks.visibility,1,this.model)}};n.prototype={update:function(a){this.health-=F*G;a=a.gravity*F*F*G;this.p1[2]-=a;this.p2[2]-=a}};u.prototype={update:function(a){for(var b=0,c=this.ribbons.length;b<c;b++)this.ribbons[b].update(this);for(;0<
this.ribbons.length&&0>=this.ribbons[0].health;)this.ribbons.shift();if(a&&this.shouldRender()&&(this.lastCreation+=1*G,a=Math.floor(this.emissionRate*F/(1/this.lastCreation)),0<a))for(this.lastCreation=0;a--;)this.ribbons.push(new n(this,this.model))},render:function(){var a,c,f=Math.min(this.ribbons.length,this.maxRibbons);if(2<f){a=d(this.tracks.textureSlot,0,this.model);var g=(Math.floor(a/this.rows)-1)/this.rows,l=1/f*this.cellWidth,h=g+this.cellHeight,n=this.data;for(a=0,c=f;a<c;a++){var u=
10*a,i=this.ribbons[a],j=(f-a)*l,z=j-l,C=i.p2,i=i.p1;n[u+0]=C[0];n[u+1]=C[1];n[u+2]=C[2];n[u+3]=j;n[u+4]=g;n[u+5]=i[0];n[u+6]=i[1];n[u+7]=i[2];n[u+8]=z;n[u+9]=h}b.bindBuffer(b.ARRAY_BUFFER,this.buffer);b.bufferSubData(b.ARRAY_BUFFER,0,this.data);b.vertexAttribPointer(e.getParameter("a_position"),3,b.FLOAT,!1,20,0);b.vertexAttribPointer(e.getParameter("a_uv"),2,b.FLOAT,!1,20,12);for(a=0,c=this.layers.length;a<c;a++)l=this.layers[a],l.shouldRender()&&(h=[1,1,1,1],g=[0,0],l.setMaterial(),e.bindTexture(r.textures[Math.floor(d(l.tracks.textureId,
l.textureId,this.model))].fileName,0),n=d(this.tracks.color,this.color,this.model),u=d(this.tracks.alpha,this.alpha,this.model),h[0]=n[0],h[1]=n[1],h[2]=n[2],h[3]=u,e.setParameter("u_modifier",h),4294967295!==l.textureAnimationId&&this.model.textureAnimations&&(l=d(this.model.textureAnimations[l.textureAnimationId].tracks.translation,[0,0,0],this.model),g[0]=l[0],g[1]=l[1]),e.setParameter("u_uv_offset",g),e.setParameter("u_type",[0,0,0]),b.drawArrays(b.TRIANGLE_STRIP,0,2*f))}},shouldRender:function(){return 0.1<
d(this.tracks.visibility,1,this.model)}};return{Parser:C,Model:j}}(),za=function(){function a(b){this.sd=b}function d(a){var b,c=a.animIds;this.animIds={};for(a=0,b=c.length;a<b;a++)this.animIds[c[a]]=a}function h(b){var c,d,e=b.animIds;this.name=b.name;this.runsConcurrent=b.runsConcurrent;this.priority=b.priority;this.stsIndex=b.stsIndex;this.animIds={};for(c=0,d=e.length;c<d;c++)this.animIds[e[c]]=c;this.animRefs=b.animRefs;b=b.sd;this.sd=[new a(b[0]),new a(b[1]),new a(b[2]),new a(b[3]),new a(b[4]),
new a(b[5]),1,new a(b[7]),new a(b[8]),1,1,new a(b[11]),new a(b[12])]}function i(a,b,c){this.name=a.name;this.stcIndices=a.stcIndices;this.sts=b;this.stc=c}function j(a){var c,e,g=a.sts,J=a.stc,z=a.stg;this.initialReference=a.initialReference;this.bones=a.bones;this.sequences=a.sequences;this.sts=[];this.stc=[];this.stg=[];for(c=0,e=g.length;c<e;c++)this.sts[c]=new d(g[c]);for(c=0,e=J.length;c<e;c++)this.stc[c]=new h(J[c]);for(c=0,e=z.length;c<e;c++)this.stg[c]=new i(z[c],this.sts,this.stc);this.hwbones=
new Float32Array(16*a.bones.length);this.boneTexture=b.createTexture();this.boneTextureSize=4*Math.max(2,f.powerOfTwo(a.bones.length+1));this.texelFraction=1/this.boneTextureSize;this.boneFraction=4*this.texelFraction;b.activeTexture(b.TEXTURE15);b.bindTexture(b.TEXTURE_2D,this.boneTexture);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,this.boneTextureSize,1,0,b.RGBA,b.FLOAT,null);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);for(c=
0,e=this.bones.length;c<e;c++)this.bones[c].worldMatrix=[];this.addGlobalAnims();this.update(-1)}function o(a){this.bone=a.bone;this.matrix=a.matrix;var b=a.size,c;0===a.shape?c=e.newCube(-b[0],-b[1],-b[2],b[0],b[1],b[2]):1===a.shape&&(c=e.newSphere(0,0,0,9,9,b[0]));this.shape=c}function q(a,c,d,e,f){var g,h,i=a.verticesCount,j=a.firstVertexIndex,m=a.firstBoneLookupIndex,o=a.triangleIndicesCount,k=a.firstTriangleIndex,r=new Float32Array(3*i),s=new Float32Array(4*i),p=new Float32Array(2*i*f),t=new Float32Array(4*
i),v=new Uint16Array(4*i),w=new Uint8Array(4*i),a=new Uint16Array(3*o);for(g=0;g<i;g++){var x=c[j+g];h=x.position;var y=x.normal,W=x.uvs,B=x.tangent,D=x.boneLookupIndices,x=x.boneWeights;r[3*g+0]=h[0];r[3*g+1]=h[1];r[3*g+2]=h[2];s[4*g+0]=y[0];s[4*g+1]=y[1];s[4*g+2]=y[2];s[4*g+3]=y[3];for(h=0;h<f;h++)y=W[h],p[2*g*f+2*h+0]=y[0],p[2*g*f+2*h+1]=y[1];t[4*g+0]=B[0];t[4*g+1]=B[1];t[4*g+2]=B[2];t[4*g+3]=B[3];v[4*g+0]=e[m+D[0]];v[4*g+1]=e[m+D[1]];v[4*g+2]=e[m+D[2]];v[4*g+3]=e[m+D[3]];w[4*g+0]=x[0];w[4*g+1]=
x[1];w[4*g+2]=x[2];w[4*g+3]=x[3]}for(g=0;g<o;g++)a[g]=d[k+g];c=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,c);b.bufferData(b.ARRAY_BUFFER,r,b.STATIC_DRAW);d=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,d);b.bufferData(b.ARRAY_BUFFER,s,b.STATIC_DRAW);s=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,s);b.bufferData(b.ARRAY_BUFFER,p,b.STATIC_DRAW);p=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,p);b.bufferData(b.ARRAY_BUFFER,t,b.STATIC_DRAW);t=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,t);b.bufferData(b.ARRAY_BUFFER,
v,b.STATIC_DRAW);v=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,v);b.bufferData(b.ARRAY_BUFFER,w,b.STATIC_DRAW);w=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,w);b.bufferData(b.ELEMENT_ARRAY_BUFFER,a,b.STATIC_DRAW);this.buffers={position:c,normal:d,uv:s,tangent:p,bone:t,weight:v,face:w};this.uvSetCount=f;this.triangleIndicesCount=o}function m(a,b,c,d){this.imagePath="";if(a){for(var f=Object.keys(a),g=0,h=f.length;g<h;g++){var i=f[g];this[i]=a[i]}this.model=d;this.type=b;a=a.imagePath.toLowerCase();
""!==a&&(this.imagePath=a.toLowerCase(),d=d.texturePaths,d[a]||(d[a]=1,e.newTexture(a,L.mpqFile(a),!0,!0)));this.op=c;c=this.uvSource;d=0;1===c?d=1:9===c?d=2:10===c&&(d=3);this.uvCoordinate=d}}function k(a,b){for(var c=Object.keys(a),d=0,e=c.length;d<e;d++){var f=c[d];this[f]=a[f]}this.layers=[new m(a.diffuseLayer,"diffuse",2,b),new m(a.decalLayer,"decal",2,b),new m(a.specularLayer,"specular",2,b),new m(a.glossLayer,"gloss",2,b),new m(a.emissiveLayer,"emissive",this.emisBlendType,b),new m(a.emissive2Layer,
"emissive2",this.emisMode,b),new m(a.evioLayer,"evio",2,b),new m(a.evioMaskLayer,"evioMask",2,b),new m(a.alphaMaskLayer,"alphaMask",2,b),new m(a.alphaMask2Layer,"alphaMask2",2,b),new m(a.normalLayer,"normal",2,b),new m(a.heightLayer,"heightMap",2,b),new m(a.lightMapLayer,"lightMap",2,b),new m(a.ambientOcclusionLayer,"ao",2,b)]}function r(a,b){this.setup(a);b&&b({lengthComputable:!0,total:100,loaded:100});this.ready=!0}var p=function(){function a(b){b=ea(b,4);return[2*(b[0]/255)-1,2*(b[1]/255)-1,2*
(b[2]/255)-1,2*(b[3]/255)-1]}function b(a){return ea(a,4)}function d(a){return ba(a,2,"Uint16")}function e(a){return{minBorder:s(a),maxBorder:s(a),radius:g(a)}}function f(a,b){var c=new A(a),d=a.index;a.index=b[c.index].offset;c=v(a,c.entries);a.index=d;return c}function h(a,b,c){var d=new A(a),e=b[d.index],d=a.index;a.index=e.offset;b=new c(a,b,e.version);a.index=d;return b}function i(a,b,c){var d=new A(a),e=b[d.index],f=a.index,g=[];e||(console.log("Error in parseReference"),console.log("Func is: "+
c));for(a.index=e.offset;d.entries--;)g.push(new c(a,b,e.version));a.index=f;return g}function j(a,b,c){var d=new A(a),e=b[d.index],f=a.index,g=[];for(a.index=e.offset;d.entries--;)g.push(c(a,b,e.version));a.index=f;return g}function m(a,b,c){var d=new A(a),e=a.index,f=[];for(a.index=b[d.index].offset;d.entries--;)f.push(new q(a,b,c));a.index=e;return f}function o(a,b,c){var d={};d.version=c;d.name=f(a,b);d.unknown0=w(a);d.unknown1=ca(a);d.unknown2=x(a);d.matrix=na(a);d.unknown3=w(a);d.unknown4=w(a);
d.unknown5=w(a);0<c&&(d.unknown6=w(a),d.unknown7=w(a));1<c&&(d.unknown8=w(a));return d}function q(a,b,d){this.keys=j(a,b,w);this.flags=c(a);this.biggestKey=c(a);this.values=j(a,b,d)}function k(a,b){this.interpolationType=x(a);this.animFlags=x(a);this.animId=c(a);this.initValue=b(a);this.nullValue=b(a);this.unknown0=w(a)}function r(a){this.shape=c(a);this.bone=ca(a);this.unknown0=x(a);this.matrix=na(a);this.unknown1=c(a);this.unknown2=c(a);this.unknown3=c(a);this.unknown4=c(a);this.unknown5=c(a);this.unknown6=
c(a);this.size=s(a)}function p(a,d,e){this.version=e;this.unknown0=c(a);this.imagePath=f(a,d);this.color=new k(a,b);this.flags=c(a);this.uvSource=c(a);this.colorChannels=c(a);this.rgbMultiply=new k(a,g);this.rgbAdd=new k(a,g);this.unknown1=c(a);this.unknown2=w(a);this.unknown3=c(a);this.replaceableChannel=c(a);this.unknown4=w(a);this.unknown5=c(a);this.unknown6=c(a);this.unknown7=new k(a,c);this.unknown8=new k(a,ja);this.flipBook=new k(a,ca);this.uvOffset=new k(a,ja);this.uvAngle=new k(a,s);this.uvTiling=
new k(a,ja);this.unknown9=new k(a,c);this.unknown10=new k(a,g);this.brightness=new k(a,g);this.unknown11=w(a);this.fresnelFlags=c(a);this.fresnelStrength=g(a);this.fresnelStart=g(a);this.triPlannarOffset=s(a);this.triPlannarScale=s(a)}function t(a,b){this.name=f(a,b);this.creepLayer=h(a,b,p)}function y(a,b,c){this.version=c}function W(a,b,d){this.version=d;this.name=f(a,b);this.unknown0=c(a);this.unknown1=c(a);this.volumeDensity=new k(a,g);this.colorDefiningLayer=h(a,b,p);this.unknown2=h(a,b,p);this.unknown3=
h(a,b,p);this.unknown4=c(a);this.unknown5=c(a)}function B(a,b,c){this.version=c;this.name=f(a,b);this.terrainLayer=h(a,b,p)}function D(a,b,d){this.version=d;this.materialReferenceIndex=c(a);this.alphaFactor=new k(a,g)}function E(a,b,d){this.version=d;this.name=f(a,b);this.unknown0=c(a);this.sections=i(a,b,D)}function F(a,b,d){this.version=d;this.name=f(a,b);this.unknown0=c(a);this.strengthFactor=new k(a,g);this.normalLayer=h(a,b,p);this.strengthLayer=h(a,b,p);this.flags=c(a);this.priority=w(a)}function G(a,
b,d){this.name=f(a,b);this.specialFlags=c(a);this.flags=c(a);this.blendMode=c(a);this.priority=w(a);this.unknown0=c(a);this.specularity=g(a);this.depthBlend=g(a);this.alphaTestThreshold=aa(a);this.unknown1=aa(a);this.unknown2=aa(a);this.unknown3=aa(a);this.specMult=g(a);this.emisMult=g(a);this.diffuseLayer=h(a,b,p);this.decalLayer=h(a,b,p);this.specularLayer=h(a,b,p);15<d&&(this.glossLayer=h(a,b,p));this.emissiveLayer=h(a,b,p);this.emissive2Layer=h(a,b,p);this.evioLayer=h(a,b,p);this.evioMaskLayer=
h(a,b,p);this.alphaMaskLayer=h(a,b,p);this.alphaMask2Layer=h(a,b,p);this.normalLayer=h(a,b,p);this.heightLayer=h(a,b,p);this.lightMapLayer=h(a,b,p);this.ambientOcclusionLayer=h(a,b,p);this.unknown4=c(a);this.layerBlendType=c(a);this.emisBlendType=c(a);this.emisMode=c(a);this.specType=c(a);this.unknown5=new k(a,c);this.unknown6=new k(a,c)}function H(a){this.materialType=c(a);this.materialIndex=c(a)}function I(a,b,d){this.version=d;this.bone=c(a);this.name=f(a,b);this.fieldOfView=new k(a,g);this.unknown0=
c(a);this.farClip=new k(a,g);this.nearClip=new k(a,g);this.clip2=new k(a,g);this.focalDepth=new k(a,g);this.falloffStart=new k(a,g);this.falloffEnd=new k(a,g);this.depthOfField=new k(a,g)}function K(a,b,d){this.version=d;this.type=aa(a);this.unknown0=aa(a);this.bone=ca(a);this.flags=c(a);this.unknown1=c(a);this.unknown2=w(a);this.lightColor=new k(a,s);this.lightIntensity=new k(a,g);this.specularColor=new k(a,s);this.specularIntensity=new k(a,g);this.attenuationFar=new k(a,g);this.unknown3=g(a);this.attenuationNear=
new k(a,g);this.hotSpot=new k(a,g);this.falloff=new k(a,g)}function L(a){this.unknown0=c(a);this.boundings=new k(a,e)}function M(a){this.unknown0=c(a);this.regionIndex=x(a);this.unknown1=c(a);this.materialReferenceIndex=x(a);this.unknown2=x(a)}function N(a){this.unknown0=c(a);this.unknown1=c(a);this.firstVertexIndex=c(a);this.verticesCount=c(a);this.firstTriangleIndex=c(a);this.triangleIndicesCount=c(a);this.bonesCount=x(a);this.firstBoneLookupIndex=x(a);this.boneLookupIndicesCount=x(a);this.unknown2=
x(a);this.boneWeightPairsCount=aa(a);this.unknown3=aa(a);this.rootBoneIndex=x(a)}function O(a,b,d){this.version=d;this.triangles=j(a,b,x);this.regions=i(a,b,N);this.batches=i(a,b,M);this.MSEC=i(a,b,L);this.unknown0=c(a)}function P(b,c){this.position=s(b);this.boneWeights=ea(b,4);this.boneLookupIndices=ea(b,4);this.normal=a(b);for(var d=c,e=[];d--;){var f=ba(b,2,"Int16");e.push([f[0]/2048,f[1]/2048])}this.uvs=e;this.tangent=a(b)}function Q(a,b,d){this.version=d;this.unknown0=w(a);this.name=f(a,b);
this.flags=c(a);this.parent=ca(a);this.unknown1=x(a);this.location=new k(a,s);this.rotation=new k(a,ka);this.scale=new k(a,s);this.visibility=new k(a,c)}function R(a,b,d){this.version=d;this.animIds=j(a,b,c);this.unknown0=w(a);this.unknown1=w(a);this.unknown2=w(a);this.unknown3=ca(a);this.unknown4=x(a)}function S(a,b,d){this.version=d;this.name=f(a,b);this.stcIndices=j(a,b,c)}function T(a,h,l){this.version=l;this.name=f(a,h);this.runsConcurrent=x(a);this.priority=x(a);this.stsIndex=x(a);this.stsIndexCopy=
x(a);this.animIds=j(a,h,c);this.animRefs=j(a,h,d);this.unknown0=c(a);this.sd=[m(a,h,o),m(a,h,ja),m(a,h,s),m(a,h,ka),m(a,h,b),m(a,h,g),new A(a),m(a,h,ca),m(a,h,x),new A(a),new A(a),m(a,h,c),m(a,h,e)]}function U(a,b,d){this.version=d;this.unknown0=w(a);this.unknown1=w(a);this.name=f(a,b);this.animationStart=c(a);this.animationEnd=c(a);this.movementSpeed=g(a);this.flags=c(a);this.frequency=c(a);this.unknown2=c(a);this.unknown3=c(a);this.unknown4=c(a);2>d&&(this.unknown5=c(a));this.boundingSphere=e(a);
this.unknown6=c(a);this.unknown7=c(a);this.unknown8=c(a)}function V(a,b,d){this.version=d;this.name=f(a,b);this.flags=c(a);this.sequences=i(a,b,U);this.stc=i(a,b,T);this.stg=i(a,b,S);this.unknown0=g(a);this.unknown1=g(a);this.unknown2=g(a);this.unknown3=g(a);this.sts=i(a,b,R);this.bones=i(a,b,Q);this.skinBones=c(a);var h=c(a),l=1;h&1048576?l=4:h&524288?l=3:h&262144&&(l=2);this.vertexFlags=h;var h=this.uvSetCount=l,u=new A(a),l=a.index,n=[];a.index=b[u.index].offset;for(u=u.entries/(28+4*h);u--;)n.push(new P(a,
h));a.index=l;this.vertices=n;this.divisions=i(a,b,O);this.boneLookup=j(a,b,x);this.boundings=e(a);this.unknown4To19=Z(a,16);this.attachmentPoints=new A(a);this.attachmentPointAddons=new A(a);this.ligts=i(a,b,K);this.shbx=new A(a);this.cameras=i(a,b,I);this.unknown20=new A(a);this.materialMaps=i(a,b,H);this.materials=[i(a,b,G),i(a,b,F),i(a,b,E),i(a,b,B),i(a,b,W),i(a,b,y),i(a,b,t)];24<d&&(this.unknown21=new A(a));25<d&&(this.unknown22=new A(a));this.particleEmitters=new A(a);this.particleEmitterCopies=
new A(a);this.ribbonEmitters=new A(a);this.projections=new A(a);this.forces=new A(a);this.warps=new A(a);this.unknown23=new A(a);this.rigidBodies=new A(a);this.unknown24=new A(a);this.physicsJoints=new A(a);this.unknown25=new A(a);this.ikjt=new A(a);this.unknown26=new A(a);24<d&&(this.unknown27=new A(a));this.patu=new A(a);this.trgd=new A(a);this.initialReference=j(a,b,na);this.tightHitTest=new r(a);this.fuzzyHitTestObjects=i(a,b,r);this.attachmentVolumes=new A(a);this.attachmentVolumesAddon0=new A(a);
this.attachmentVolumesAddon1=new A(a);this.bbsc=new A(a);this.tmd=new A(a);this.unknown28=c(a);this.unknown29=new A(a)}function A(a){this.entries=c(a);this.index=c(a);this.flags=c(a)}function X(a){this.tag=v(a,4);this.offset=c(a);this.entries=c(a);this.version=c(a)}function Y(a){this.indexOffset=c(a);this.entries=c(a);this.modelHeader=new A(a)}return function(a){if("43DM"===v(a,4)){var b=new Y(a);a.index=b.indexOffset;for(var c=[],d=0;d<b.entries;d++)c[d]=new X(a);b=c[b.modelHeader.index];a.index=
b.offset;return new V(a,c,b.version)}return null}}();a.prototype={getValue:function(a,b,c,d){a=this.sd[a];1===d&&(c&=a.biggestKey);var d=a.keys,a=a.values,e=this.getInterval(d,c),g=e[0],e=e[1],h=d.length;if(g===h)return e===h?b.initValue:a[e];if(e===h||g>=e)return a[g];c=f.clamp((c-d[g])/(d[e]-d[g]),0,1);return("number"===typeof a[g]?f.interpolator.scalar:3===a[g].length?f.interpolator.vector:f.interpolator.quaternion)(a[g],0,0,a[e],c,b.interpolationType)},getInterval:function(a,b){for(var c=a.length,
d=0;d!==a.length&&b>a[d];)c=d,d++;return[c,d]}};d.prototype={hasData:function(a){return!!this.animIds[a.animId]}};h.prototype={getValue:function(a,b){var c=this.animRefs[this.animIds[a.animId]];return c?this.sd[c[1]].getValue(c[0],a,b,this.runsConcurrent):a.initValue}};i.prototype={getValue:function(a,b){var c,d,e=this.stcIndices;for(c=0,d=e.length;c<d;c++){var f=this.stc[e[c]];if(this.sts[f.stsIndex].hasData(a))return f.getValue(a,b)}return a.initValue}};j.prototype={addGlobalAnims:function(){var a,
b,c,d,e,f=this.stg;for(a=0,b=f.length;a<b;a++){var g=f[a],h=g.name.toLowerCase();"glbirth"===h?c=g:"glstand"===h?d=g:"gldeath"===h&&(e=g)}for(a=0,b=f.length;a<b;a++)g=f[a],h=g.name.toLowerCase(),"glbirth"!==h&&"glstand"!==h&&"gldeath"!==h&&(-1!==h.indexOf("birth")&&c?g.stcIndices=g.stcIndices.concat(c.stcIndices):-1!==h.indexOf("death")&&e?g.stcIndices=g.stcIndices.concat(e.stcIndices):d&&(g.stcIndices=g.stcIndices.concat(d.stcIndices)))},update:function(a,b){for(var c=0,d=this.bones.length;c<d;c++)this.updateBone(this.bones[c],
a,b);this.updateHW(a)},updateHW:function(a){for(var c=this.bones,d=this.hwbones,e=this.initialReference,g=0,h=c.length;g<h;g++){var i=16*g,j=[];-1!==a?f.mat4.multMat(c[g].worldMatrix,e[g],j):j=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];d[i+0]=j[0];d[i+1]=j[1];d[i+2]=j[2];d[i+3]=j[3];d[i+4]=j[4];d[i+5]=j[5];d[i+6]=j[6];d[i+7]=j[7];d[i+8]=j[8];d[i+9]=j[9];d[i+10]=j[10];d[i+11]=j[11];d[i+12]=j[12];d[i+13]=j[13];d[i+14]=j[14];d[i+15]=j[15]}b.activeTexture(b.TEXTURE15);b.bindTexture(b.TEXTURE_2D,this.boneTexture);
b.texSubImage2D(b.TEXTURE_2D,0,0,0,4*c.length,1,b.RGBA,b.FLOAT,d)},getValue:function(a,b,c){return-1!==b?this.stg[b].getValue(a,c):a.initValue},updateBone:function(a,b,c){var d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e=this.getValue(a.location,b,c),g=this.getValue(a.scale,b,c),b=this.getValue(a.rotation,b,c);(0!==e[0]||0!==e[1]||0!==e[2])&&f.mat4.translate(d,e[0],e[1],e[2]);(1!==g[0]||1!==g[1]||1!==g[2])&&f.mat4.scale(d,g[0],g[1],g[2]);(0!==b[0]||0!==b[1]||0!==b[2]||1!==b[3])&&f.mat4.rotateQ(d,b);-1!==
a.parent?f.mat4.multMat(this.bones[a.parent].worldMatrix,d,a.worldMatrix):a.worldMatrix=d},bind:function(){e.setParameter("u_bones",15);e.setParameter("u_bone_size",this.boneFraction);e.setParameter("u_pixel_size",this.texelFraction);b.activeTexture(b.TEXTURE15);b.bindTexture(b.TEXTURE_2D,this.boneTexture)}};o.prototype={render:function(){this.shape&&this.shape.renderLines()}};q.prototype={render:function(){var a=this.buffers,c=this.uvSetCount;b.bindBuffer(b.ARRAY_BUFFER,a.position);e.vertexAttribPointer("a_position",
3,b.FLOAT,!1,0,0);b.bindBuffer(b.ARRAY_BUFFER,a.normal);e.vertexAttribPointer("a_normal",4,b.FLOAT,!1,0,0);b.bindBuffer(b.ARRAY_BUFFER,a.uv);for(var d=0;d<c;d++)e.vertexAttribPointer("a_uv"+d,2,b.FLOAT,!1,8*c,8*d);b.bindBuffer(b.ARRAY_BUFFER,a.tangent);e.vertexAttribPointer("a_tangent",4,b.FLOAT,!1,0,0);b.bindBuffer(b.ARRAY_BUFFER,a.bone);e.vertexAttribPointer("a_bones",4,b.UNSIGNED_SHORT,!1,0,0);b.bindBuffer(b.ARRAY_BUFFER,a.weight);e.vertexAttribPointer("a_weights",4,b.UNSIGNED_BYTE,!0,0,0);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,
a.face);b.drawElements(b.TRIANGLES,this.triangleIndicesCount,b.UNSIGNED_SHORT,0)}};m.prototype={bind:function(a){var b=this.imagePath;if(""!==b&&e.textureReady(b)){var c=this.type,d="u_"+c,f=d+"LayerSettings.";e.setParameter(d+"Map",a);e.bindTexture(b,a);e.setParameter(f+"enabled",1);e.setParameter(f+"op",this.op);e.setParameter(f+"channels",this.colorChannels);"diffuse"==c?e.setParameter(f+"teamColorMode",1):e.setParameter(f+"teamColorMode",0);e.setParameter(f+"multAddAlpha",[this.model.getValue(this.rgbMultiply),
this.model.getValue(this.rgbAdd),0]);e.setParameter(f+"useAlphaFactor",0);e.setParameter(f+"invert",this.flags&16);e.setParameter(f+"multColor",0);e.setParameter(f+"addColor",0);e.setParameter(f+"clampResult",this.flags&32);e.setParameter(f+"useConstantColor",this.flags&&1024);e.setParameter(f+"constantColor",this.model.getValue(this.color));e.setParameter(f+"uvSource",this.uvSource);e.setParameter(f+"uvCoordinate",this.uvCoordinate)}else e.setParameter(f+"enabled",0)},unbind:function(){e.setParameter("u_"+
this.type+"LayerSettings.enabled",0)}};k.prototype={bindCommon:function(){1===this.blendMode?(b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE)):2===this.blendMode?(b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE)):b.disable(b.BLEND);this.flags&8?b.disable(b.CULL_FACE):b.enable(b.CULL_FACE)},bind:function(){this.bindCommon();e.setParameter("u_specularity",this.specularity);e.setParameter("u_specMult",this.specMult);e.setParameter("u_emisMult",this.emisMult);e.setParameter("u_lightAmbient",[0.02,0.02,0.02,0]);
for(var a=0;14>a;a++)this.layers[a].bind(a+1)},unbind:function(){b.disable(b.BLEND);b.enable(b.CULL_FACE);for(var a=0;14>a;a++)this.layers[a].unbind()},bindDiffuse:function(){this.bindCommon();this.layers[0].bind(1)},bindSpecular:function(){this.bindCommon();e.setParameter("u_specularity",this.specularity);e.setParameter("u_specMult",this.specMult);this.layers[2].bind(3)},bindNormalMap:function(){this.bindCommon();this.layers[10].bind(11)},bindEmissive:function(){this.bindCommon();e.setParameter("u_emisMult",
this.emisMult);this.layers[4].bind(5);this.layers[5].bind(6)},bindDecal:function(){this.bindCommon();this.layers[1].bind(2)}};r.prototype={addMaterial:function(a,b,c){a=this.materials[a];a[b]=a[b]||new k(c,this);return a[b]},setup:function(a){function b(a,c){a=a.material.priority;c=c.material.priority;return a<c?1:a==c?0:-1}var c,d,e=a.divisions[0],f=a.uvSetCount,g=e.regions;this.uvSetCount=f;this.regions=[];for(c=0,d=g.length;c<d;c++)this.regions.push(new q(g[c],a.vertices,e.triangles,a.boneLookup,
f));this.batches=[];this.materials=[[]];this.texturePaths={};var g=a.materialMaps,h=a.materials,f=[];for(c=0,d=e.batches.length;c<d;c++){var i=e.batches[c],k=i.regionIndex,i=g[i.materialReferenceIndex];1===i.materialType&&(k=this.regions[k],i=this.addMaterial(0,i.materialIndex,h[0][i.materialIndex]),f.push({region:k,material:i}))}e=[[],[],[],[],[],[]];for(c=0,d=f.length;c<d;c++)e[f[c].material.blendMode].push(f[c]);for(c=0;6>c;c++)e[c].sort(b);this.batches=e[0].concat(e[1]).concat(e[2]).concat(e[3]).concat(e[4]).concat(e[5]);
this.skeleton=new j(a);if(0<a.fuzzyHitTestObjects.length){this.fuzzyHitTestObjects=[];for(c=0,d=a.fuzzyHitTestObjects.length;c<d;c++)this.fuzzyHitTestObjects[c]=new o(a.fuzzyHitTestObjects[c])}this.teamId=this.loopingMode=this.frame=0;this.sequences=a.sequences;this.sequenceId=-1;this.extent=a.tightHitTest.size[0]||2},update:function(){var a=this.sequenceId;if(-1!==a){var b=this.sequences[a];this.frame+=1E3*F*G;if(this.frame>b.animationEnd&&(0===this.loopingMode&&!(b.flags&1)||2===this.loopingMode))this.frame=
0;this.skeleton.update(a,this.frame)}},getValue:function(a){return this.skeleton.getValue(a,this.sequenceId,this.frame)},render:function(){var a=xa[this.teamId];e.bindShader(D);e.bindMVP("u_mvp");e.bindView("u_mv");e.setParameter("u_teamColor",[a[0]/255,a[1]/255,a[2]/255]);e.setParameter("u_eyePos",$);e.setParameter("u_lightPos",ha);this.skeleton.bind();for(var a=0,c=this.batches.length;a<c;a++){var d=this.batches[a],f=d.region,d=d.material;"standard"===D?d.bind():"diffuse"===D?d.bindDiffuse():"normalmap"===
D||"unshaded_normalmap"===D?d.bindNormalMap():"specular"===D?d.bindSpecular():"specular_normalmap"===D?(d.bindSpecular(),d.bindNormalMap()):"emissive"===D?d.bindEmissive():"decal"===D&&d.bindDecal();f.render();d.unbind()}if(y&&this.fuzzyHitTestObjects&&S){b.depthMask(1);e.bindShader("white");for(a=0,c=this.fuzzyHitTestObjects.length;a<c;a++)f=this.fuzzyHitTestObjects[a],e.pushMatrix(),e.multMat(this.skeleton.bones[f.bone].worldMatrix),e.multMat(f.matrix),e.bindMVP("u_mvp"),e.popMatrix(),f.render()}},
setTeamColor:function(a){this.teamId=f.clamp(a,0,16)},setAnimation:function(a){a=f.clamp(a,-1,this.sequences.length-1);this.frame=0;this.sequenceId=a;-1===a&&this.skeleton.update(-1)},setAnimationLooping:function(a){this.loopingMode=f.clamp(a,0,2)}};return{Parser:p,Model:r}}();pa&&""!==pa?(o({status:"Downloading the model file"}),fa(pa,!0,a,T,o)):qa&&""!==qa?(o({status:"Downloading the model file"}),fa(L.mpqFile(qa),!0,a,T,o)):oa&&""!==oa?(o({status:"Downloading the model data file"}),fa(L.header(oa),
!1,d,T,o)):console.log("No input file");e.viewSize(H.width,H.height);e.setPerspective(45,H.width/H.height,0.1,5E4);R=e.newShader("world",N.vsworld,t+N.psworld);S=e.newShader("white",N.vswhite,t+N.pswhite);e.newTexture("grass","http://www.hiveworkshop.com/model_viewer/images/grass.png");e.newTexture("water","http://www.hiveworkshop.com/model_viewer/images/water.png");e.newTexture("bedrock","http://www.hiveworkshop.com/model_viewer/images/bedrock.png");e.newTexture("sky",L.mpqFile("Environment/Sky/LordaeronSummerSky/LordaeronSummerSky.blp"));
ta=e.newRectangle(0,0,-1,300,300,6);p=e.newRectangle(0,0,-33,300,300,6);da=e.newSphere(0,0,0,5,10,2E4);var Aa=!0;j();Ca(function(){var a=wa();Aa=!(a&&document[a])});return{getCameras:function(){return r&&r.cameras?r.cameras:[]},getCamera:function(){return K},setCamera:function(a){r&&(K=a,r.cameras&&-1<a&&a<r.cameras.length&&(sa=r.cameras[a]))},resetCamera:k,getAnimations:function(){return r&&r.sequences?r.sequences:[]},playAnimation:function(a){r&&r.setAnimation(a)},stopAnimation:function(){r&&r.setAnimation(0)},
setAnimationSpeed:function(a){G=a},setLoopingMode:function(a){r&&r.setAnimationLooping(a)},setTeamColor:function(a){return r?(r.setTeamColor(a),xa[a]):[0,0,0]},setWorld:function(a){P=a},showLights:function(){},showShapes:function(a){y=a},resize:function(a,b){e.viewSize(a,b);e.setPerspective(45,a/b,0.1,5E4)},move:function(a,b){-1===K&&(2===E&&(a*=0.01,b*=0.01),i[0]+=a,i[1]-=b)},zoom:function(a){-1===K&&(i[2]=f.clamp(i[2]*a,Q[0],Q[1]))},rotate:function(a,b){-1===K&&(B[1]+=a,B[0]+=b)}}}})();
}());